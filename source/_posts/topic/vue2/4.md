---
title: ğŸ”¥Vue2åˆå§‹åŒ–æ—¶éƒ½å¹²äº†ä»€ä¹ˆäº‹
permalink: posts/vue2-init.html
date: 2024-11-12 13:55
topic: vue2
banner: /assets/topic/vue2/banner/init.png
--- 

{% quot ä¸“æ ç¬¬å››ç¯‡-åˆå§‹åŒ–å¹²äº†ä»€ä¹ˆäº‹ %}

&emsp;&emsp;ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬çŸ¥é“ Vueå°±æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œåœ¨ä½¿ç”¨ Vueçš„æ—¶å€™éœ€è¦å®ä¾‹åŒ– Vueï¼Œè¿™ä¸€ç« æˆ‘ä»¬å°±æ¥çœ‹çœ‹åœ¨å®ä¾‹åŒ–çš„æ—¶å€™å†…éƒ¨åšäº†ä¸€äº›ä»€ä¹ˆæ“ä½œã€‚

# é›¶ã€è°ƒç”¨äº†_initæ–¹æ³•

{% box child:codeblock color:purple %}
```js
function Vue(){
    if(!this instanceof Vue){
        return warn("å¿…é¡»ä½¿ç”¨ new å…³é”®å­—æ¥å®ä¾‹åŒ–")
    }
    this._init();
}
```
{% endbox %}

é™¤äº†åœ¨æ„é€ å‡½æ•°å†…éƒ¨å¯¹æ˜¯å¦ä½¿ç”¨ new å…³é”®å­—è¿›è¡Œåˆ¤æ–­ã€‚

è¿˜åœ¨æ ¡éªŒè¿‡åè°ƒç”¨äº†_initæ–¹æ³•ã€‚

ä» init è¿™ä¸ªåå­—ä¸éš¾çœ‹å‡ºï¼Œè‚¯å®šåœ¨å†…éƒ¨åšäº†ä¸€äº›åˆå§‹åŒ–çš„æ“ä½œã€‚

è¯¥æ–¹æ³•æ˜¯åœ¨Vueè¢«å¼•å…¥æ—¶è°ƒç”¨ {% mark initMixin color:orange %} æ–¹æ³•åœ¨Vueä¸Šæ³¨å…¥çš„ã€‚

{% box child:codeblock color:purple %}
```js
let uid = 0;
export function initMixin(Vue){
    Vue.prototype._init = function (options?: Record<string, any>) {
        const vm: Component = this
        // a uid
        vm._uid = uid++

        let startTag, endTag
        /* istanbul ignore if */
        if (__DEV__ && config.performance && mark) {
            startTag = `vue-perf-start:${vm._uid}`
            endTag = `vue-perf-end:${vm._uid}`
            mark(startTag)
        }

        // a flag to mark this as a Vue instance without having to do instanceof
        // check
        vm._isVue = true
        // avoid instances from being observed
        vm.__v_skip = true
        // effect scope
        vm._scope = new EffectScope(true /* detached */)
        // #13134 edge case where a child component is manually created during the
        // render of a parent component
        vm._scope.parent = undefined
        vm._scope._vm = true
        // merge options
        if (options && options._isComponent) {
            // optimize internal component instantiation
            // since dynamic options merging is pretty slow, and none of the
            // internal component options needs special treatment.
            initInternalComponent(vm, options as any)
        } else {
            vm.$options = mergeOptions(
                resolveConstructorOptions(vm.constructor as any),
                options || {},
                vm
            )
        }
        /* istanbul ignore else */
        if (__DEV__) {
            initProxy(vm)
        } else {
            vm._renderProxy = vm
        }
        // expose real self
        vm._self = vm
        initLifecycle(vm)
        initEvents(vm)
        initRender(vm)
        callHook(vm, 'beforeCreate', undefined, false /* setContext */)
        initInjections(vm) // resolve injections before data/props
        initState(vm)
        initProvide(vm) // resolve provide after data/props
        callHook(vm, 'created')

        /* istanbul ignore if */
        if (__DEV__ && config.performance && mark) {
            vm._name = formatComponentName(vm, false)
            mark(endTag)
            measure(`vue ${vm._name} init`, startTag, endTag)
        }

        if (vm.$options.el) {
            vm.$mount(vm.$options.el)
        }
    }
}
```
{% endbox %}

æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šè¯¦ç»†è§£é‡Šä¸‹æ¯ä¸€æ­¥ä¸­å…·ä½“éƒ½åšäº†ä»€ä¹ˆã€‚

# ä¸€ã€vm._uid

{% box child:codeblock color:purple %}
```js
let uid = 0;

Vue.prototype.init=function(){
  vm._uid = uid++
}
```
{% endbox %}

åœ¨_initæ–¹æ³•çš„ç¬¬ä¸€è¡Œå¯ä»¥çœ‹åˆ°åœ¨å®ä¾‹ä¸ŠæŒ‚è½½äº†ä¸€ä¸ªvm._uidå±æ€§ã€‚

æ¯ä¸ªVueå®ä¾‹éƒ½ä¼šæœ‰ä¸€ä¸ªå”¯ä¸€çš„{% mark _uidï¼ˆUnique Identifierï¼Œå”¯ä¸€æ ‡è¯†ç¬¦ %}ã€‚

è¿™ä¸ªæ ‡è¯†ç¬¦æ˜¯åœ¨ Vue å®ä¾‹åˆ›å»ºæ—¶ç”±ä¸€ä¸ªé€’å¢çš„è®¡æ•°å™¨ç”Ÿæˆçš„ï¼Œå…¶ä¸»è¦ç”¨é€”æ˜¯åœ¨å†…éƒ¨å¤„ç†ä¸­æä¾›å”¯ä¸€æ€§ã€‚

å°¤å…¶æ˜¯åœ¨æ¶‰åŠåˆ°å®ä¾‹é—´çš„æ¯”è¾ƒæˆ–è€…è·Ÿè¸ªçš„æ—¶å€™ã€‚

# äºŒã€è¿½è¸ªåˆå§‹åŒ–æ¶ˆè€—æ—¶é—´

{% box child:codeblock color:purple %}
```js
// _init å‡½æ•°åˆšæ‰§è¡Œæ—¶
let startTag, endTag
if (__DEV__ && config.performance && mark) {
  startTag = `vue-perf-start:${vm._uid}`
  endTag = `vue-perf-end:${vm._uid}`
  mark(startTag)
}
// _init å‡½æ•°åˆå§‹åŒ–é€»è¾‘å®Œæˆ
if (__DEV__ && config.performance && mark) {
  mark(endTag)
  measure(`vue ${vm._uid} init`, startTag, endTag)
}
```
{% endbox %}

## 2.1 è¦†ç›–é»˜è®¤é…ç½®

æˆ‘ä»¬çŸ¥é“åœ¨ Vue å¯ä»¥è¦†ç›–é»˜è®¤é…ç½®ã€‚

{% box child:codeblock color:purple %}
```js
// å¼€å¯ vueæ€§èƒ½é…ç½®
Vue.config.performance = true;
```
{% endbox %}

é‚£ä¹ˆ vue æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ

{% mark core/config.jsæ–‡ä»¶æ˜¯vueçš„é»˜è®¤é…ç½®æ–‡ä»¶ã€‚ color:orange %}

{% box child:codeblock color:purple %}
```js
// core/config.js
export default {
  // é»˜è®¤ä¸å¼€å¯perf
  performance: false
}
```
{% endbox %}

Vueè¢«å¼•å…¥æ—¶ï¼Œåœ¨ {% mark initGlobalAPI color:orange %}æ–¹æ³•ä¸­ç»™ Vueè®¾ç½®äº† configå±æ€§ã€‚

{% box child:codeblock color:purple %}
```js
import config from '../config'
export function initGlobalAPI(Vue){
    // çœç•¥éƒ¨åˆ†ä»£ç 
    const configDef = {};
    configDef.get = () => config;

    if (__DEV__) {
        configDef.set = () => {
          warn(
            'ä¸è¦æ›¿æ¢Vue.é…ç½®å¯¹è±¡ï¼Œè€Œæ˜¯è®¾ç½®å•ç‹¬çš„å­—æ®µ'
          )
        }
    }

    Object.defineProperty(Vue,'config',configDef);
}
```
{% endbox %}

è€Œå¼•å…¥çš„configå°±æ˜¯Vueçš„é»˜è®¤é…ç½®æ–‡ä»¶ï¼Œå…¶å¯¼å‡ºå†…å®¹å¦‚ä¸‹ï¼š
 
{% box child:codeblock color:purple %}
```js
export default {
  /**
   * Option merge strategies (used in core/util/options)
   */
  // $flow-disable-line
  optionMergeStrategies: Object.create(null),

  /**
   * Whether to suppress warnings.
   */
  silent: false,

  /**
   * Show production mode tip message on boot?
   */
  productionTip: __DEV__,

  /**
   * Whether to enable devtools
   */
  devtools: __DEV__,

  /**
   * Whether to record perf
   */
  performance: false,

  /**
   * Error handler for watcher errors
   */
  errorHandler: null,

  /**
   * Warn handler for watcher warns
   */
  warnHandler: null,

  /**
   * Ignore certain custom elements
   */
  ignoredElements: [],

  /**
   * Custom user key aliases for v-on
   */
  // $flow-disable-line
  keyCodes: Object.create(null),

  /**
   * Check if a tag is reserved so that it cannot be registered as a
   * component. This is platform-dependent and may be overwritten.
   */
  isReservedTag: no,

  /**
   * Check if an attribute is reserved so that it cannot be used as a component
   * prop. This is platform-dependent and may be overwritten.
   */
  isReservedAttr: no,

  /**
   * Check if a tag is an unknown element.
   * Platform-dependent.
   */
  isUnknownElement: no,

  /**
   * Get the namespace of an element
   */
  getTagNamespace: noop,

  /**
   * Parse the real tag name for the specific platform.
   */
  parsePlatformTagName: identity,

  /**
   * Check if an attribute must be bound using property, e.g. value
   * Platform-dependent.
   */
  mustUseProp: no,

  /**
   * Perform updates asynchronously. Intended to be used by Vue Test Utils
   * This will significantly reduce performance if set to false.
   */
  async: true,

  /**
   * Exposed for legacy reasons
   */
  _lifecycleHooks: LIFECYCLE_HOOKS
} as unknown as Config
```
{% endbox %}

æ ¹æ®ä¸Šé¢çš„é…ç½®å¯ä»¥çŸ¥é“ Vue.configè·å–çš„å°±æ˜¯configæ–‡ä»¶ä¸­ä¸­é…ç½®çš„å†…å®¹ã€‚

{% box child:codeblock color:cyan %}
> exportæˆ–export defaultä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¯¹è±¡æœ¬èº«åœ¨å¤–éƒ¨è„šæœ¬ä¸­æ˜¯ä¸èƒ½ä¿®æ”¹çš„ã€‚ä½†æ˜¯å¯¹è±¡çš„å±æ€§åœ¨å¤–éƒ¨è„šæœ¬ä¸­éƒ½æ˜¯å¯ä»¥ä¿®æ”¹çš„ã€‚
{% endbox %}

æ‰€ä»¥ä½ å¯ä»¥é€šè¿‡{% mark Vue.config.xxx = 'xxx' color:orange %} æ¥è®¾ç½®é…ç½®æˆ–è€…è¦†ç›–é»˜è®¤çš„é…ç½®ã€‚

## 2.2 markå‡½æ•° & measureå‡½æ•°

markå‡½æ•° å’Œ measureå‡½æ•°æ˜¯vueä¸­è¿›è¡Œæ€§èƒ½æ£€æµ‹çš„å‡½æ•°ã€‚

å‡½æ•°ä½äº{% mark core/util/perf color:orange %}æ–‡ä»¶ä¸­ã€‚

{% box child:codeblock color:purple %}
```js
// åˆ¤æ–­æ˜¯å¦åœ¨æµè§ˆå™¨ä¸­
import { inBrowser } from './env'

export let mark
export let measure

// åªæœ‰åœ¨å¼€å‘ç¯å¢ƒä¸­æ‰ä¼šè®¾ç½® mark å’Œ measure
if (__DEV__) {
  const perf = inBrowser && window.performance 
  if (
    perf && 
    perf.mark && 
    perf.measure && 
    perf.clearMarks && 
    perf.clearMeasures
  ) {
    mark = tag => perf.mark(tag)
    measure = (name, startTag, endTag) => {
      perf.measure(name, startTag, endTag)
      perf.clearMarks(startTag)
      perf.clearMarks(endTag) 
    }
  }
}
```
{% endbox %}

å®é™…ä¸Šå°±æ˜¯è°ƒç”¨äº†{% mark window.performance color:orange %}ç›¸å…³çš„ apiï¼š

1. `performance.mark`ï¼šä¸»è¦ç”¨äºåˆ›å»ºæ ‡è®°
2. `performance.measure`ï¼š  ä¸»è¦ç”¨äºè®°å½•ä¸¤ä¸ªæ ‡è®°çš„æ—¶é—´é—´éš”
3. `performance.clearMarks`ï¼š  ç”¨äºæ¸…é™¤æ ‡è®°

{% box child:codeblock color:purple %}
```js
window.performance.mark("_start")
for(let i=0;i<10000;i++){
  console.log();
}
window.performance.mark("_end")
window.performance.measure("timestamp","_start","_end")

// å¯ä»¥è·å–ç›´æ¥é—´éš”
window.performance.getEntriesByName("timestamp")[0]
```
{% endbox %}

{% box child:codeblock color:cyan %}
> å¯ä»¥ä½¿ç”¨getEntriesByNameè·å–ä¸¤ä¸ªæ ‡è®°æœŸé—´ä»£ç æ‰§è¡Œçš„æ—¶é—´ã€‚
{% endbox %}

ä»è€Œè¿™é‡Œé€šè¿‡è¿™ä¸ªæ–¹æ³•å¯ä»¥è·å–åˆ°åˆå§‹åŒ–_initå‡½æ•°æ‰§è¡Œçš„æ—¶æœºã€‚

## 2.3 æ€»ç»“

åœ¨ _init å‡½æ•°å¼€å§‹æ—¶æ‰“ä¸€ä¸ªåä¸º{% mark â€œvue-perf-startâ€ color:orange %}çš„æ ‡è®°ã€‚

ç„¶ååœ¨é€»è¾‘å¤„ç†ç»“æŸåæ‰“ä¸€ä¸ªåä¸º{% mark â€œvue-perf-endâ€ color:orange %}çš„æ ‡è®°ã€‚

æœ€åé€šè¿‡measureå‡½æ•°è®¾ç½®ä¸€ä¸ª measure å¯¹è±¡ï¼Œé‡Œé¢åŒ…å«ä¸¤ä¸ªæ ‡è®°ä¹‹é—´çš„é—´éš”æ—¶é—´ã€‚

è¿™ä¸ªé—´éš”æ—¶é—´å°±å¯ä»¥çœ‹æˆè¿™ä¸ªå®ä¾‹åˆå§‹åŒ–èŠ±è´¹çš„æ—¶é—´ï¼Œä»¥æ­¤æ¥è¯„æµ‹æ€§èƒ½ã€‚

# ä¸‰. vm._isVue

{% box child:codeblock color:purple %}
```js
Vue.prototype.init=function(){
  vm._isVue = true
}
```
{% endbox %}

æ¯ä¸ª vueå®ä¾‹ åœ¨åˆå§‹æ—¶éƒ½ä¼šè®¾ç½®_isVueå˜é‡ã€‚

è¿™ä¸ªå˜é‡å¯ä»¥åœ¨å†…éƒ¨/æ‰©å±•æ’ä»¶ä¸­åˆ¤æ–­å½“å‰å¯¹è±¡æ˜¯å¦æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ vueå®ä¾‹ã€‚

# å››ã€vm.__v_skip

{% box child:codeblock color:purple %}
```js
Vue.prototype.init=function(){
  vm.__v_skip = true
}
```
{% endbox %}

åœ¨åˆå§‹åŒ–æ—¶å°†è¯¥å˜é‡è®¾ç½®ä¸º trueã€‚

è¿™ä¸ªå˜é‡ç”¨äºæŒ‡ç¤ºVueçš„ç›¸åº”æ˜¯ç³»ç»Ÿè·³è¿‡å¯¹è¯¥å¯¹è±¡çš„è§‚æµ‹ã€‚

å½“ä¸€ä¸ªå¯¹è±¡è¢«æ ‡è®°ä¸º __v_skip = true æ—¶ï¼ŒVue ä¸ä¼šå¯¹è¿™ä¸ªå¯¹è±¡è¿›è¡Œæ·±åº¦è§‚æµ‹ï¼Œè¿™æ„å‘³ç€å¯¹è±¡å†…éƒ¨çš„å±æ€§å˜åŒ–å°†ä¸ä¼šè§¦å‘è§†å›¾æ›´æ–°ã€‚

# äº”ã€åˆå¹¶é€‰é¡¹

{% box child:codeblock color:purple %}
```js
if (options && options._isComponent) {
    // optimize internal component instantiation
    // since dynamic options merging is pretty slow, and none of the
    // internal component options needs special treatment.
    initInternalComponent(vm, options as any)
} else {
    vm.$options = mergeOptions(
        resolveConstructorOptions(vm.constructor as any),
        options || {},
        vm
    )
}
```
{% endbox %}

ç¬¬äº”æ­¥æ˜¯æ‰§è¡Œåˆå¹¶ optionsçš„æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸ª optionsæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¯ä»¥è¯´ Vueä¸­çš„å¤§éƒ¨åˆ†å†…å®¹éƒ½æ˜¯åŸºäº optionsæ¥å®Œæˆçš„ï¼Œè¿™ä¸ª optionsä¸­å­˜å‚¨äº†ç”¨æˆ·ä¼ å…¥çš„é€‰é¡¹ä»¥åŠä¸€äº›å†…ç½®çš„ Vueé€‰é¡¹ã€‚

{% box child:codeblock color:cyan %}
> ç”±äºoptionsåœ¨ Vueä¸­æ¯”è¾ƒé‡è¦ï¼Œå…³äºè¿™ä¸€å—æˆ‘ä»¬åé¢ä¼šä¸“é—¨å¼€ä¸€ç¯‡æ–‡ç« æ¥è¯¦ç»†è§£é‡Šã€‚
{% endbox %}

# å…­ã€è®¾ç½®æ•°æ®ä»£ç†æ£€æµ‹

{% box child:codeblock color:purple %}
```js
if (__DEV__) {
    initProxy(vm)
}else {
    vm._renderProxy = vm
}
```
{% endbox %}

è¿™é‡Œçš„ç›®çš„æ˜¯åœ¨å¼€å‘ç¯å¢ƒä¸‹ç»™vmè®¾ç½®ä»£ç†ï¼Œä»è€Œè¾¾åˆ°å¼€å‘æ—¶æç¤ºçš„åŠŸèƒ½ï¼Œè¿™ä¸ªæˆ‘ä»¬åç»­ä¹Ÿä¼šå•å¼€ä¸€ç¯‡æ–‡ç« è¿›è¡Œè¯´æ˜ã€‚

# ä¸ƒã€vm._self = vm


{% box child:codeblock color:purple %}
```js
Vue.prototype.init=function(){
  vm._self = vm
}
```
{% endbox %}

å°†_selfå±æ€§æŒ‡å‘è‡ªèº«è¿™ä¸ªå®ä¾‹ã€‚

å¯ä»¥ç¡®ä¿åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½æ­£ç¡®å¼•ç”¨å½“å‰å®ä¾‹ã€‚

# å…«ã€æ‰§è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œ

åé¢æˆ‘ä»¬ä¼šæ‰§è¡Œä¸€äº›ç”¨äºåˆå§‹åŒ–çš„æ“ä½œã€‚

å†…éƒ¨å…·ä½“åšäº†ä»€ä¹ˆæˆ‘ä»¬å’±ä¸è€ƒè™‘ï¼Œåœ¨åé¢çš„ç« èŠ‚ä¸­æˆ‘ä»¬ä¼šä¸€ä¸€è¿›è¡Œè®¨è®ºã€‚

{% box child:codeblock color:purple %}
```js
// åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸ
initLifeCycle(vm);
// åˆå§‹åŒ–äº‹ä»¶ä¸­å¿ƒ
initEvents(vm)
// åˆå§‹åŒ–æ¸²æŸ“
initRender(vm)
// åˆå§‹åŒ– inject
initInjections(vm)
// åˆå§‹åŒ– propsã€dataã€computed ç­‰
initState(vm)
// åˆå§‹åŒ– provider
initProvide(vm)
```
{% endbox %}

{% box child:codeblock color:cyan %}
> è¿™äº›å‡½æ•°åŸºæœ¬ä¸Šéƒ½æ˜¯åœ¨å®ä¾‹ä¸ŠæŒ‚è½½äº†ä¸€äº›æ–¹æ³•ï¼Œæ¯”å¦‚æ¸²æŸ“æ‰§è¡Œçš„_updateå°±æ˜¯åœ¨ initLifecycleä¸­å®šä¹‰çš„ã€è·Ÿæ¸²æŸ“ç›¸å…³çš„_renderå‡½æ•°å°±æ˜¯åœ¨ initRenderä¸­å®šä¹‰çš„ã€‚
{% endbox %}

# ä¹ã€æ‰§è¡Œä¸€äº›ç”Ÿå‘½é’©å­

åœ¨æ‰§è¡Œ initRender åï¼Œä¼šè°ƒç”¨ beforeCreate é’©å­ã€‚è¿™è¡¨ç¤º{% mark beforeCreate é’©å­ color:orange %} è°ƒç”¨çš„æ—¶æœºä¸ºVueå®ä¾‹åŒ– dataæ•°æ®å‰ï¼Œæ‰€ä»¥æ­¤æ—¶è·å– dataæ˜¯æ— æ³•è·å–åˆ°çš„ï¼Œå› ä¸ºè¿™æ—¶å€™è¿˜æ²¡æœ‰åˆå§‹åŒ– dataã€‚

åœ¨æ‰§è¡Œå®Œæœ€åä¸€ä¸ªåˆå§‹åŒ–å‡½æ•°initProvideåï¼Œä¼šè°ƒç”¨ createdé’©å­ã€‚è¿™è¡¨ç¤º{% mark createdé’©å­ color:orange %} è°ƒç”¨çš„æ—¶æœºä¸ºVueå®ä¾‹åˆå§‹åŒ–åã€‚

{% box child:codeblock color:cyan %}
```js
    // çœç•¥
    initRender(vm)
    callHook(vm, 'beforeCreate', undefined, false /* setContext */)
    // çœç•¥
    initProvide(vm) // resolve provide after data/props
    callHook(vm, 'created')
```
{% endbox %}

# åã€æ‰§è¡ŒæŒ‚è½½

{% box child:codeblock color:purple %}
```js
if (vm.$options.el) {
    vm.$mount(vm.$options.el)
}
```
{% endbox %}

åˆ¤æ–­æ˜¯å¦æœ‰vmä¸Šæ˜¯å¦æœ‰$optionsé€‰é¡¹ï¼Œå¦‚æœå­˜åœ¨$optionsé€‰é¡¹ï¼Œåˆ™æ‰§è¡ŒæŒ‚è½½æ–¹æ³•ã€‚

# åä¸€ã€æ€»ç»“

åœ¨ initå‡½æ•°å†…éƒ¨ï¼Œä¸»è¦æ˜¯æ‰§è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œæ¯”å¦‚è®¾ç½®åŸºç¡€çš„ä»£ç†ã€‚åˆå§‹åŒ–dataã€ç»™å®ä¾‹ä¸Šè®¾ç½®_updateã€_renderæ–¹æ³•ç­‰ã€‚

{% image /assets/topic/vue2/banner/init.png %}
