---
title: ğŸ”¥Vue2åˆæ¬¡æ¸²æŸ“æµç¨‹
permalink: posts/vue2-init-render.html
date: 2024-11-15 14:48
topic: vue2
banner: /assets/topic/vue2/banner/vnode.png
--- 

{% quot ä¸“æ ç¬¬ä¸ƒç¯‡-åˆæ¬¡æ¸²æŸ“æµç¨‹ %}

ä¸Šç¯‡æˆ‘ä»¬ä»‹ç»äº†Vueæ¸²æŸ“çš„åŸºç¡€-è™šæ‹ŸDOMã€‚

åœ¨æ¸²æŸ“é˜¶æ®µï¼Œé€šè¿‡è™šæ‹Ÿ DOMæ¥åˆ›å»ºå…ƒç´ ã€‚

# ä¸€ã€ç¼–è¯‘æ—¶çš„æŒ‚è½½æ“ä½œ

åœ¨ä¸“æ ç¬¬å››ç¯‡ä¸­ï¼Œæˆ‘ä»¬æåˆ°äº†åœ¨Vueå®ä¾‹åŒ–æ—¶ï¼Œä¼šæ‰§è¡Œinitå‡½æ•°æ¥åˆå§‹åŒ–ä¸€äº›åç»­éœ€è¦çš„é€‰é¡¹ã€‚

é€šå¸¸åœ¨å®ä¾‹åŒ–åæˆ‘ä»¬ä¼šæ‰§è¡ŒæŒ‚è½½æ“ä½œã€‚

è€Œæœç´¢æºç å¯ä»¥å‘ç°ï¼Œ$mountæ–¹æ³•è¢«å®šä¹‰äº† 2 æ¬¡ã€‚

å› ä¸ºåœ¨è¿è¡Œæ—¶ç‰ˆæœ¬çš„ Vueä¸­ï¼Œ$mountä¸éœ€è¦è¿›è¡Œæ¨¡æ¿è½¬æ¢ã€‚

è€Œåœ¨æ¨¡æ¿ç¼–è¯‘ç‰ˆæœ¬çš„ Vueä¸­ï¼Œé‡å†™äº†è¿è¡Œæ—¶çš„$mountæ–¹æ³•ï¼Œå…¶ä¸­æ·»åŠ äº†ä¸€äº›æ¨¡æ¿ç¼–è¯‘çš„æ–¹æ³•ã€‚

> æ¨¡æ¿ç¼–è¯‘æ„ä¸ºå°† templateè½¬åŒ–æˆ renderå‡½æ•°ã€‚

{% box child:codeblock color:purple %}
```js
const mount = Vue.prototype.$mount
Vue.prototype.$mount = function (
  el?: string | Element,
  hydrating?: boolean
): Component {
  el = el && query(el)

  /* istanbul ignore if */
  if (el === document.body || el === document.documentElement) {
    __DEV__ &&
      warn(
        `Do not mount Vue to <html> or <body> - mount to normal elements instead.`
      )
    return this
  }

  const options = this.$options
  // resolve template/el and convert to render function
  if (!options.render) {
    let template = options.template
    if (template) {
      if (typeof template === 'string') {
        if (template.charAt(0) === '#') {
          template = idToTemplate(template)
          /* istanbul ignore if */
          if (__DEV__ && !template) {
            warn(
              `Template element not found or is empty: ${options.template}`,
              this
            )
          }
        }
      } else if (template.nodeType) {
        template = template.innerHTML
      } else {
        if (__DEV__) {
          warn('invalid template option:' + template, this)
        }
        return this
      }
    } else if (el) {
      // @ts-expect-error
      template = getOuterHTML(el)
    }
    if (template) {
      /* istanbul ignore if */
      if (__DEV__ && config.performance && mark) {
        mark('compile')
      }

      const { render, staticRenderFns } = compileToFunctions(
        template,
        {
          outputSourceRange: __DEV__,
          shouldDecodeNewlines,
          shouldDecodeNewlinesForHref,
          delimiters: options.delimiters,
          comments: options.comments
        },
        this
      )
      options.render = render
      options.staticRenderFns = staticRenderFns

      /* istanbul ignore if */
      if (__DEV__ && config.performance && mark) {
        mark('compile end')
        measure(`vue ${this._name} compile`, 'compile', 'compile end')
      }
    }
  }
  return mount.call(this, el, hydrating)
} 
```
{% endbox %}

1. é¦–å…ˆè·å–ä¼ å…¥elå‚æ•°ï¼Œä¹Ÿå°±æ˜¯æŒ‚è½½çš„èŠ‚ç‚¹ã€‚
2. ç„¶ååˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦æ˜¯bodyèŠ‚ç‚¹æˆ–è€…htmlèŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯åˆ™æç¤ºæ— æ³•æŒ‚è½½å¹¶è¿”å›ã€‚
3. å¦‚æœæ²¡æœ‰renderæ–¹æ³•ï¼Œè·å–templateé€‰é¡¹ã€‚ 
    1. å¦‚æœå­˜åœ¨ templateé€‰é¡¹ï¼š
        - templateæ˜¯ä¸€ä¸ªé€‰æ‹©èŠ‚ç‚¹å­—ç¬¦ä¸²{% mark ("#app") color:orange %}ï¼Œå°†templateå˜é‡è®¾ç½®ä¸ºèŠ‚ç‚¹å­—ç¬¦ä¸²å¯¹åº”çš„HTMLä»£ç ã€‚
        - templateæ˜¯ä¸€ä¸ªçœŸå®DOMèŠ‚ç‚¹ï¼Œå°†templateå˜é‡è®¾ç½®ä¸ºèŠ‚ç‚¹å¯¹åº”çš„HTMLä»£ç ã€‚
        - å¦‚æœéƒ½ä¸æ˜¯ï¼Œåˆ™ä¼šæç¤ºæ— æ•ˆçš„templateé€‰é¡¹ã€‚
    2. å¦‚æœä¸å­˜åœ¨ templateé€‰é¡¹ï¼Œä½†æ˜¯æœ‰ elèŠ‚ç‚¹ï¼Œåˆ™å°†templateå˜é‡è®¾ç½®ä¸ºelèŠ‚ç‚¹å¯¹åº”çš„ HTMLä»£ç ã€‚
    3. è·å–åˆ°å¯¹åº”çš„æ¨¡æ¿ï¼Œç„¶åå°†è¿™ä¸ªå°†è¿™ä¸ªæ¨¡æ¿è½¬æ¢æˆ renderå‡½æ•°
4. å¦‚æœæœ‰renderæ–¹æ³•ï¼Œç›´æ¥æ‰§è¡Œ mountæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¿è¡Œæ—¶å®šä¹‰çš„$mountæ–¹æ³•ã€‚

# äºŒã€è¿è¡Œæ—¶çš„æŒ‚è½½æ“ä½œ

ä¸Šé¢æˆ‘ä»¬è¯´åˆ°ç¼–è¯‘æ—¶çš„$mountæ–¹æ³•å°†æ¨¡æ¿è½¬æ¢æˆäº†renderæ–¹æ³•ã€‚

ç„¶åè°ƒç”¨äº†è¿è¡Œæ—¶çš„$mountæ–¹æ³•ã€‚

è®©æˆ‘ä»¬æ¥çœ‹çœ‹$mountæ–¹æ³•éƒ½åšäº†ä»€ä¹ˆæ“ä½œã€‚

{% box child:codeblock color:purple %}
```js
Vue.prototype.$mount = function (
  el?: string | Element,
  hydrating?: boolean
): Component {
  el = el && inBrowser ? query(el) : undefined
  return mountComponent(this, el, hydrating)
}
```
{% endbox %}

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å°±æ˜¯è·å–èŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨äº†mountComponentæ–¹æ³•ã€‚

# ä¸‰ã€mountComponent

å¯ä»¥çœ‹å‡ºæ¥æœ€ç»ˆæ‰§è¡Œäº†mountComponentæ–¹æ³•ã€‚

æˆ‘ä»¬æŠŠç›®å…‰ç§»åˆ°mountComponentæ–¹æ³•ä¸­ã€‚

