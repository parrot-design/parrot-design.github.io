---
title: ğŸ”¥Vue2æ•°æ®å“åº”å¼åŸç†
permalink: posts/vue2-observe.html
date: 2024-11-18 14:39
topic: vue2
banner: /assets/topic/vue2/observe/15.jpg
---  
 
&nbsp;

{% button è¿”å› javascript:window.history.back() icon:solar:back-white color:orange size:xs %}

{% quot ä¸“æ ç¬¬å…«ç¯‡-æ•°æ®å“åº”å¼åŸç† %}

ä¸Šä¸€ç¯‡ä¸­æˆ‘ä»¬å°†åˆæ¬¡æ¸²æŸ“é¡µé¢çš„æµç¨‹å¤§è‡´çš„è¿‡äº†ä¸€éã€‚

å½“ç„¶ï¼Œè¿˜æœ‰å¾ˆå¤šç»†èŠ‚æ²¡æœ‰æè¿°ã€‚

Vueä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†çš„å°±æ˜¯æ•°æ®é©±åŠ¨è§†å›¾ï¼Œæ‰€è°“å“åº”å¼å°±æ˜¯å½“æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œç•Œé¢ä¼šåŒæ­¥æ›´æ–°ã€‚

# ä¸€ã€æ•°æ®ä»£ç†çš„åŸºç¡€

æ•°æ®ä»£ç†ï¼Œæœ‰æ—¶ä¹Ÿè¢«ç§°ä½œæ•°æ®åŠ«æŒï¼Œæ˜¯ä¸€ç§æŠ€æœ¯æ‰‹æ®µï¼Œå®ƒèƒ½å¤Ÿæˆªè·å¯¹å¯¹è±¡å±æ€§çš„è®¿é—®å’Œä¿®æ”¹æ“ä½œï¼Œå¹¶åœ¨è¿™äº›æ“ä½œå‘ç”Ÿæ—¶æ‰§è¡Œé¢å¤–çš„é€»è¾‘æˆ–ä¿®æ”¹è¿”å›çš„ç»“æœã€‚

åœ¨ Vue.js ä¸­ï¼Œå“åº”å¼ç³»ç»Ÿçš„æ ¸å¿ƒæœºåˆ¶æ­£æ˜¯åŸºäºæ•°æ®ä»£ç†ã€‚

é€šè¿‡ä»£ç†ï¼ŒVue èƒ½å¤Ÿ{% u åœ¨æ•°æ®è¢«è®¿é—®æ—¶æ”¶é›†ä¾èµ–ï¼Œåœ¨æ•°æ®è¢«ä¿®æ”¹æ—¶æ›´æ–°è¿™äº›ä¾èµ– %}ï¼Œè¿™æ˜¯å“åº”å¼ç³»ç»Ÿè¿ä½œçš„åŸºæœ¬ç†å¿µã€‚

è€Œè¿™ä¸€åˆ‡éƒ½ä¾èµ–äº Vue å¯¹æ•°æ®è¿›è¡Œçš„æ‹¦æˆªå’Œä»£ç†æ“ä½œã€‚

å°½ç®¡å“åº”å¼ç‰¹æ€§æœ¬èº«å¹¶éæœ¬èŠ‚çš„è®¨è®ºé‡ç‚¹ï¼Œæˆ‘ä»¬å°†æ¢ç´¢æ•°æ®ä»£ç†åœ¨å…¶ä»–åœºæ™¯ä¸‹çš„åº”ç”¨ã€‚

åœ¨æ·±å…¥åˆ†æä¹‹å‰ï¼Œé‡è¦çš„æ˜¯è¦ç†è§£å®ç°æ•°æ®ä»£ç†çš„ä¸¤ç§ä¸»è¦æ–¹æ³•ï¼š{% u Object.defineProperty %}å’Œ {% u Proxy %}ã€‚

è¿™ä¸¤ç§æ–¹æ³•ä¸ºæˆ‘ä»¬æä¾›äº†å¼ºå¤§çš„æ”¯æŒï¼Œä»¥å®ç°å¯¹æ•°æ®è®¿é—®å’Œä¿®æ”¹è¡Œä¸ºçš„ç²¾ç»†æ§åˆ¶ã€‚ 

## 1.1 Object.defineProperty

Vueæ˜¯é€šè¿‡è¿™ä¸ªAPIå¯¹æ•°æ®è¿›è¡Œç›‘å¬çš„ã€‚

> Object.defineProperty() æ–¹æ³•ç”¨äºåœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šç›´æ¥å®šä¹‰ä¸€ä¸ªæ–°å±æ€§ï¼Œæˆ–è€…ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„ç°æœ‰å±æ€§ï¼Œå¹¶è¿”å›è¯¥å¯¹è±¡ã€‚

åŸºæœ¬ä½¿ç”¨å¦‚ä¸‹ï¼š

{% box child:codeblock color:purple %}
```js
Object.defineProperty(obj, prop, descriptor)
```
{% endbox %}

å‚æ•°è¯´æ˜ï¼š

> objï¼šå¿…éœ€ã€‚ç›®æ ‡å¯¹è±¡
> propsï¼šå¿…éœ€ã€‚éœ€å®šä¹‰æˆ–ä¿®æ”¹çš„å±æ€§çš„åå­—
> descriptorï¼šå¿…éœ€ã€‚ç›®æ ‡å±æ€§æ‰€æ‹¥æœ‰çš„ç‰¹æ€§

Object.defineProperty() å…è®¸æˆ‘ä»¬ç²¾ç¡®åœ°æ·»åŠ æˆ–ä¿®æ”¹å¯¹è±¡çš„å±æ€§ã€‚ 

ç»™å¯¹è±¡çš„å±æ€§æ·»åŠ ç‰¹æ€§æè¿°æœ‰ä¸¤ç§å½¢å¼ï¼š{% u 1.æ•°æ®æè¿°å’Œ2.å­˜å–æè¿° color:orange %}ã€‚

æ•°æ®æè¿°å’Œå­˜å–æè¿°æ‰€å¯¹åº”çš„å±æ€§æ˜¯ä¸åŒçš„ã€‚

### 1.1.1 æ•°æ®æè¿°

å½“ä¿®æ”¹æˆ–å®šä¹‰å¯¹è±¡çš„æŸä¸ªå±æ€§çš„æ—¶å€™ï¼Œç»™è¿™ä¸ªå±æ€§æ·»åŠ ä¸€äº›ç‰¹æ€§ã€‚

{% box child:codeblock color:purple %}
```js
let obj = {
    test:'hello world'
}
//å¯¹å·²æœ‰çš„å±æ€§æ·»åŠ ç‰¹æ€§æè¿°
Object.defineProperty(obj,"test",{
    configurable:true | false,
    enumerable:true | false,
    value:ä»»æ„ç±»å‹çš„å€¼,
    writable:true | false
});
//å¯¹æ–°æ·»åŠ çš„å±æ€§çš„ç‰¹æ€§æè¿°
Object.defineProperty(obj,"newKey",{
    configurable:true | false,
    enumerable:true | false,
    value:ä»»æ„ç±»å‹çš„å€¼,
    writable:true | false
});
```
{% endbox %}

æ•°æ®æè¿°ä¸­æœ‰å››ä¸ªå±æ€§ï¼Œéƒ½æ˜¯å¯é€‰çš„ï¼Œæ¥çœ‹ä¸€ä¸‹æ¯ä¸€ä¸ªå±æ€§çš„ä½œç”¨ã€‚

#### 1.1.1.1 value 

å±æ€§å¯¹åº”çš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨ä»»æ„ç±»å‹çš„å€¼ï¼Œé»˜è®¤ä¸º undefinedã€‚

{% box child:codeblock color:purple %}
```js
let obj = {}
//ç¬¬ä¸€ç§æƒ…å†µï¼šä¸è®¾ç½®valueå±æ€§
Object.defineProperty(obj,"newKey",{

});
console.log( obj.newKey );  //undefined
----------------------------------------
//ç¬¬äºŒç§æƒ…å†µï¼šè®¾ç½®valueå±æ€§
Object.defineProperty(obj,"newKey",{
    value:"hello"
});
console.log( obj.newKey );  //hello
```
{% endbox %}


#### 1.1.1.2 writable 

å±æ€§çš„å€¼æ˜¯å¦å¯ä»¥è¢«é‡å†™ã€‚è®¾ç½®ä¸ºtrueå¯ä»¥è¢«é‡å†™ï¼›è®¾ç½®ä¸ºfalseï¼Œä¸èƒ½è¢«é‡å†™ã€‚é»˜è®¤ä¸ºfalseã€‚

{% box child:codeblock color:purple %}
```js
let obj = {}
//ç¬¬ä¸€ç§æƒ…å†µï¼šwritableè®¾ç½®ä¸ºfalseï¼Œä¸èƒ½é‡å†™ã€‚
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:false
});
//æ›´æ”¹newKeyçš„å€¼
obj.newKey = "change value";
console.log( obj.newKey );  //hello
------------------------------
//ç¬¬äºŒç§æƒ…å†µï¼šè®¾ç½®valueå±æ€§
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:true
});
//æ›´æ”¹newKeyçš„å€¼
obj.newKey = "change value";
console.log( obj.newKey );  //change value
```
{% endbox %}
 
#### 1.1.1.3 configurable 

æ˜¯å¦å¯ä»¥åˆ é™¤ç›®æ ‡å±æ€§æˆ–æ˜¯å¦å¯ä»¥å†æ¬¡ä¿®æ”¹å±æ€§çš„ç‰¹æ€§ï¼ˆwritable, configurable, enumerableï¼‰ã€‚è®¾ç½®ä¸ºtrueå¯ä»¥è¢«åˆ é™¤æˆ–å¯ä»¥é‡æ–°è®¾ç½®ç‰¹æ€§ï¼›è®¾ç½®ä¸ºfalseï¼Œä¸èƒ½è¢«å¯ä»¥è¢«åˆ é™¤æˆ–ä¸å¯ä»¥é‡æ–°è®¾ç½®ç‰¹æ€§ã€‚é»˜è®¤ä¸ºfalseã€‚

è¿™ä¸ªå±æ€§èµ·åˆ°ä¸¤ä¸ªä½œç”¨ï¼š

1. ç›®æ ‡å±æ€§æ˜¯å¦å¯ä»¥ä½¿ç”¨deleteåˆ é™¤
2. ç›®æ ‡å±æ€§æ˜¯å¦å¯ä»¥å†æ¬¡è®¾ç½®ç‰¹æ€§


{% box child:codeblock color:purple %}
```js
//-----------------æµ‹è¯•ç›®æ ‡å±æ€§æ˜¯å¦èƒ½è¢«åˆ é™¤------------------------
let obj = {}
//ç¬¬ä¸€ç§æƒ…å†µï¼šconfigurableè®¾ç½®ä¸ºfalseï¼Œä¸èƒ½è¢«åˆ é™¤ã€‚
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:false,
    enumerable:false,
    configurable:false
});
//åˆ é™¤å±æ€§
delete obj.newKey;
console.log( obj.newKey ); //hello
//ç¬¬äºŒç§æƒ…å†µï¼šconfigurableè®¾ç½®ä¸ºtrueï¼Œå¯ä»¥è¢«åˆ é™¤ã€‚
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:false,
    enumerable:false,
    configurable:true
});
//åˆ é™¤å±æ€§
delete obj.newKey;
console.log( obj.newKey ); //undefined

//-----------------æµ‹è¯•æ˜¯å¦å¯ä»¥å†æ¬¡ä¿®æ”¹ç‰¹æ€§------------------------
let obj = {}
//ç¬¬ä¸€ç§æƒ…å†µï¼šconfigurableè®¾ç½®ä¸ºfalseï¼Œä¸èƒ½å†æ¬¡ä¿®æ”¹ç‰¹æ€§ã€‚
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:false,
    enumerable:false,
    configurable:false
});
//é‡æ–°ä¿®æ”¹ç‰¹æ€§
//æŠ¥é”™ï¼šUncaught TypeError: Cannot redefine property: newKey
// å› ä¸º writableå’Œ configurableéƒ½ä¸º false å³æ— æ³•é‡æ–°é…ç½®
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:true,
    enumerable:true,
    configurable:true
});


//ç¬¬äºŒç§æƒ…å†µï¼šconfigurableè®¾ç½®ä¸ºtrueï¼Œå¯ä»¥å†æ¬¡ä¿®æ”¹ç‰¹æ€§ã€‚
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:false,
    enumerable:false,
    configurable:true
});
//é‡æ–°ä¿®æ”¹ç‰¹æ€§
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:true,
    enumerable:true,
    configurable:true
});
console.log( obj.newKey ); //hello
```
{% endbox %}

#### 1.1.1.4 enumerable
 
æ­¤å±æ€§æ˜¯å¦å¯ä»¥è¢«æšä¸¾ï¼ˆä½¿ç”¨for...inæˆ–Object.keys()ï¼‰ã€‚è®¾ç½®ä¸ºtrueå¯ä»¥è¢«æšä¸¾ï¼›è®¾ç½®ä¸ºfalseï¼Œä¸èƒ½è¢«æšä¸¾ã€‚é»˜è®¤ä¸ºfalseã€‚

{% box child:codeblock color:purple %}
```js
let obj = {}
//ç¬¬ä¸€ç§æƒ…å†µï¼šenumerableè®¾ç½®ä¸ºfalseï¼Œä¸èƒ½è¢«æšä¸¾ã€‚
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:false,
    enumerable:false
});

//æšä¸¾å¯¹è±¡çš„å±æ€§
for( var attr in obj ){
    console.log( attr );  // æ‰“å°ä¸ºç©º
}
//ç¬¬äºŒç§æƒ…å†µï¼šenumerableè®¾ç½®ä¸ºtrueï¼Œå¯ä»¥è¢«æšä¸¾ã€‚
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:false,
    enumerable:true
});

//æšä¸¾å¯¹è±¡çš„å±æ€§
for( var attr in obj ){
    console.log( attr );  //newKey
}
```
{% endbox %}

> {% u ä¸€æ—¦ä½¿ç”¨Object.definePropertyç»™å¯¹è±¡æ·»åŠ å±æ€§ï¼Œé‚£ä¹ˆå¦‚æœä¸è®¾ç½®å±æ€§çš„ç‰¹æ€§ï¼Œé‚£ä¹ˆconfigurableã€enumerableã€writableè¿™äº›å€¼éƒ½ä¸ºé»˜è®¤çš„false color:orange %}

### 1.1.2 å­˜å–å™¨æè¿°

å­˜å–å™¨æè¿°ç¬¦ä¹Ÿæœ‰å››ä¸ªå±æ€§ï¼šgetã€setã€enumerableã€configureã€‚

{% box child:codeblock color:purple %}
```js
let obj = {};
Object.defineProperty(obj,"newKey",{
    get:function (){} | undefined,
    set:function (value){} | undefined
    configurable: true | false
    enumerable: true | false
});
```
{% endbox %}

> å½“ä½¿ç”¨äº†getteræˆ–setteræ–¹æ³•ï¼Œä¸å…è®¸ä½¿ç”¨writableå’Œvalueè¿™ä¸¤ä¸ªå±æ€§


#### 1.1.2.1 getter/setter

å½“è®¾ç½®æˆ–è·å–å¯¹è±¡çš„æŸä¸ªå±æ€§çš„å€¼çš„æ—¶å€™ï¼Œå¯ä»¥æä¾›getter/setteræ–¹æ³•ã€‚

* getter æ˜¯ä¸€ç§è·å¾—å±æ€§å€¼çš„æ–¹æ³•
* setteræ˜¯ä¸€ç§è®¾ç½®å±æ€§å€¼çš„æ–¹æ³•ã€‚

åœ¨ç‰¹æ€§ä¸­ä½¿ç”¨get/setå±æ€§æ¥å®šä¹‰å¯¹åº”çš„æ–¹æ³•ã€‚

{% box child:codeblock color:purple %}
```js
let obj = {};
let initValue = 'hello';
Object.defineProperty(obj,"newKey",{
    get:function (){
        //å½“è·å–å€¼çš„æ—¶å€™è§¦å‘çš„å‡½æ•°
        return initValue;    
    },
    set:function (value){
        //å½“è®¾ç½®å€¼çš„æ—¶å€™è§¦å‘çš„å‡½æ•°,è®¾ç½®çš„æ–°å€¼é€šè¿‡å‚æ•°valueæ‹¿åˆ°
        initValue = value;
    }
});
//è·å–å€¼
console.log( obj.newKey );  //hello

//è®¾ç½®å€¼
obj.newKey = 'change value';

console.log( obj.newKey ); //change value
```
{% endbox %}

> æ³¨æ„ï¼šgetæˆ–setä¸æ˜¯å¿…é¡»æˆå¯¹å‡ºç°ï¼Œä»»å†™å…¶ä¸€å°±å¯ä»¥ã€‚å¦‚æœä¸è®¾ç½®æ–¹æ³•ï¼Œåˆ™getå’Œsetçš„é»˜è®¤å€¼ä¸ºundefined

> configurableå’ŒenumerableåŒä¸Šé¢çš„ç”¨æ³•ã€‚

> å±æ€§æè¿°ç¬¦å’Œæ•°æ®æè¿°ç¬¦éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œå¦‚æœä½ åœ¨ç¬¬ä¸‰ä¸ªå‚æ•°ä¸­æ—¢å†™äº† value/writableï¼Œåˆå†™äº† get/set åˆ™ä¼šæŠ¥é”™ã€‚

{% image /assets/topic/vue2/observe/2.png %}

### 1.1.3 å…¼å®¹æ€§

{% image /assets/topic/vue2/observe/1.png %}

å…¼å®¹æ€§å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šåœ¨ie8ä¸‹åªèƒ½åœ¨DOMå¯¹è±¡ä¸Šä½¿ç”¨ï¼Œå°è¯•åœ¨åŸç”Ÿçš„å¯¹è±¡ä½¿ç”¨ Object.defineProperty()ä¼šæŠ¥é”™ã€‚

### 1.1.4 å›°æƒ‘çš„é—®é¢˜

{% image /assets/topic/vue2/observe/3.png %}

å¦‚ä¸Šï¼Œåœ¨ä½¿ç”¨ get æ–¹æ³•åï¼Œæ— æ³•ç›´æ¥çœ‹åˆ°å¯¹è±¡ä¸Šçš„å±æ€§ï¼Œéœ€è¦ç‚¹å‡»æ‰å¯ä»¥ã€‚

## 1.2 Proxy 

### 1.2.1 definePropertyçš„ç¼ºç‚¹

æˆ‘ä»¬çŸ¥é“Vue2ä¸­çš„æ•°æ®å“åº”å¼å¤„ç†ä½¿ç”¨çš„æ˜¯ Object.definePropertyï¼Œè€Œ Vue3ä¸­å®ç°æ•°æ®å“åº”ä½¿ç”¨çš„æ˜¯ Proxyã€‚

Object.definePropertyè™½ç„¶å¯ä»¥å®ç°åŠŸèƒ½ï¼Œä½†æ˜¯æ— æ³•å¯¹æ•°ç»„æˆ–è€…æ·±å±‚æ¬¡å¯¹è±¡è¿›è¡Œç›‘å¬å¤„ç†ã€‚

#### 1.2.1.1 æ•°ç»„

{% box child:codeblock color:purple %}
```js
let arr = [1,2,3,4,5];
arr.forEach((item,index)=>{
    Object.defineProperty(arr,index,{
        get() {
            console.log('æ•°ç»„è¢«getteræ‹¦æˆª')
            return item
        },
        set(value) {
            console.log('æ•°ç»„è¢«setteræ‹¦æˆª')
            return item = value
        }
    })
})
arr[1] = 11;
console.log(arr[1]);
arr.push(6)
arr[10] = 10
// ç»“æœ
æ•°ç»„è¢«setteræ‹¦æˆª
æ•°ç»„è¢«getteræ‹¦æˆª
11
```
{% endbox %}

å¾ˆæ˜¾ç„¶ï¼Œ{% u å·²çŸ¥é•¿åº¦çš„æ•°ç»„å¯ä»¥é€šè¿‡ç´¢å¼•è¿›è¡Œå±æ€§çš„è®¾ç½®ä¸è®¿é—® color:orange %}ã€‚

ç„¶è€Œï¼Œæ•°ç»„çš„æ·»åŠ æ“ä½œå´æ— æ³•è¢«ç›´æ¥æ‹¦æˆªã€‚

è¿™å¾ˆå®¹æ˜“ç†è§£ï¼šæ— è®ºæ˜¯é€šè¿‡ arr.push() æ–¹æ³•è¿˜æ˜¯ç›´æ¥èµ‹å€¼å¦‚ arr[10] = 10 æ¥æ·»åŠ å…ƒç´ ï¼Œæ–°æ·»åŠ çš„ç´¢å¼•å¹¶æœªè¢«åŒ…å«åœ¨é¢„è®¾çš„æ•°æ®æ‹¦æˆªæœºåˆ¶ä¸­ï¼Œå› æ­¤æ— æ³•å®ç°æ‹¦æˆªå¤„ç†ã€‚

è¿™æ˜¯ä½¿ç”¨ Object.defineProperty è¿›è¡Œæ•°æ®ä»£ç†çš„ä¸€ä¸ªå±€é™æ€§ã€‚

Vue åœ¨å…¶å“åº”å¼ç³»ç»Ÿä¸­å¯¹æ•°ç»„æ–¹æ³•è¿›è¡Œäº†é‡å†™ï¼Œä»è€Œé—´æ¥åœ°è§£å†³äº†æ­¤é—®é¢˜ã€‚

#### 1.2.1.2 æ·±å±‚æ¬¡å¯¹è±¡ 

{% box child:codeblock color:purple %}
```js
let obj={
    level1:{
        level2:"ç¬¬äºŒå±‚"
    }
}
// ä¿å­˜ level1 çš„åŸå§‹å€¼ é¿å…å¾ªç¯å¼•ç”¨çš„é”™è¯¯
let originalLevel1 = obj.level1;
Object.defineProperty(obj,'level1',{
    get(){
        console.log("å¯¹è±¡è¢«getteræ‹¦æˆª")
        return originalLevel1
    },
    set(value){
        console.log("å¯¹è±¡è¢«setteræ‹¦æˆª")
        originalLevel1 = value;
    }
})
// ç»“æœ
å¯¹è±¡è¢«setteræ‹¦æˆª
å¯¹è±¡è¢«getteræ‹¦æˆª
obj.level1 = {level3:"ç¬¬ä¸‰å±‚"}
console.log(obj.level1)// {level3:"ç¬¬ä¸‰å±‚"}
```
{% endbox %}

å¯ä»¥çœ‹åˆ°æ›´æ–°è®¾ç½®çš„é‚£ä¸€å±‚æ˜¯æ²¡é—®é¢˜çš„ã€‚

ä½†æ˜¯å¦‚æœæˆ‘ä»¬æ›´æ–°æ›´æ·±å±‚æ¬¡çš„å¯¹è±¡ï¼Œå°±æ— æ³•ç›‘å¬åˆ°ã€‚

{% box child:codeblock color:purple %}
```js
let obj={
    level1:{
        level2:"ç¬¬äºŒå±‚"
    }
}
// ä¿å­˜ level1 çš„åŸå§‹å€¼ é¿å…å¾ªç¯å¼•ç”¨çš„é”™è¯¯
let originalLevel1 = obj.level1;
Object.defineProperty(obj,'level1',{
    get(){
        console.log("å¯¹è±¡è¢«getteræ‹¦æˆª")
        return originalLevel1
    },
    set(value){
        console.log("å¯¹è±¡è¢«setteræ‹¦æˆª")
        originalLevel1 = value;
    }
}) 
obj.level1.level2 = 'ç¬¬äºŒå±‚-å¤åˆ¶'
//ç»“æœ
å¯¹è±¡è¢«getteræ‹¦æˆª
```
{% endbox %}

å¯ä»¥çœ‹å‡ºæ¥å¹¶æ²¡æœ‰æ‰§è¡Œ set æ–¹æ³•ï¼Œå¦‚æœæƒ³è¦æ·±å±‚æ¬¡çš„å±æ€§ä¹Ÿè¢«ç›‘å¬åˆ°çš„è¯ï¼Œéœ€è¦é€’å½’åœ°ç»™å¯¹è±¡ä¸­çš„æ¯ä¸€ä¸ªå±æ€§æ·»åŠ å±æ€§æè¿°ã€‚


{% box child:codeblock color:purple %}
```js
function walk(obj){
    // å¦‚æœä¸æ˜¯å¯¹è±¡ æ— éœ€å¤„ç†
    if(!(obj instanceof Object))  return obj
    for(let k in obj){
        let val = obj[k];
        walk(val);
        Object.defineProperty(obj,k,{
            enumerable:true,
            configurable:true,
            get(){
                console.log(`è®¿é—®obj.${k}å±æ€§è§¦å‘`)
                return val
            },
            set(newValue) {
                console.log(`ä¿®æ”¹obj.${k}å±æ€§è§¦å‘` , newValue)
                if (val === newValue) return;
                val = newValue
                walk(newValue)
            } 
        })
    }
    return obj;
}
// é€’å½’ç›‘å¬æ‰€æœ‰å±‚çº§å¯¹è±¡
let obj = {a:{b:{c:'d'}}}
walk(obj)
obj.a
obj.a.b
obj.a.b.c
```
{% endbox %}

### 1.2.2 Proxyçš„ä»‹ç»

Proxyå°±å¯ä»¥è§£å†³Object.definePropertyçš„è¿™äº›é—®é¢˜ã€‚

ä»£ç†æ˜¯ç›®æ ‡å¯¹è±¡çš„æŠ½è±¡ã€‚

ä»–å¯ä»¥ç”¨ä½œç›®æ ‡å¯¹è±¡çš„æ›¿èº«ï¼Œä½†åˆå®Œå…¨ç‹¬ç«‹äºç›®æ ‡å¯¹è±¡ã€‚

ç›®æ ‡å¯¹è±¡æ—¢å¯ä»¥ç›´æ¥è¢«æ“ä½œï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä»£ç†æ¥æ“ä½œã€‚ä½†æ˜¯ç›´æ¥æ“ä½œä¼šç»•è¿‡ä»£ç†èµ‹äºˆçš„è¡Œä¸ºã€‚

#### 1.2.2.1 ç©ºä»£ç†

æœ€ç®€å•çš„ä»£ç†æ˜¯ç©ºä»£ç†ï¼Œå³é™¤äº†ä½œä¸ºä¸€ä¸ªæŠ½è±¡çš„ç›®æ ‡å¯¹è±¡ï¼Œä»€ä¹ˆä¹Ÿä¸åšã€‚

ä»£ç†å¯¹è±¡ä¸Šæ‰§è¡Œçš„æ‰€æœ‰æ“ä½œéƒ½ä¼šæ— éšœç¢çš„ä¼ æ’­åˆ°ç›®æ ‡å¯¹è±¡ã€‚

{% box child:codeblock color:purple %}
```js
const target = {
    id: 'target'
}

const handler = {}

const proxy = new Proxy(target, handler)
// idå±æ€§ä¼šè®¿é—®åŒä¸€ä¸ªå€¼
console.log(target.id); // target
console.log(proxy.id); // target

// ç»™ç›®æ ‡å±æ€§èµ‹å€¼ä¼šåæ˜ åœ¨ä¸¤ä¸ªå¯¹è±¡ä¸Š
// å› ä¸ºä¸¤ä¸ªå¯¹è±¡è®¿é—®çš„æ˜¯åŒä¸€ä¸ªå€¼
target.id = 'foo';
console.log(target.id); // foo
console.log(proxy.id); // foo 

// ç»™ä»£ç†å±æ€§èµ‹å€¼ä¼šåæ˜ åœ¨ä¸¤ä¸ªå¯¹è±¡ä¸Š
// å› ä¸ºè¿™ä¸ªèµ‹å€¼ä¼šè½¬ç§»åˆ°ç›®æ ‡å¯¹è±¡
proxy.id = 'bar';
console.log(target.id); // bar
console.log(proxy.id); // bar

// Proxy.prototype æ˜¯ undefined
// å› æ­¤ä¸èƒ½ä½¿ç”¨ instanceof æ“ä½œç¬¦
console.log(target instanceof Proxy); // TypeError: Function has non-object prototype 
console.log(proxy instanceof Proxy); // TypeError: Function has non-object prototype

// ä¸¥æ ¼ç›¸ç­‰å¯ä»¥ç”¨æ¥åŒºåˆ†ä»£ç†å’Œç›®æ ‡
console.log(target === proxy); // false
```
{% endbox %}

#### 1.2.2.2 å®šä¹‰æ•è·å™¨

å½“ç„¶ï¼Œæ­£å¸¸ä½¿ç”¨ä¸ä¼šç»™ä¸€ä¸ªç©ºä»£ç†ï¼Œè‚¯å®šæ˜¯è¦é€šè¿‡ä»£ç†å¯¹è®¿é—®å’Œä¿®æ”¹è¿›è¡Œæ•è·ã€‚

æœ¬èŠ‚æš‚ä¸”ä»‹ç»å‡ ä¸ªå¸¸ç”¨çš„æ•è·å™¨ã€‚è¦†ç›–Vue2ä¸­ä½¿ç”¨çš„æ‰€æœ‰æ•è·å™¨ã€‚

#### 1.2.2.2.1 get æ•è·å™¨

getæ•è·å™¨ä¼šåœ¨è·å–å±æ€§å€¼çš„æ“ä½œä¸­è¢«è°ƒç”¨ã€‚

{% box child:codeblock color:purple %}
```js 
const target = {
    foo: 'bar'
}; 

const handler = {
    // æ•è·å™¨åœ¨å¤„ç†ç¨‹åºå¯¹è±¡ä¸­ä»¥æ–¹æ³•åä¸ºé”®
    get(){
        return 'handler override';
    }
}

const proxy = new Proxy(target, handler)

// åªæœ‰åœ¨ä»£ç†å¯¹è±¡ä¸Šæ‰§è¡Œè¿™äº›æ“ä½œæ‰ä¼šè§¦å‘æ•è·å™¨ åœ¨ç›®æ ‡å¯¹è±¡ä¸Šæ‰§è¡Œè¿™äº›æ“ä½œä»ç„¶ä¼šäº§ç”Ÿæ­£å¸¸çš„è¡Œä¸º
console.log(target.foo) // bar
console.log(proxy.foo) // handler override
```
{% endbox %}

1. è¿”å›å€¼

è¿”å›å€¼æ— é™åˆ¶ã€‚

2. æ‹¦æˆªçš„æ“ä½œ

* proxy.property
* proxy[property]
* Object.create(proxy)[property]
* Reflect.get(proxy, property, receiver)

3. æ•è·å™¨å¤„ç†ç¨‹åºå‚æ•°

* target: ç›®æ ‡å¯¹è±¡
* property: å¼•ç”¨ç›®æ ‡å¯¹è±¡ä¸Šçš„å­—ç¬¦ä¸²é”®å±æ€§
* receiver: ä»£ç†å¯¹è±¡æˆ–ç»§æ‰¿ä»£ç†å¯¹è±¡çš„å¯¹è±¡  

#### 1.2.2.2.2 setæ•è·å™¨

set()æ•è·å™¨ä¼šåœ¨è®¾ç½®å±æ€§å€¼çš„æ“ä½œä¸­è¢«è°ƒç”¨ã€‚

{% box child:codeblock color:purple %}
```js 
const myTarget = {};
const proxy = new Proxy(myTarget, {
 set(target, property, value, receiver) {
    console.log('è§¦å‘äº†set');
    return Reflect.set(...arguments)
 }
});
proxy.foo = 'bar';
// è§¦å‘äº†set
```
{% endbox %}

1. è¿”å›å€¼

è¿”å› true è¡¨ç¤ºæˆåŠŸï¼›è¿”å› false è¡¨ç¤ºå¤±è´¥ï¼Œä¸¥æ ¼æ¨¡å¼ä¸‹ä¼šæŠ›å‡º TypeErrorã€‚

2. æ‹¦æˆªçš„æ“ä½œ

* proxy.property = value
* proxy.[property]  = value
* Object.create(proxy)[property] = value
* Reflect.set(proxy, property, value, receiver)

3. æ•è·å™¨å¤„ç†ç¨‹åºå‚æ•°

* target: ç›®æ ‡å¯¹è±¡
* property: å¼•ç”¨ç›®æ ‡å¯¹è±¡ä¸Šçš„å­—ç¬¦ä¸²é”®å±æ€§
* valueï¼šè¦èµ‹ç»™å±æ€§çš„å€¼ã€‚
* receiver: æ¥æ”¶æœ€åˆèµ‹å€¼çš„å¯¹è±¡  

#### 1.2.2.2.3 hasæ•è·å™¨

has()æ•è·å™¨ä¼šåœ¨ in æ“ä½œç¬¦ä¸­è¢«è°ƒç”¨ã€‚

{% box child:codeblock color:purple %}
```js 
const myTarget = {};
const proxy = new Proxy(myTarget, {
    has(target, property) {
        console.log('è§¦å‘äº†haså‡½æ•°');
        return Reflect.has(...arguments)
    }
});
'foo' in proxy;
// è§¦å‘äº†haså‡½æ•°
```
{% endbox %}

1. è¿”å›å€¼

has()å¿…é¡»è¿”å›å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºå±æ€§æ˜¯å¦å­˜åœ¨ã€‚è¿”å›éå¸ƒå°”å€¼ä¼šè¢«è½¬å‹ä¸ºå¸ƒå°”å€¼ã€‚

2. æ‹¦æˆªçš„æ“ä½œ

* property in proxy
* property in Object.create(proxy)
* with(proxy) {(property);}
* Reflect.has(proxy, property)

3. æ•è·å™¨å¤„ç†ç¨‹åºå‚æ•°

* target: ç›®æ ‡å¯¹è±¡
* property: å¼•ç”¨ç›®æ ‡å¯¹è±¡ä¸Šçš„å­—ç¬¦ä¸²é”®å±æ€§ 

### 1.2.3 è¯•è¯•æ·±å±‚æ¬¡å¯¹è±¡å’Œæ•°ç»„

ä¸Šé¢æˆ‘ä»¬è¯´åˆ°Object.definePropertyå¯¹äºæ•°ç»„æ ¼å¼å’Œæ·±å±‚æ¬¡å¯¹è±¡å¤„ç†ä¸äº†ã€‚

é‚£æˆ‘ä»¬æ¥è¯•è¯• Proxyæ˜¯å¦å¯ä»¥å¤„ç†ã€‚

#### 1.2.3.1 å¤„ç†æ•°ç»„

{% box child:codeblock color:purple %}
```js
let target = [1,2,3,4] 

let proxy = new Proxy(target,{
    get(){
        console.log("è§¦å‘äº†è·å–æ•°ç»„")
        return Reflect.get(...arguments)
    },
    set(){ 
        console.log("è§¦å‘äº†è®¾ç½®æ•°ç»„")
        return Reflect.set(...arguments) 
    }
}) 

proxy1.push(5);
console.log(proxy1[4]);
```
{% endbox %}

{% image /assets/topic/vue2/observe/4.png %}

å¯ä»¥çœ‹åˆ°æ‰“å°äº†å¤šæ¬¡ã€‚

ä½†æ˜¯è¿™é‡Œæœ‰ç‚¹ä»¤æˆ‘å›°æƒ‘çš„æ˜¯{% wavy ä¸ºä»€ä¹ˆä¼šæ‰“å°è¿™ä¹ˆå¤šæ¬¡? %}ã€‚

#### 1.2.3.2 å¤„ç†æ·±å±‚æ¬¡å¯¹è±¡

{% box child:codeblock color:purple %}
```js 
let target = {a:{b:{c:'d'}}}

let proxy = new Proxy(target,{
    get(){
        console.log("è§¦å‘äº†è·å–å¯¹è±¡")
        return Reflect.get(...arguments)
    },
    set(){ 
        console.log("è§¦å‘äº†è®¾ç½®å¯¹è±¡")
        return Reflect.set(...arguments) 
    }
}) 

proxy.a.b.c
proxy.a.b.c = 'e'
```
{% endbox %}

# äºŒã€initProxy

è™½ç„¶Vue2ä¸­çš„æ•°æ®åŠ«æŒå¹¶æ²¡æœ‰ä½¿ç”¨ Proxyï¼Œä½†æ˜¯å´åœ¨æ£€æµ‹ data æ—¶ä½¿ç”¨äº†Proxyã€‚

è¿˜è®°å¾—æˆ‘ä»¬åœ¨å‰é¢ç« èŠ‚[ä¸“æ ç¬¬å››ç¯‡-åˆå§‹åŒ–å¹²äº†ä»€ä¹ˆäº‹](/posts/vue2-init.html)ä¸­ä»‹ç»äº†Vueå®ä¾‹åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨ initProxyï¼Œä½†æ˜¯å½“æ—¶æˆ‘ä»¬å¹¶æ²¡æœ‰å¯¹è¿™ä¸ªæ–¹æ³•è¿›è¡Œæ·±åº¦å‰–æï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯ä½¿ç”¨ Proxy æ¥è¿›è¡Œæ•°æ®ä»£ç†ã€‚

ä½†æ˜¯æˆ‘ä»¬ç°åœ¨å·²ç»å­¦ä¹ äº† Proxyï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™å‡ æ¥è¯¦ç»†çœ‹ä¸‹è¿™å—çš„é€»è¾‘ã€‚

{% box child:codeblock color:purple %}
```js 
 Vue.prototype._init = function (options) {
    if (__DEV__) {
        initProxy(vm)
    } else {
        vm._renderProxy = vm
    }
 }
```
{% endbox %}

åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œè°ƒç”¨äº† initProxyã€‚

è€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹å¹¶æ²¡æœ‰è°ƒç”¨ï¼Œè€Œæ˜¯å°†å®ä¾‹æœ¬èº«èµ‹å€¼åˆ°_renderProxyå±æ€§ä¸­ã€‚

ä¸€èˆ¬ä»…å­˜åœ¨äºå¼€å‘ç¯å¢ƒä¸­çš„é€»è¾‘éƒ½æ˜¯ä¸€äº›æŠ¥é”™æç¤ºä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›²çŒœinitProxyä¹Ÿæ˜¯æ·»åŠ äº†å¼€å‘æ—¶æŠ¥é”™çš„æç¤ºä¿¡æ¯ã€‚

{% box child:codeblock color:purple %}
```js  
const hasHandler = {
    has(target, key) {
      const has = key in target
      const isAllowed =
        allowedGlobals(key) ||
        (typeof key === 'string' &&
          key.charAt(0) === '_' &&
          !(key in target.$data))
      if (!has && !isAllowed) {
        if (key in target.$data) warnReservedPrefix(target, key)
        else warnNonPresent(target, key)
      }
      return has || !isAllowed
    }
}

const getHandler = {
    get(target, key) {
      if (typeof key === 'string' && !(key in target)) {
        if (key in target.$data) warnReservedPrefix(target, key)
        else warnNonPresent(target, key)
      }
      return target[key]
    }
}

initProxy = function initProxy(vm) {
    if (hasProxy) {
      // determine which proxy handler to use
      const options = vm.$options
      const handlers =
        options.render && options.render._withStripped ? getHandler : hasHandler
      vm._renderProxy = new Proxy(vm, handlers)
    } else {
      vm._renderProxy = vm
    }
  }
}
```
{% endbox %}

## 2.1 hasProxy

é¦–å…ˆåˆ¤æ–­å½“å‰å®¿ä¸»ç¯å¢ƒä¸­æ˜¯å¦å­˜åœ¨Proxyï¼Œé€šè¿‡Proxyæ˜¯å¦å®šä¹‰å’Œæ˜¯åŸç”Ÿå±æ€§æ¥åˆ¤æ–­ã€‚

{% box child:codeblock color:purple %}
```js  
export function isNative(Ctor: any): boolean {
  return typeof Ctor === 'function' && /native code/.test(Ctor.toString())
}

const hasProxy = typeof Proxy !== 'undefined' && isNative(Proxy)
```
{% endbox %}

## 2.2 _renderProxy

åœ¨å¼€å‘ç¯å¢ƒä¸‹ç»™ vm è®¾ç½®ä»£ç†åï¼Œå°†_renderProxyè®¾ç½®ä¸ºä»£ç†å¯¹è±¡ã€‚ä»£ç†ç›®æ ‡ä¸º vueå®ä¾‹ vmã€‚è¿™æ„å‘³ç€å½“è®¿é—® vmæ—¶ï¼Œä¼šè§¦å‘ä»£ç†æ•è·å™¨ã€‚

åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ç›´æ¥å°†_renderProxyè®¾ç½®ä¸ºå®ä¾‹ vmã€‚

æ‰€ä»¥å¯ä»¥çœ‹å‡ºæ¥ä¸è®ºæ˜¯åœ¨å¼€å‘ç¯å¢ƒæˆ–è€…ç”Ÿäº§ç¯å¢ƒå¦‚ä½•éƒ½æ˜¯ç»™ vm._renderProxyè®¾ç½®å€¼ã€‚

é‚£ä¹ˆè¿™é‡Œçš„_renderProxyæ˜¯åœ¨ä½•æ—¶ä½¿ç”¨çš„å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯åœ¨æ‰§è¡Œ_renderæ–¹æ³•ç”Ÿæˆ vnodeçš„æ—¶å€™ï¼Œå°† vm._renderProxy å½“åšç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥renderæ–¹æ³•ä¸­ã€‚

{% box child:codeblock color:purple %}
```js  
vnode = render.call(vm._renderProxy, vm.$createElement)
```
{% endbox %}

æ¯”å¦‚æˆ‘ä»¬åœ¨.vueæ–‡ä»¶çš„æ¨¡ç‰ˆä¸­ç¼–å†™ä¸€æ®µä»£ç ï¼š

{% box child:codeblock color:purple %}
```html  
<div>{{ msg }}</div>
```
{% endbox %}

ä¸Šé¢è¿™æ®µä»£ç ä¼šè¢«è½¬åŒ–æˆä¸€ä¸ªrenderå‡½æ•°ã€‚

{% box child:codeblock color:purple %}
```js
render = function(){
    // è·å– this
    const _vm = this;
    // _vm._self æ˜¯ vue å®ä¾‹
    // _cæ˜¯åˆ›å»º vnodeçš„æ–¹æ³•
    const _c = _vm._self._c
    // _sæ˜¯è½¬æˆå­—ç¬¦ä¸²çš„æ–¹æ³•
    const _s = _vm._self._s
    return _c('div',_s(_vm.msg))
}
```
{% endbox %}

å¯ä»¥çœ‹å‡ºæ¥ renderå‡½æ•°çš„ thisæŒ‡å‘çš„å°±æ˜¯vm._renderProxyï¼Œä¹Ÿå°±æ˜¯ vueå®ä¾‹ã€‚

ç„¶åé€šè¿‡ {% u vm.xxx %} è®¿é—®å®ä¾‹ä¸Šçš„å±æ€§æ—¶å°±å¯ä»¥è§¦å‘ä»£ç†ä¸Šçš„å®šä¹‰çš„æ•è·å™¨é€»è¾‘ã€‚

## 2.3 æ¨¡æ¿æ¸²æŸ“çš„å‡ ç§æƒ…å†µ

åœ¨æˆ‘ä»¬äº†è§£æ•è·å™¨ä¸­çš„è¯¦ç»†é€»è¾‘å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ç¼–å†™Vueæ¸²æŸ“ä¸­çš„ä¸‰ç§æƒ…å†µã€‚

çŸ¥é“å¯¹åº”çš„ä»£ç å¤„ç†çš„æ˜¯å“ªäº›åœºæ™¯æœ‰åŠ©äºæˆ‘ä»¬æ›´å¥½çš„äº†è§£æºç ã€‚

### 2.3.1 ç”¨æˆ·è‡ªå®šä¹‰ template æ¨¡æ¿

{% box child:codeblock color:purple %}
```js
new Vue({
    template:`<div>{{ msg }}</div>`,
    data(){
        return {
            msg:'Hello World'
        }
    }
}).$mount("#app");
```
{% endbox %}

å¯¹templateé€‰é¡¹è¿›è¡Œæ¨¡ç‰ˆç¼–è¯‘æ˜¯å‘ç”Ÿåœ¨å®ä¾‹çš„æŒ‚è½½é˜¶æ®µã€‚

æ‰€ä»¥åœ¨åˆå§‹åŒ–æ—¶ï¼Œé€‰é¡¹ä¸­åªæœ‰ templateæ ‡ç­¾ã€‚

ç»è¿‡é€‰é¡¹åˆå¹¶åï¼Œvm.$optionsä¸Šåªæœ‰ templateé€‰é¡¹å¹¶æ²¡æœ‰ renderæ–¹æ³•ã€‚

{% wavy æ‰€ä»¥è¿™ç§æƒ…å†µåœ¨æ‰§è¡ŒinitProxyæ–¹æ³•å¯¹ç›®æ ‡å¯¹è±¡å®ä¾‹ vm è¿›è¡Œä»£ç†æ—¶ï¼Œæ³¨å†Œçš„æ˜¯hasHandleræ–¹æ³•ã€‚%}

hasHandleræ–¹æ³•ä¸­ä½¿ç”¨çš„æ˜¯hasæ•è·å™¨ï¼Œhasæ•è·å™¨ç”¨äºå¤„ç†å±æ€§çš„å­˜åœ¨æ€§æ£€æŸ¥ã€‚

vueåœ¨å¯¹templateé€‰é¡¹è¿›è¡Œæ¨¡æ¿ç¼–è¯‘æ—¶ï¼Œä¼šå°†å…¶è½¬åŒ–ä¸º renderå‡½æ•°ï¼Œä¸”ä¼šè¢« withåŒ…è£¹ã€‚

{% image /assets/topic/vue2/observe/6.png %}

è€Œå‰é¢æˆ‘ä»¬è¯´è¿‡hasæ•è·å™¨å¯ä»¥æ‹¦æˆª withè¯­å¥ä¸‹çš„ä½œç”¨ã€‚åœ¨æ‰§è¡Œ withè¯­å¥çš„è¿‡ç¨‹ä¸­ï¼Œè¯¥ä½œç”¨åŸŸä¸‹çš„å˜é‡éƒ½ä¼šè§¦å‘ hasé’©å­ã€‚è¿™ä¹Ÿæ˜¯æ¨¡ç‰ˆæ¸²æŸ“æ—¶ä¹‹æ‰€ä»¥ä¼šè§¦å‘ä»£ç†æ‹¦æˆªçš„åŸå› ã€‚

### 2.3.2 ä½¿ç”¨.vueæ–‡ä»¶æ¥ç¼–å†™é¡µé¢

è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ç¼–å†™ vueé¡¹ç›®ä¸­æœ€å¸¸ç”¨çš„å†™æ³•ã€‚

{% box child:codeblock color:purple %}
```js
// Test.vue
<template>
  <div>
    {{ msg }}
  </div> 
</template>

<script> 

export default {
  data(){
    return {
      msg: "Hello World"
    }
  }
};
</script>
```
{% endbox %}

.vueæ–‡ä»¶åœ¨webpacké¢„ç¼–è¯‘é˜¶æ®µä¼šè¢« vue-loader è§£ææˆä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­æ¨¡æ¿éƒ¨åˆ†ä¼šè¢«è§£ææˆrenderå‡½æ•°ã€‚

å¹¶ä¸”åœ¨ä¼šåœ¨renderæ–¹æ³•ä¸­æŒ‚è½½_withStrippedä¸ºtrueã€‚

æ‰€ä»¥è¿™ä¸ªå˜é‡æ ‡è¯†ç€å½“å‰çš„ renderå‡½æ•°æ˜¯ä½¿ç”¨.vueæ–‡ä»¶ç¼–å†™ç¼–è¯‘è€Œæ¥çš„ã€‚

{% wavy æ‰€ä»¥è¿™ç§æƒ…å†µåœ¨æ‰§è¡ŒinitProxyæ–¹æ³•å¯¹ç›®æ ‡å¯¹è±¡å®ä¾‹ vm è¿›è¡Œä»£ç†æ—¶ï¼Œæ³¨å†Œçš„æ˜¯getHandleræ–¹æ³•ã€‚%}

getHandleræ–¹æ³•ä¸­ä½¿ç”¨çš„æ˜¯getæ•è·å™¨ï¼Œgetæ•è·å™¨ç”¨äºå¤„ç†å¯¹ Vue å®ä¾‹å±æ€§çš„è¯»å–æ“ä½œã€‚

webpack + vue-loaderå¯¹.vueæ–‡ä»¶è¿›è¡Œç¼–è¯‘æ—¶ï¼Œä¼šè½¬åŒ–æˆä¸‹é¢è¿™ç§å½¢å¼ã€‚

{% image /assets/topic/vue2/observe/7.png %}

å¯ä»¥çœ‹åˆ°ç›´æ¥ä½¿ç”¨ vm.xxx è®¿é—®çš„å±æ€§ã€‚æ‰€ä»¥å¯ä»¥ä½¿ç”¨ getæ•è·å™¨è¿›è¡Œæ•è·ã€‚

### 2.3.3 ç”¨æˆ·è‡ªå®šä¹‰ renderæ–¹æ³•æ¥ç¼–å†™é¡µé¢

{% box child:codeblock color:purple %}
```js
// main.js
import Fun from "./Fun.js"; 
 
new Vue(Fun).$mount("#app");

// fun.js
let Component = {
  render:function(h){
    return h('div',this.msg)
  },
  data(){
    return {
      msg:'Hello World'
    }
  }
}

export default Component;
```
{% endbox %}

è™½ç„¶è¿™ç§æƒ…å†µåœ¨ä¹Ÿå­˜åœ¨ renderæ–¹æ³•ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ _withStripped å±æ€§

{% wavy æ‰€ä»¥è¿™ç§æƒ…å†µåœ¨æ‰§è¡ŒinitProxyæ–¹æ³•å¯¹ç›®æ ‡å¯¹è±¡å®ä¾‹ vm è¿›è¡Œä»£ç†æ—¶ï¼Œæ³¨å†Œçš„æ˜¯hasHandleræ–¹æ³•ã€‚%}

ä½†æ˜¯è‡ªå®šä¹‰ renderçš„æƒ…å†µå¹¶æ²¡æœ‰ä½¿ç”¨ inæˆ–è€… withçš„æƒ…å†µã€‚

æ‰€ä»¥ç”¨æˆ·è‡ªå®šä¹‰çš„æ–¹æ³•ä¸ä¼šæœ‰æŠ¥é”™æç¤ºã€‚

## 2.4 æ•è·å™¨é‡Œé¢çš„å…·ä½“é€»è¾‘

å‰é¢æˆ‘ä»¬è¯´åˆ°äº†ä¸‰ç§æƒ…å†µéƒ½æœ‰å¯¹åº”çš„æ•è·æ–¹æ³•ã€‚

é‚£ä¹ˆè¿™ä¸ªæ•è·æ–¹æ³•å†…éƒ¨ç©¶ç«Ÿåšäº†äº›ä»€ä¹ˆæ“ä½œå‘¢ï¼Ÿ

ä¸»è¦æ˜¯åœ¨å¼€å‘è€…å¼€å‘æ—¶å¯¹å±æ€§å’Œæ–¹æ³•çš„å®šä¹‰åšæç¤ºã€‚

1. å½“å¼€å‘è€…åœ¨æ¸²æŸ“å†…å®¹ä¸­ä½¿ç”¨äº†_ä½œä¸ºå˜é‡åçš„å‰ç¼€æ—¶ï¼Œæç¤ºä¸å¯ä»¥ä½¿ç”¨è¿™ç§å‘½åæ–¹å¼ã€‚å› ä¸ºè¿™ç§æ–¹å¼å¯èƒ½ä¼šä¸å†…éƒ¨çš„å˜é‡å­˜åœ¨å†²çªã€‚
2. å½“å¼€å‘è€…åœ¨æ¸²æŸ“å†…å®¹ä¸­ä½¿ç”¨äº†æœªå®šä¹‰çš„å˜é‡æ—¶ï¼Œæç¤ºè¯¥å˜é‡å¹¶æ²¡æœ‰åœ¨ vueå®ä¾‹ä¸Šæ‰¾åˆ°ã€‚

è€Œå‰é¢æˆ‘ä»¬è¯´åˆ°äº†ç”¨æˆ·è‡ªå®šä¹‰çš„æ–¹æ³•ä¸ä¼šæœ‰æŠ¥é”™æç¤ºã€‚

æˆ‘ä»¬å¯ä»¥å®éªŒä¸€ä¸‹ï¼š

{% box child:codeblock color:purple %}
```js
// main.js
import Fun from "./Fun.js"; 
 
new Vue(Fun).$mount("#app");

// fun.js
let Component = {
  render:function(h){
    // ä½¿ç”¨äº†æœªå®šä¹‰çš„å˜é‡
    return h('div',this.msg1)
  },
  data(){
    return {
      msg:'Hello World'
    }
  }
}

export default Component;
```
{% endbox %}

æˆ‘ä»¬åœ¨renderæ–¹æ³•ä¸­ä½¿ç”¨äº†ä¸€ä¸ªæœªä½¿ç”¨çš„å˜é‡ msg1ã€‚

ç„¶åæ‰“å¼€æ§åˆ¶å°å¹¶æ²¡æœ‰æŠ¥é”™æç¤ºã€‚

å› ä¸ºæ­¤æ—¶ä»£ç†ä½¿ç”¨çš„æ˜¯hasæ•è·å™¨ï¼Œè€Œæˆ‘ä»¬æ—¢æ²¡æœ‰ä½¿ç”¨ withï¼Œä¹Ÿæ²¡ä½¿ç”¨ inã€‚

é‚£ä¹ˆæœ‰æ²¡æœ‰è§£å†³åŠæ³•å‘¢ï¼Ÿ

æœ‰ï¼Œé‚£å°±æ˜¯åœ¨ renderä¸ŠæŒ‚è½½ä¸€ä¸ª_withStrippedå˜é‡ï¼Œè®©ä»–åœ¨ initProxyæ—¶æ³¨å†Œ getæ•è·å™¨ã€‚

{% box child:codeblock color:purple %}
```js
let Component = {
  render:function(h){
    return h('div',this.msg1)
  },
  data(){
    return {
      msg:'Hello World'
    }
  }
}
// åœ¨ renderæ–¹æ³•ä¸­æŒ‚è½½_withStrippedå±æ€§
Component.render._withStripped = true;
export default Component;
```
{% endbox %}

å¯ä»¥çœ‹åˆ°æ§åˆ¶å°å‡ºç°äº†æŠ¥é”™ä¿¡æ¯ã€‚

{% image /assets/topic/vue2/observe/8.png %}

# ä¸‰ã€å®ç°ç®€æ˜“ç‰ˆvueä¾èµ–æ”¶é›†

å› ä¸ºVueä¸­æ•°æ®å“åº”å¼çš„ä»£ç æ¯”è¾ƒå¤šï¼Œæ¶‰åŠå¤šä¸ªæ–‡ä»¶ã€‚

ä½†æ˜¯æˆ‘ä»¬çŸ¥é“æ•°æ®å“åº”å¼çš„åŸç†å°±æ˜¯{% u é¡µé¢æ¸²æŸ“è®¿é—®æ•°æ®æ—¶æ”¶é›†ä¾èµ–ï¼Œåœ¨æ•°æ®æ›´æ–°æ—¶æ›´æ–°å¯¹åº”ä¾èµ–çš„æ¸²æŸ“å†…å®¹ %}ã€‚

{% image /assets/topic/vue2/observe/10.jpg %}

{% box child:codeblock color:purple %}
```js
// =================== æ–°å¢ç‚¹å‡»äº‹ä»¶æ›´æ”¹ ===================
const btnElement = document.createElement('button');
document.body.appendChild(btnElement);
btnElement.innerHTML = 'ç‚¹å‡»';
btnElement.onclick = function(){
    // ç‚¹å‡»äº‹ä»¶
    PageA.msg = 'æˆ‘ä¿®æ”¹äº†'
}

// =================== å¢åŠ å±æ€§ç›‘å¬ ===================
// å­˜å‚¨é¡µé¢çš„ä¾èµ–
let Dep = undefined;
// Aé¡µé¢
let PageA = {
    msg:'Hello World',
    render(){
        const appElement = document.getElementById('app');
        // å½“è®¿é—® msgå˜é‡æ—¶ ä¼šè§¦å‘æ•°æ®ä»£ç†çš„ getæ–¹æ³• è¿›è¡Œä¾èµ–æ”¶é›†
        appElement.innerHTML = this.msg;
    }
}
let pageMsg = PageA.msg;
Object.defineProperty(PageA,'msg',{
    get(){
        //è®¿é—®msgå˜é‡æ—¶æ‰§è¡Œ
        console.log("è®¿é—®äº† msgå˜é‡")
        // å°†ä¾èµ–è®¾ç½®ä¸ºé¡µé¢ A
        Dep = PageA;
        return pageMsg;
    },
    set(newVal){
        //è®¾ç½®msgå˜é‡æ—¶æ‰§è¡Œ
        console.log("è®¾ç½®äº† msgå˜é‡")
        pageMsg = newVal;
        // æ‰§è¡Œä¾èµ–çš„ renderæ–¹æ³•
        Dep.render();
    }
})


// æ‰§è¡Œæ¸²æŸ“å‡½æ•°
PageA.render();
```
{% endbox %}

æŠŠä¸Šé¢çš„ä»£ç æ‹·è´åˆ°æµè§ˆå™¨ä¸­ã€‚

è¿™äº›ä»£ç éå¸¸å¥½ç†è§£ï¼Œä¹Ÿéå¸¸ç®€å•ï¼Œè¿™å°±æ˜¯ Vueä¸­æœ€æ ¸å¿ƒçš„åŸç†å“åº”å¼ã€‚

å¦‚æœä½ å®Œå…¨çœ‹æ‡‚å¹¶èƒ½ç†è§£ä»¥åï¼Œå¯ä»¥è¯´ä½ å°±æŒæ¡äº† Vueçš„å“åº”å¼æ ¸å¿ƒåŸç†ã€‚

# å››ã€åˆå§‹åŒ–æ—¶å¢åŠ ä¾¦å¬å™¨çš„é€»è¾‘

## 4.1 initData

ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬ç®€å•çš„å®ç°äº†æ•°æ®å“åº”ã€‚

æˆ‘ä»¬çŸ¥é“æ•°æ®å“åº”çš„å‰ææ˜¯æ•°æ®è¢«ä»£ç†äº†ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°æ®è¢« Object.defineProperty è®¾ç½®äº†ä¾¦å¬ã€‚

è¿™æ ·åœ¨æ•°æ®è¢«è®¿é—®å’Œè®¾ç½®çš„æ—¶å€™æ‰èƒ½çŸ¥æ™“ä»è€Œè§¦å‘å¯¹åº”çš„æ“ä½œã€‚

Vueé€‰é¡¹ä¸­çš„ dataå°±æ˜¯åœ¨ vueå®ä¾‹åŒ–åˆå§‹åŒ–çš„æ—¶å€™åœ¨initDataä¸­è®¾ç½®ç›‘å¬çš„ã€‚

{% box child:codeblock color:purple %}
```js 
function initData(vm){ 
    let data = vm.$options.data; 
    data = vm._data = isFunction(data) ? getData(data, vm) : data || {};
    // å¦‚æœä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿›è¡Œæç¤º
    if (!isPlainObject(data)) {
        data = {}
        __DEV__ &&
        warn(
            'data functions should return an object:\n' +
            'https://v2.vuejs.org/v2/guide/components.html#data-Must-Be-a-Function',
            vm
        )
    }
    // proxy data on instance
    const keys = Object.keys(data)
    const props = vm.$options.props
    const methods = vm.$options.methods
    let i = keys.length
    while (i--) {
        const key = keys[i]
        if (__DEV__) {
            if (methods && hasOwn(methods, key)) {
                warn(`Method "${key}" has already been defined as a data property.`, vm)
            }
        }
        if (props && hasOwn(props, key)) {
            __DEV__ &&
                warn(
                `The data property "${key}" is already declared as a prop. ` +
                    `Use prop default value instead.`,
                vm
                )
        } else if (!isReserved(key)) {
            proxy(vm, `_data`, key)
        }
    }
    const ob = observe(data)
    ob && ob.vmCount++
}
```
{% endbox %}

initDataåœ¨ mergeOptionsåé¢æ‰§è¡Œï¼Œæ‰€ä»¥æ­¤æ—¶å¯ä»¥åœ¨ vm.$optionsä¸Šè·å–åˆ° dataã€‚

### 4.1.1 ç¼–å†™dataçš„ 2 ç§å½¢å¼

æˆ‘ä»¬çŸ¥é“é€šå¸¸æˆ‘ä»¬ç¼–å†™ dataæœ‰ 2 ç§å½¢å¼ï¼š

{% box child:codeblock color:purple %}
```js 
// ç›´æ¥ç¼–å†™å¯¹è±¡
data:{
    msg:'Hello World'
}

// ç¼–å†™ä¸€ä¸ªå‡½æ•°
data(){
    return {
        msg:"Hello World"
    }
}
```
{% endbox %}

æ‰€ä»¥è¿™é‡Œåˆ¤æ–­æ˜¯å¦æ˜¯å‡½æ•°ç”¨æ¥æ‰§è¡Œä¸åŒçš„é€»è¾‘è·å– data:

1. å¦‚æœæ˜¯å‡½æ•°ï¼Œæ‰§è¡ŒgetDataæ¥è·å– data
2. å¦‚æœä¸æ˜¯å‡½æ•°ï¼Œè¿™ç›´æ¥è·å– data

{% box child:codeblock color:purple %}
```js 
let data = vm.$options.data; 
data = vm._data = isFunction(data) ? getData(data, vm) : data || {};

// å°†å½“å‰ä¾èµ–å˜æˆ undefinedï¼Œåœ¨æ”¶é›†ä¾èµ–æ—¶å°±å¯ä»¥åˆ¤æ–­æ˜¯å¦æ˜¯ç©ºçš„ å¦‚æœæ˜¯ç©ºçš„å°±ä¸è¿›è¡Œä¾èµ–æ”¶é›†
export function getData(data: Function, vm: Component): any {
  // #7573 disable dep collection when invoking data getters
  pushTarget()
  try {
    return data.call(vm, vm)
  } catch (e: any) {
    handleError(e, vm, `data()`)
    return {}
  } finally {
    popTarget()
  }
}
```
{% endbox %}

### 4.1.2 åˆ¤æ–­ dataæ˜¯å¦æ˜¯å¯¹è±¡

{% box child:codeblock color:purple %}
```js 
if (!isPlainObject(data)) {
    data = {}
    __DEV__ &&
      warn(
        'data functions should return an object:\n' +
          'https://v2.vuejs.org/v2/guide/components.html#data-Must-Be-a-Function',
        vm
      )
}
```
{% endbox %}

isPlainObjectå‡½æ•°ç”¨äºåˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚

å¦‚æœ dataä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™æç¤ºåº”è¯¥è¿”å›ä¸€ä¸ªå¯¹è±¡ã€‚


### 4.1.3 åˆ¤æ–­ä¸èƒ½ä¸methods/propsé‡å

{% box child:codeblock color:purple %}
```js 
const keys = Object.keys(data)
const props = vm.$options.props
const methods = vm.$options.methods
let i = keys.length
while (i--) {
    const key = keys[i]
    if (__DEV__) {
      if (methods && hasOwn(methods, key)) {
        warn(`Method "${key}" has already been defined as a data property.`, vm)
      }
    }
    if (props && hasOwn(props, key)) {
      __DEV__ &&
        warn(
          `The data property "${key}" is already declared as a prop. ` +
            `Use prop default value instead.`,
          vm
        )
    } else if (!isReserved(key)) {
      proxy(vm, `_data`, key)
    }
}
```
{% endbox %}

é¦–å…ˆä½¿ç”¨ Object.keysè·å–æ‰€æœ‰dataçš„æ•°é‡ã€‚

ç„¶åä½¿ç”¨ whileå¾ªç¯å°†æ‰€æœ‰ dataä¸­çš„keyå€¼å’Œ props/methodsåšæ¯”è¾ƒã€‚

å¦‚æœæœ‰é‡åçš„åˆ™ç»™äºˆæç¤ºã€‚

### 4.1.4 ç»™ dataä¸­æ¯ä¸€é¡¹éƒ½è®¾ç½®ä»£ç†

{% box child:codeblock color:purple %}
```js
// å¦‚æœä¸æ˜¯å…³é”®å­—ï¼Œåˆ™å¯¹ vm._dataè¿›è¡Œä¿ç•™
if (!isReserved(key)) {
    proxy(vm, `_data`, key)
}

const sharedPropertyDefinition = {
  enumerable: true,
  configurable: true,
  get: noop,
  set: noop
}


export function proxy(target: Object, sourceKey: string, key: string) {
  sharedPropertyDefinition.get = function proxyGetter() {
    return this[sourceKey][key]
  }
  sharedPropertyDefinition.set = function proxySetter(val) {
    this[sourceKey][key] = val
  }
  Object.defineProperty(target, key, sharedPropertyDefinition)
}
```
{% endbox %}

å‰é¢æˆ‘ä»¬å°†dataèµ‹å€¼ç»™äº†vm._dataã€‚

æ‰€ä»¥è¿™é‡Œä»£ç†çš„æ„æ€å°±æ˜¯ï¼Œæ¯å½“ä½ ä½¿ç”¨ this.xxxæ¥è®¿é—®dataä¸­çš„å±æ€§æ—¶ï¼Œä¼šç›´æ¥åœ¨ vm._dataä¸Šé¢è¿›è¡ŒæŸ¥æ‰¾è¿”å›ã€‚

è¿™æ ·å°±ä¸ç”¨å°†dataä¸­çš„æ¯ä¸€é¡¹éƒ½æŒ‚è½½åˆ°å®ä¾‹ä¸Šäº†ã€‚

### 4.1.5 å¯¹dataè¿›è¡Œä¾¦å¬

æ¥ä¸‹æ¥å°±æ˜¯é‡å¤´æˆäº†ï¼Œå‰é¢æˆ‘ä»¬è¯´åˆ°vueåœ¨åˆå§‹åŒ–æ—¶ä¼šå¯¹ dataä¸­çš„æ¯ä¸€é¡¹è¿›è¡Œä¾¦å¬ã€‚

å°±æ˜¯ä½¿ç”¨ observeæ–¹æ³•è¿›è¡Œä¾¦å¬çš„ã€‚

{% box child:codeblock color:purple %}
```js
const ob = observe(data); 
```
{% endbox %}
observe æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºå°†ä¸€ä¸ªæ™®é€šçš„ JavaScript å¯¹è±¡æˆ–æ•°ç»„è½¬æ¢ä¸ºå“åº”å¼å¯¹è±¡ã€‚å®ƒä¼šé€’å½’åœ°éå†å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œå¹¶å°†å®ƒä»¬è½¬æ¢ä¸º getter/setterï¼Œä»¥ä¾¿ Vue èƒ½å¤Ÿè·Ÿè¸ªå±æ€§çš„å˜åŒ–ã€‚

å¯ä»¥çœ‹åˆ°observeå°±æ˜¯å®ä¾‹åŒ–äº†ä¸€ä¸ª Observerçš„ç±»ã€‚

## 4.2 Observerç±»ä¸­è®¾ç½®ä¾¦å¬

{% box child:codeblock color:purple %}
```js
export function observe(
    value,
    shallow,
    ssrMockReactivity
){
  if (value && hasOwn(value, '__ob__') && value.__ob__ instanceof Observer) {
    return value.__ob__
  }
  if (
    shouldObserve &&
    (ssrMockReactivity || !isServerRendering()) &&
    (isArray(value) || isPlainObject(value)) &&
    Object.isExtensible(value) &&
    !value.__v_skip /* ReactiveFlags.SKIP */ &&
    !isRef(value) &&
    !(value instanceof VNode)
  ) {
    return new Observer(value, shallow, ssrMockReactivity)
  }
}
```
{% endbox %}

ä¸ŠèŠ‚æˆ‘ä»¬è¯´åˆ°åœ¨initDataä¸­ä¼šè°ƒç”¨observeæ–¹æ³•ç»™dataè®¾ç½®ä¾¦å¬ã€‚

å¦‚ä¸Šæ‰€ç¤ºï¼Œobserveä¸­å®é™…ä¸Šå°±æ˜¯å®ä¾‹åŒ–äº† Observerç±»ã€‚

{% box child:codeblock color:purple %}
```js
export class Observer {
  // ä¸€ä¸ª Dep å®ä¾‹ï¼Œç”¨äºä¾èµ–æ”¶é›†ï¼Œå³è·Ÿè¸ªå“ªäº› watcher ä¾èµ–äºè¯¥å¯¹è±¡çš„æ•°æ®å˜åŒ–ã€‚
  dep: Dep
  // è®°å½•æœ‰å¤šå°‘ä¸ª Vue å®ä¾‹å°†è¿™ä¸ªå¯¹è±¡ä½œä¸ºå®ƒä»¬çš„æ ¹ $dataã€‚
  vmCount: number // number of vms that have this object as root $data

  constructor(public value: any, public shallow = false, public mock = false) {
    // this.value = value
    this.dep = mock ? mockDep : new Dep()
    this.vmCount = 0
    def(value, '__ob__', this)
    if (isArray(value)) {
      if (!mock) {
        if (hasProto) {
          /* eslint-disable no-proto */
          ;(value as any).__proto__ = arrayMethods
          /* eslint-enable no-proto */
        } else {
          for (let i = 0, l = arrayKeys.length; i < l; i++) {
            const key = arrayKeys[i]
            def(value, key, arrayMethods[key])
          }
        }
      }
      if (!shallow) {
        this.observeArray(value)
      }
    } else {
      /**
       * Walk through all properties and convert them into
       * getter/setters. This method should only be called when
       * value type is Object.
       */
      const keys = Object.keys(value)
      for (let i = 0; i < keys.length; i++) {
        const key = keys[i]
        defineReactive(value, key, NO_INITIAL_VALUE, undefined, shallow, mock)
      }
    }
  }

  /**
   * Observe a list of Array items.
   */
  observeArray(value: any[]) {
    for (let i = 0, l = value.length; i < l; i++) {
      observe(value[i], false, this.mock)
    }
  }
}
```
{% endbox %}

è¿™ä¸ª Observer ç±»æ˜¯ Vue.js å“åº”å¼ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå°†æ™®é€šçš„ JavaScript å¯¹è±¡æˆ–æ•°ç»„è½¬æ¢ä¸ºå“åº”å¼å¯¹è±¡ã€‚

### 4.2.1 ä¸‰ä¸ªå‚æ•° 

1. valueï¼šå®ƒå¿…é¡»æ˜¯ä¸€ä¸ªæ•°ç»„æˆ–è€…å¯¹è±¡ã€‚Observeç±»ä¼šå°†è¿™ä¸ªå€¼è½¬æ¢ä¸ºå“åº”å¼å¯¹è±¡ï¼Œä½¿å¾— Vueèƒ½å¤Ÿè·Ÿè¸ªå…¶å±æ€§çš„å˜åŒ–å¹¶æ›´æ–°è§†å›¾ã€‚
2. shallowï¼šè¿™æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦è¿›è¡Œæµ…å±‚å“åº”å¼è½¬æ¢ã€‚å¦‚æœ shallow ä¸º trueï¼Œåˆ™ Observer åªä¼šå¯¹å¯¹è±¡çš„ç›´æ¥å±æ€§è¿›è¡Œå“åº”å¼è½¬æ¢ï¼Œè€Œä¸ä¼šé€’å½’åœ°å¯¹å…¶åµŒå¥—å¯¹è±¡çš„å±æ€§è¿›è¡Œå“åº”å¼è½¬æ¢ã€‚
3. mockï¼šè¿™ä¸ªå‚æ•°ä¹Ÿæ˜¯å¸ƒå°”ç±»å‹ï¼Œç”¨äºæŒ‡ç¤ºæ˜¯å¦åœ¨æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰ç¯å¢ƒä¸‹æ¨¡æ‹Ÿå“åº”å¼è¡Œä¸ºã€‚å½“ mock ä¸º true æ—¶ï¼ŒObserver ä¼šä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„ Dep å®ä¾‹ï¼ˆmockDepï¼‰ï¼Œä»¥ä¾¿åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶ä¸ä¼šå®é™…è§¦å‘è§†å›¾æ›´æ–°ã€‚

### 4.2.2 ç±»æˆå‘˜

1. dep: Depï¼šæ¯ä¸ªObserverå®ä¾‹éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å…³è”çš„Depå®ä¾‹ã€‚Depä»£è¡¨â€œDependencyâ€ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰ä¾èµ–äºè¯¥Observerå®ä¾‹çš„è§‚å¯Ÿè€…ï¼ˆå¦‚è®¡ç®—å±æ€§æˆ–æ¸²æŸ“å‡½æ•°ï¼‰ã€‚
2. vmCount: numberï¼šè¡¨ç¤ºæœ‰å¤šå°‘ä¸ªVueå®ä¾‹å°†æ­¤å¯¹è±¡ä½œä¸ºæ ¹$dataå¯¹è±¡ã€‚è¿™æœ‰åŠ©äºVueå†…éƒ¨ç®¡ç†æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸã€‚

### 4.2.3 æ„é€ å‡½æ•°å†…éƒ¨é€»è¾‘

1. åˆå§‹åŒ–ä¾èµ–ï¼šå¦‚æœå¤„äº ssræ¸²æŸ“æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ä¼ å…¥çš„ mockDepï¼Œå¦åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ Depå®ä¾‹ã€‚
2. å®šä¹‰è§‚æµ‹æ ‡è¯†ï¼šdefæ˜¯ definePropertyçš„å°è£…å‡½æ•°ï¼Œé€šè¿‡defæ–¹æ³•ç»™valueå¯¹è±¡æ·»åŠ ä¸€ä¸ªä¸å¯æšä¸¾çš„å±æ€§__ob__ï¼Œå…¶å€¼ä¸ºå½“å‰Observerå®ä¾‹ã€‚è¿™æ˜¯Vueå†…éƒ¨ç”¨æ¥åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å·²ç»è¢«è§‚æµ‹è¿‡çš„æ–¹å¼ã€‚
3. å¤„ç†æ•°ç»„ï¼šå¦‚æœvalueæ˜¯ä¸€ä¸ªæ•°ç»„ä¸”ä¸æ˜¯æ¨¡æ‹Ÿæ¨¡å¼ï¼š
    * å¦‚æœç¯å¢ƒæ”¯æŒ__proto__ï¼Œåˆ™å°†æ•°ç»„çš„æ–¹æ³•æŒ‡å‘arrayMethodsï¼Œè¿™æ˜¯ä¸€ä¸ªç»è¿‡ä¿®æ”¹çš„æ•°ç»„åŸå‹æ–¹æ³•é›†åˆï¼Œç”¨äºæ‹¦æˆªæ•°ç»„çš„å˜å¼‚æ–¹æ³•ï¼ˆå¦‚push, popç­‰ï¼‰ã€‚
    * å¦‚æœä¸æ”¯æŒ__proto__ï¼Œåˆ™æ‰‹åŠ¨éå†arrayKeysï¼Œå¹¶ç”¨defæ–¹æ³•è¦†ç›–åŸç”Ÿæ•°ç»„æ–¹æ³•ï¼Œä½¿å…¶æŒ‡å‘arrayMethodsä¸­çš„å¯¹åº”æ–¹æ³•ã€‚
    * å¦‚æœä¸æ˜¯æµ…å±‚è§‚æµ‹ï¼Œåˆ™è°ƒç”¨observeArrayæ–¹æ³•é€’å½’åœ°è§‚æµ‹æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ã€‚
4. å¤„ç†å¯¹è±¡ï¼šå¦‚æœvalueæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™éå†å¯¹è±¡çš„æ‰€æœ‰é”®ï¼Œå¹¶å¯¹æ¯ä¸ªé”®è°ƒç”¨defineReactiveæ–¹æ³•æ¥è½¬æ¢æˆgetter/setterå½¢å¼ï¼Œä»è€Œå®ç°å“åº”å¼ã€‚

## 4.3 defineReactiveå®šä¹‰å“åº”å¼

è°ƒç”¨ Observer æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨ defineReactiveæ–¹æ³•å¯¹ dataä¸­çš„æ¯ä¸€é¡¹è¿›è¡Œæ·»åŠ ä¾¦å¬ã€‚

{% box child:codeblock color:purple %}
```js
export function defineReactive(
  obj: object,
  key: string,
  val?: any,
  customSetter?: Function | null,
  shallow?: boolean,
  mock?: boolean,
  observeEvenIfShallow = false
) {
  const dep = new Dep()

  const property = Object.getOwnPropertyDescriptor(obj, key)
  if (property && property.configurable === false) {
    return
  }

  // cater for pre-defined getter/setters
  const getter = property && property.get
  const setter = property && property.set
  if (
    (!getter || setter) &&
    (val === NO_INITIAL_VALUE || arguments.length === 2)
  ) {
    val = obj[key]
  }

  let childOb = shallow ? val && val.__ob__ : observe(val, false, mock)
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter() {
      const value = getter ? getter.call(obj) : val
      if (Dep.target) {
        if (__DEV__) {
          dep.depend({
            target: obj,
            type: TrackOpTypes.GET,
            key
          })
        } else {
          dep.depend()
        }
        if (childOb) {
          childOb.dep.depend()
          if (isArray(value)) {
            dependArray(value)
          }
        }
      }
      return isRef(value) && !shallow ? value.value : value
    },
    set: function reactiveSetter(newVal) {
      const value = getter ? getter.call(obj) : val
      if (!hasChanged(value, newVal)) {
        return
      }
      if (__DEV__ && customSetter) {
        customSetter()
      }
      if (setter) {
        setter.call(obj, newVal)
      } else if (getter) {
        // #7981: for accessor properties without setter
        return
      } else if (!shallow && isRef(value) && !isRef(newVal)) {
        value.value = newVal
        return
      } else {
        val = newVal
      }
      childOb = shallow ? newVal && newVal.__ob__ : observe(newVal, false, mock)
      if (__DEV__) {
        dep.notify({
          type: TriggerOpTypes.SET,
          target: obj,
          key,
          newValue: newVal,
          oldValue: value
        })
      } else {
        dep.notify()
      }
    }
  })

  return dep
}
```
{% endbox %}

### 4.3.1 åˆ›å»ºä¾èµ–

é¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Depå®ä¾‹ dep,ç”¨äºå­˜å‚¨æ‰€æœ‰ä¾èµ–äºè¯¥å±æ€§çš„è§‚å¯Ÿè€…ã€‚

åœ¨Observerçš„æ„é€ å‡½æ•°ä¸­ï¼Œä¼šéå†å¯¹è±¡ä¸­çš„æ¯ä¸€ä¸ªå±æ€§ï¼Œå¹¶å¯¹æ¯ä¸€ä¸ªå±æ€§æ‰§è¡ŒdefineReactiveã€‚

æ‰€ä»¥è¯´æ¯ä¸€ä¸ªå®šä¹‰åœ¨ dataä¸­çš„æ¯ä¸€ä¸ªå±æ€§éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„ä¾èµ–åˆ—è¡¨ï¼Œè®°å½•ç€å½“ dataå˜åŒ–æ—¶éœ€è¦æ›´æ–°çš„ä¾èµ–ã€‚

{% box child:codeblock color:purple %}
```js
export function defineReactive(
  obj: object,
  key: string,
  val?: any,
  customSetter?: Function | null,
  shallow?: boolean,
  mock?: boolean,
  observeEvenIfShallow = false
) {
  const dep = new Dep()
}
```
{% endbox %}

### 4.3.2 æ£€æŸ¥å±æ€§é…ç½®

{% box child:codeblock color:purple %}
```js
const property = Object.getOwnPropertyDescriptor(obj, key)
if (property && property.configurable === false) {
    return
}
```
{% endbox %}

å› ä¸ºåé¢çš„é€»è¾‘æ˜¯ç»™è¿™ä¸ªå¯¹è±¡è®¾ç½®ä»£ç†ï¼ˆObject.definePropertyï¼‰ã€‚

getOwnPropertyDescriptorå¯ä»¥è·å–å¯¹è±¡ä¸Šçš„å±æ€§æè¿°ç¬¦ã€‚

å¦‚æœè¯¥å±æ€§ä¸å¯é…ç½®ï¼Œå°±ä¸å¯ä»¥å†é…ç½® Object.definePropertyäº†ï¼Œæ‰€ä»¥å¦‚æœ configurableä¸º false,ç›´æ¥è¿”å›ï¼Œä¸åšä»»ä½•å¤„ç†ã€‚

### 4.3.3 ç”¨äºå¤„ç†å¯¹è±¡å±æ€§çš„ getter å’Œ setter

{% box child:codeblock color:purple %}
```js
const getter = property && property.get
const setter = property && property.set
if (
    (!getter || setter) &&
    (val === NO_INITIAL_VALUE || arguments.length === 2)
) {
    val = obj[key]
}
```
{% endbox %}


1. å°è¯•ä»å¯¹è±¡çš„å±æ€§æè¿°ç¬¦ï¼ˆpropertyï¼‰ä¸­è·å–ç°æœ‰çš„ getter å’Œ setter å‡½æ•°ã€‚å¦‚æœ property å­˜åœ¨ä¸”æœ‰ get æ–¹æ³•ï¼Œåˆ™ getter ä¼šè¢«è®¾ç½®ä¸ºè¯¥æ–¹æ³•ï¼›åŒç†ï¼Œå¦‚æœ property å­˜åœ¨ä¸”æœ‰ set æ–¹æ³•ï¼Œåˆ™ setter ä¼šè¢«è®¾ç½®ä¸ºè¯¥æ–¹æ³•ã€‚
2. å¦‚æœæ»¡è¶³ä¸‹åˆ—ä¸¤ç§æƒ…å†µï¼Œåˆ™å°† valè®¾ç½®ä¸ºå¯¹è±¡ä¸Šå½“å‰å±æ€§çš„å€¼ï¼Œå³ obj[key]ã€‚è¿™æ„å‘³ç€å¦‚æœå±æ€§å·²ç»æœ‰ getter/setter æˆ–è€…æ²¡æœ‰æä¾›åˆå§‹å€¼ï¼ŒVue å°†ä¸ä¼šå°è¯•è¦†ç›–è¿™äº›å±æ€§ï¼Œè€Œæ˜¯ä½¿ç”¨å¯¹è±¡ä¸Šå·²ç»å­˜åœ¨çš„å€¼ã€‚
 * æ£€æŸ¥æ˜¯å¦å­˜åœ¨ setteræˆ–è€…ä¸å­˜åœ¨ getterã€‚å¦‚æœå±æ€§å·²ç»æœ‰ setter(æˆ–è€…æ²¡æœ‰ getter)ï¼Œè¿™æ„å‘³ç€å±æ€§å¯èƒ½å·²ç»è¢«å®šä¹‰ä¸ºå…·æœ‰è‡ªå®šä¹‰è¡Œä¸ºçš„å±æ€§ï¼Œå› æ­¤ Vueä¸ä¼šè¦†ç›–å®ƒã€‚{% u (å‰é¢æˆ‘ä»¬ä½¿ç”¨è¿‡ proxyå¯¹ vmä¸Šçš„å±æ€§åšè¿‡ä»£ç†ï¼Œè€Œè¿™é‡Œæ˜¯å¯¹ dataä¸­çš„æ•°æ®åšä»£ç†ï¼Œæ‰€ä»¥ä½œç”¨ç‚¹ä¸åŒ) %}
 * æ£€æŸ¥ä¼ å…¥çš„ val æ˜¯å¦æ˜¯ NO_INITIAL_VALUEï¼ˆä¸€ä¸ªç‰¹æ®Šçš„å€¼ï¼Œè¡¨ç¤ºæ²¡æœ‰åˆå§‹å€¼ï¼‰æˆ–è€…è°ƒç”¨ defineReactive æ—¶åªæä¾›äº†ä¸¤ä¸ªå‚æ•°ï¼ˆå³æ²¡æœ‰æä¾› setter å€¼ï¼‰

> è¿™æ®µä»£ç çš„ç›®çš„æ˜¯å¤„ç†é‚£äº›å¯èƒ½å·²ç»æœ‰é¢„å®šä¹‰ getter/setter çš„å±æ€§ã€‚åœ¨ Vue çš„å“åº”å¼ç³»ç»Ÿä¸­ï¼Œå½“ä½ å°è¯•å°†ä¸€ä¸ªå±æ€§è½¬æ¢ä¸ºå“åº”å¼æ—¶ï¼Œå¦‚æœè¯¥å±æ€§å·²ç»æœ‰ getter/setterï¼ŒVue é€šå¸¸ä¸ä¼šè¦†ç›–å®ƒä»¬ï¼Œé™¤éä½ æ˜ç¡®æä¾›äº†ä¸€ä¸ªæ–°çš„å€¼ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†é¿å…ç ´åå·²ç»å­˜åœ¨çš„å±æ€§è¡Œä¸ºã€‚

### 4.3.4 è§‚æµ‹å­å±æ€§

{% box child:codeblock color:purple %}
```js
let childOb = shallow ? val && val.__ob__ : observe(val, false, mock)
```
{% endbox %}

* shallow æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼å‚æ•°ï¼Œè¡¨ç¤ºæ˜¯å¦è¿›è¡Œæµ…å±‚å“åº”å¼è½¬æ¢ã€‚å¦‚æœä¸º trueï¼Œåˆ™åªå¯¹å¯¹è±¡çš„ç›´æ¥å±æ€§è¿›è¡Œå“åº”å¼è½¬æ¢ï¼Œè€Œä¸é€’å½’åœ°å¯¹å…¶åµŒå¥—å¯¹è±¡çš„å±æ€§è¿›è¡Œå“åº”å¼è½¬æ¢ã€‚é»˜è®¤ä¸ºfalseï¼Œå³é€’å½’çš„å¯¹åµŒå¥—å¯¹è±¡çš„å±æ€§è¿›è¡Œå“åº”å¼è½¬æ¢ã€‚

* valæ˜¯å½“å‰æ­£åœ¨å¤„ç†çš„å¯¹è±¡å±æ€§çš„å€¼ã€‚

* val.__ob__æ˜¯ä¸€ä¸ªæ£€æŸ¥ï¼Œç”¨äºç¡®å®š val æ˜¯å¦å·²ç»è¢« Vue çš„å“åº”å¼ç³»ç»Ÿè½¬æ¢è¿‡ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡å·²ç»è¢«è½¬æ¢ä¸ºå“åº”å¼å¯¹è±¡ï¼ŒVue ä¼šåœ¨è¯¥å¯¹è±¡ä¸Šæ·»åŠ ä¸€ä¸ª __ob__ å±æ€§ï¼Œå…¶å€¼ä¸ºå¯¹åº”çš„ Observer å®ä¾‹ã€‚

> è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æ ¹æ® shallow å‚æ•°çš„å€¼æ¥å†³å®šæ˜¯å¦éœ€è¦å¯¹å¯¹è±¡çš„å€¼è¿›è¡Œé€’å½’çš„å“åº”å¼è½¬æ¢ã€‚å¦‚æœ shallow ä¸º trueï¼Œåˆ™åªä½¿ç”¨ç°æœ‰çš„å“åº”å¼å¯¹è±¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å“åº”å¼å¯¹è±¡ã€‚è¿™ç§æ–¹å¼å…è®¸ Vue åœ¨ä¸åŒåœºæ™¯ä¸‹çµæ´»åœ°å¤„ç†å¯¹è±¡çš„å“åº”å¼è½¬æ¢ï¼ŒåŒæ—¶é¿å…äº†ä¸å¿…è¦çš„æ€§èƒ½å¼€é”€ã€‚

### 4.3.5 å®šä¹‰ getter å’Œ setter

{% box child:codeblock color:purple %}
```js
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter() {
      const value = getter ? getter.call(obj) : val
      if (Dep.target) {
        if (__DEV__) {
          dep.depend({
            target: obj,
            type: TrackOpTypes.GET,
            key
          })
        } else {
          dep.depend()
        }
        if (childOb) {
          childOb.dep.depend()
          if (isArray(value)) {
            dependArray(value)
          }
        }
      }
      return isRef(value) && !shallow ? value.value : value
    },
    set: function reactiveSetter(newVal) {
      const value = getter ? getter.call(obj) : val
      if (!hasChanged(value, newVal)) {
        return
      }
      if (__DEV__ && customSetter) {
        customSetter()
      }
      if (setter) {
        setter.call(obj, newVal)
      } else if (getter) {
        // #7981: for accessor properties without setter
        return
      } else if (!shallow && isRef(value) && !isRef(newVal)) {
        value.value = newVal
        return
      } else {
        val = newVal
      }
      childOb = shallow ? newVal && newVal.__ob__ : observe(newVal, false, mock)
      if (__DEV__) {
        dep.notify({
          type: TriggerOpTypes.SET,
          target: obj,
          key,
          newValue: newVal,
          oldValue: value
        })
      } else {
        dep.notify()
      }
    }
  })
    function dependArray(value: Array<any>) {
        for (let e, i = 0, l = value.length; i < l; i++) {
            e = value[i]
            if (e && e.__ob__) {
                e.__ob__.dep.depend()
            }
            if (isArray(e)) {
                dependArray(e)
            }
        }
    }
```
{% endbox %}

#### 4.3.5.1 getterå‡½æ•°

åœ¨Vueæ‰§è¡Œæ¸²æŸ“æ—¶ï¼Œä¼šè®¿é—® dataä¸­çš„å±æ€§ï¼Œä»è€Œæ‰§è¡Œè¿™é‡Œå®šä¹‰çš„ reactiveGetteræ–¹æ³•ã€‚

å¦‚æœå­˜åœ¨åŸå§‹çš„ getterï¼ˆæ•°æ®ä» Object.definePropertyå®šä¹‰ï¼‰ï¼Œåˆ™è°ƒç”¨å®ƒã€‚å¦åˆ™ï¼Œè¿”å›å±æ€§çš„å€¼ valã€‚

Dep.Targetæ˜¯ä¸€ä¸ªå…¨å±€å±æ€§ï¼Œå› ä¸ºæ¯æ¬¡åªèƒ½åŒæ—¶æ‰§è¡Œä¸€æ¬¡æ¸²æŸ“ï¼Œæ¯æ¬¡æ¸²æŸ“æ—¶éƒ½ä¼šå¯¹åº”ä¸€ä¸ª Watcherå®ä¾‹ã€‚

åœ¨æ¯æ¬¡æ¸²æŸ“å‰éƒ½ä¼šå°† Dep.Targetè®¾ç½®ä¸ºå½“å‰çš„è¿™ä¸ª Watcherå®ä¾‹ï¼Œç„¶ååœ¨æ¸²æŸ“åä¼šå°† Dep.Targetè®¾ç½®ä¸ºç©ºã€‚

æ‰€ä»¥è¿™ä¸ª Dep.TargetæŒ‡çš„å°±æ˜¯å½“å‰æ¸²æŸ“å¯¹åº”çš„é‚£ä¸ª Watcherå®ä¾‹ã€‚

æ­¤æ—¶è°ƒç”¨dep.dependæ”¶é›†ä¾èµ–ã€‚

å¦‚æœæœ‰å­å±æ€§ï¼Œåˆ™è°ƒç”¨å­å±æ€§çš„ dep.dependæ–¹æ³•ã€‚

å¦‚æœå±æ€§å€¼æ˜¯æ•°ç»„ï¼Œé€’å½’åœ°ä¾èµ–æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ã€‚

æœ€åï¼Œå¦‚æœå±æ€§å€¼æ˜¯ä¸€ä¸ª ref å¯¹è±¡ï¼ˆVue 3 å¼•å…¥çš„å“åº”å¼å¼•ç”¨ç±»å‹ï¼‰ï¼Œå¹¶ä¸”ä¸æ˜¯æµ…å±‚å“åº”å¼ï¼Œåˆ™è¿”å›å…¶å†…éƒ¨å€¼ï¼›å¦åˆ™è¿”å›åŸå§‹å€¼ã€‚

### 4.3.5.2 setterå‡½æ•°

å½“å±æ€§è¢«é‡æ–°èµ‹å€¼æ—¶ï¼Œå¦‚ {% u this.xxxx = 'xxx' %}ã€‚ä¼šæ‰§è¡Œ reactiveSetter æ–¹æ³•ã€‚

å¦‚æœæ–°å€¼ä¸æ—§å€¼ç›¸åŒï¼Œåˆ™ä¸è¿›è¡Œä»»ä½•æ“ä½œã€‚

åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œå¦‚æœæä¾›äº†è‡ªå®šä¹‰çš„ setterï¼Œåˆ™è°ƒç”¨å®ƒã€‚

å¦‚æœå­˜åœ¨åŸå§‹çš„ setterï¼Œåˆ™è°ƒç”¨å®ƒã€‚

å¦‚æœæ²¡æœ‰ setter ä½†æœ‰ getterï¼Œä¸è¿›è¡Œä»»ä½•æ“ä½œï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªåªè¯»å±æ€§ã€‚

å¦‚æœå±æ€§å€¼æ˜¯ ref å¯¹è±¡ï¼Œå¹¶ä¸”ä¸æ˜¯æµ…å±‚å“åº”å¼ï¼Œåˆ™æ›´æ–°å…¶å†…éƒ¨å€¼ã€‚

å¦åˆ™ï¼Œç›´æ¥æ›´æ–°å±æ€§çš„å€¼ã€‚

å› ä¸ºå€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œæ‰€ä»¥éœ€è¦å†æ¬¡è®¾ç½®æ–°å€¼ä¸ºå“åº”å¼ã€‚

æœ€åé€šçŸ¥æ‰€æœ‰ä¾èµ–äºè¯¥å±æ€§çš„ watcherï¼Œå±æ€§å€¼å·²æ”¹å˜ã€‚

ç„¶åå†æ¬¡æ‰§è¡Œæ¸²æŸ“æ“ä½œã€‚

## 4.4 æ€»ç»“

åœ¨å‰é¢çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬å¸¦å¤§å®¶çœ‹äº† vue æ˜¯å¦‚ä½•è®¾ç½®ä¾¦å¬çš„ã€‚

ä¸»è¦æ˜¯é€šè¿‡ observeæ¥å°†æ•°æ®è®¾ç½®ä¸ºå“åº”å¼ã€‚

{% image /assets/topic/vue2/observe/11.jpg %}

# äº”ã€æ•°æ®å“åº”å¼çš„æ ¸å¿ƒæ¨¡å—

ç»è¿‡å‰é¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“:

1. Vueä¸­æ¯ä¸€ä¸ª dataä¸­éƒ½ç»‘å®šäº†ä¸€ä¸ªå¯¹åº”çš„ä¾èµ–åˆ—è¡¨ã€‚
2. Vueä¸­æ¯ä¸€æ¬¡ æ¸²æŸ“éƒ½å¯¹åº”ç€ä¸€ä¸ª Watcherå®ä¾‹ï¼Œè¿™ä¸ª Watcherå®ä¾‹ä¸Šå­˜å‚¨ç€å¯ä»¥æ‰§è¡Œè¿™æ¬¡æ¸²æŸ“çš„æ–¹æ³•ã€‚

Vueå®ç°æ•°æ®å“åº”å¼å°±æ˜¯é€šè¿‡{% u æ•°æ®è®¿é—®æ—¶åœ¨æ•°æ®å¯¹åº”çš„ä¾èµ–åˆ—è¡¨ä¸­å¢åŠ å½“å‰æ¸²æŸ“çš„ Watcherå®ä¾‹ï¼Œç„¶ååœ¨æ•°æ®ä¿®æ”¹æ—¶é€šçŸ¥ä¾èµ–ä¸­å­˜å‚¨çš„ Watcherå®ä¾‹éœ€è¦å†æ¬¡æ‰§è¡Œå¯¹åº”çš„æ¸²æŸ“æ–¹æ³• %}ã€‚

å…¶ä¸­çš„ä¾èµ–å’ŒWatcheræ˜¯å•ç‹¬çš„æ¨¡å—ï¼Œæˆ‘ä»¬è¿™å‡ ä¼šå¯¹è¿™ 2 ä¸ªä¸»è¦æ¨¡å—è¿›è¡Œåˆ†æè®²è§£ã€‚

## 5.1 Depæ¨¡å—

Depè¡¨ç¤ºä¾èµ–ç±»ï¼Œæ¯ä¸€ä¸ª dataä¸­éƒ½ä¼šç»‘å®šä¸€ä¸ª Depå®ä¾‹ depã€‚

åœ¨è®¿é—®æ•°æ®æ—¶ï¼Œä¼šè°ƒç”¨depä¸Šçš„ dependæ–¹æ³•è¿›è¡Œä¾èµ–æ”¶é›†ã€‚

### 5.1.1 Dep.Target

{% box child:codeblock color:purple %}
```js
Dep.target = null
const targetStack: Array<DepTarget | null | undefined> = []

export function pushTarget(target?: DepTarget | null) {
  targetStack.push(target)
  Dep.target = target
}

export function popTarget() {
  targetStack.pop()
  Dep.target = targetStack[targetStack.length - 1]
}
```
{% endbox %}

{% u æ¯ä¸€æ¬¡æ¸²æŸ“éƒ½å¯¹åº”ç€ä¸€ä¸ª Watcherå®ä¾‹ï¼Œå®é™…ä¸Šæ¸²æŸ“æ˜¯ Watcherå®ä¾‹ä¸­çš„ä¸€éƒ¨åˆ† %}ã€‚
 
{% u Dep.target æ˜¯ä¸€ä¸ªé™æ€å±æ€§ï¼Œç”¨äºå­˜å‚¨å½“å‰æ­£åœ¨æ‰§è¡Œæ¸²æŸ“çš„ Watcher å®ä¾‹ %}ã€‚

æ¯æ¬¡åœ¨æ¸²æŸ“å‰éƒ½ä¼šè°ƒç”¨ pushTarget å°† Dep.Targetè®¾ç½®ä¸ºå½“å‰æ‰§è¡Œæ¸²æŸ“çš„ Watcherå®ä¾‹ã€‚

ç„¶ååœ¨æ¸²æŸ“å®Œæˆåä¼šè°ƒç”¨ popTarget å°† Dep.target è®¾ç½®ä¸ºç©ºã€‚

{% box child:codeblock color:purple %}
```js 
class Watcher{
    constructor(){
        this.initRender();
    }
    initRender(){
        // æ¸²æŸ“å‰è®¾ç½®Dep.targetä¸ºå½“å‰ Watcherå®ä¾‹
        pushTarget(this);
        // æ¸²æŸ“
        render() 
        // æ¸²æŸ“åè®¾ç½®Dep.targetä¸ºç©º
        popTarget();
    }
}
```
{% endbox %}

æ‰€ä»¥åœ¨æ¸²æŸ“æ—¶è§¦å‘æ•°æ®çš„getteré€»è¾‘æ”¶é›†ä¾èµ–æ—¶å¯ä»¥é€šè¿‡ Dep.targetè·å–å½“å‰æ¸²æŸ“å¯¹åº”çš„ Watcherå®ä¾‹å¹¶æ·»åŠ åˆ°ä¾èµ–æ•°ç»„ä¸­ã€‚

{% image /assets/topic/vue2/observe/12.jpg %}

### 5.1.2 subsé›†åˆ

Depç±»ç»´æŠ¤äº†ä¸€ä¸ª subsé›†åˆï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰ä¾èµ–äºè¯¥å±æ€§çš„ Watcherå®ä¾‹ã€‚

æ¯å½“ç”¨æˆ·è®¿é—®æ•°æ®æ—¶ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡ Dep.Targetè·å–åˆ°æœ¬æ¬¡æ¸²æŸ“å¯¹åº”çš„ Watcherå®ä¾‹ã€‚

æ‰€ä»¥å°±å¯ä»¥å°†Watcherå®ä¾‹æ·»åŠ è¿› subsé›†åˆä¸Šï¼Œä»¥ä¾¿åç»­çš„ä½¿ç”¨ã€‚

### 5.1.3 dependæ–¹æ³•

{% box child:codeblock color:purple %}
```js 
//======================= Depç±»====================
depend(info?: DebuggerEventExtraInfo) {
    // å½“å‰æ¸²æŸ“å¯¹åº”çš„ watcher
    if (Dep.target) {
      Dep.target.addDep(this);
    }
}

addSub(sub: DepTarget) {
    this.subs.push(sub)
}
//======================= Watcherç±»================
 addDep(dep: Dep) {
    const id = dep.id
    if (!this.newDepIds.has(id)) {
      this.newDepIds.add(id)
      this.newDeps.push(dep)
      if (!this.depIds.has(id)) {
        dep.addSub(this)
      }
    }
  }
```
{% endbox %}

åœ¨æ•°æ®è®¿é—®æ—¶ï¼Œä¼šè°ƒç”¨æ•°æ®å¯¹åº”çš„ Depå®ä¾‹ä¸Šçš„ dependæ–¹æ³•ï¼Œè¿›è€Œæ‰§è¡Œ Watcherå®ä¾‹ä¸Šçš„ addDepæ–¹æ³•ã€‚

è€Œåœ¨Watcherå®ä¾‹ä¸Šçš„ addDepæ–¹æ³•ä¸­æœ€ç»ˆåˆä¼šè°ƒç”¨ Depå®ä¾‹ä¸Šçš„ addSubæ–¹æ³•ã€‚

ç„¶åå†åœ¨Depå®ä¾‹ä¸Šçš„subsé›†åˆä¸Šæ·»åŠ Watcherå®ä¾‹ã€‚

ä½ å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥åœ°å°†å½“å‰ Watcherå®ä¾‹æ·»åŠ åˆ° subsä¸­å‘¢ï¼Œè€Œæ˜¯è¦ç»•è¿™ä¹ˆä¸€å¤§åœˆå‘¢ï¼Ÿ

{% u depä¸­ä¸ä¼šå­˜åœ¨é‡å¤çš„ watcherï¼ŒåŒæ—¶ watcherä¸­ä¸ä¼šå­˜åœ¨ç›¸åŒçš„ dep %}

{% image /assets/topic/vue2/observe/13.jpg %}

#### 5.1.3.1 å»é‡æœºåˆ¶

é€šè¿‡ Watcher çš„ addDep æ–¹æ³•ï¼Œå¯ä»¥åœ¨ Watcher çº§åˆ«è¿›è¡Œå»é‡ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿åŒä¸€ä¸ª Dep ä¸ä¼šå¤šæ¬¡æ·»åŠ ç›¸åŒçš„ Watcherï¼Œä»è€Œé¿å…ä¸å¿…è¦çš„é‡å¤ä¾èµ–ã€‚

{% box child:codeblock color:purple %}
```js  
addDep(dep: Dep) {
    const id = dep.id
    if (!this.newDepIds.has(id)) {
      this.newDepIds.add(id)
      this.newDeps.push(dep)
      if (!this.depIds.has(id)) {
        dep.addSub(this)
      }
    }
}
```
{% endbox %}

* newDepIds å’Œ newDepsï¼šè¿™ä¸¤ä¸ªé›†åˆç”¨äºè®°å½•å½“å‰æ”¶é›†å‘¨æœŸä¸­æ–°æ·»åŠ çš„ä¾èµ–ã€‚newDepIds æ˜¯ä¸€ä¸ª Setï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾æ˜¯å¦å·²ç»æ·»åŠ è¿‡æŸä¸ª Depï¼›newDeps æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºå­˜å‚¨æ–°æ·»åŠ çš„ Dep å®ä¾‹ã€‚
* depIdsï¼šè¿™æ˜¯ä¸€ä¸ª Setï¼Œç”¨äºè®°å½•å·²ç»å­˜åœ¨çš„ä¾èµ–ã€‚å¦‚æœ depId ä¸åœ¨ depIds ä¸­ï¼Œè¯´æ˜è¿™æ˜¯ç¬¬ä¸€æ¬¡æ·»åŠ è¯¥ä¾èµ–ï¼Œå› æ­¤è°ƒç”¨ dep.addSub(this) å°† Watcher æ·»åŠ åˆ° Dep çš„ subs é›†åˆä¸­ã€‚

#### 5.1.3.2 æœ‰å“ªäº›éœ€è¦å»é‡çš„åœºæ™¯

##### 5.1.3.2.1 å»é‡åœºæ™¯ä¸€ï¼šå¤šæ¬¡è®¿é—®åŒä¸€ä¸ªå“åº”å¼å±æ€§

å½“ä¸€ä¸ªç»„ä»¶åœ¨åŒä¸€ä¸ªæ¸²æŸ“å‘¨æœŸå†…å¤šæ¬¡è®¿é—®åŒä¸€ä¸ªå“åº”å¼å±æ€§æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´é‡å¤æ·»åŠ  Watcherã€‚ä¾‹å¦‚ï¼Œåœ¨æ¨¡æ¿ä¸­å¤šæ¬¡å¼•ç”¨åŒä¸€ä¸ªæ•°æ®å±æ€§ï¼š

{% box child:codeblock color:purple %}
```js   
<template>
  <div>
    {{ message }}
    <p>{{ message }}</p>
  </div>
</template>

<script>
export default {
  data() {
    return {
      message: 'Hello, Vue!'
    };
  }
};
</script>
```
{% endbox %}

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œmessage è¢«å¼•ç”¨äº†ä¸¤æ¬¡ã€‚å¦‚æœä¸è¿›è¡Œå»é‡å¤„ç†ï¼Œæ¯æ¬¡è®¿é—® message éƒ½ä¼šå°è¯•æ·»åŠ ä¸€ä¸ªæ–°çš„ Watcherã€‚

##### 5.1.3.2.2 å»é‡åœºæ™¯äºŒï¼šè®¡ç®—å±æ€§å’Œä¾¦å¬å™¨çš„å¤šé‡ä¾èµ–

è®¡ç®—å±æ€§å’Œä¾¦å¬å™¨ï¼ˆwatchï¼‰å¯èƒ½ä¼šä¾èµ–å¤šä¸ªå“åº”å¼å±æ€§ï¼Œå¦‚æœè¿™äº›å±æ€§åœ¨åŒä¸€ä¸ªæ¸²æŸ“å‘¨æœŸå†…è¢«å¤šæ¬¡è®¿é—®ï¼Œä¹Ÿå¯èƒ½å¯¼è‡´é‡å¤æ·»åŠ  Watcherã€‚

{% box child:codeblock color:purple %}
```js   
computed: {
  fullName() {
    return `${this.firstName} ${this.lastName}`;
  }
},
watch: {
  firstName() {
    console.log('firstName changed');
  },
  lastName() {
    console.log('lastName changed');
  }
}
```
{% endbox %}

å¦‚æœ fullName è®¡ç®—å±æ€§åœ¨åŒä¸€ä¸ªæ¸²æŸ“å‘¨æœŸå†…è¢«å¤šæ¬¡è®¿é—®ï¼ŒfirstName å’Œ lastName ä¼šè¢«å¤šæ¬¡ä¾èµ–ï¼Œå¦‚æœæ²¡æœ‰å»é‡å¤„ç†ï¼Œå¯èƒ½ä¼šå¯¼è‡´é‡å¤çš„ Watcherã€‚

##### 5.1.3.2.3 å»é‡åœºæ™¯ä¸‰ï¼šç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸé’©å­

åœ¨ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸé’©å­ä¸­ï¼Œå¦‚æœå¤šæ¬¡è®¿é—®åŒä¸€ä¸ªå“åº”å¼å±æ€§ï¼Œä¹Ÿå¯èƒ½ä¼šå¯¼è‡´é‡å¤æ·»åŠ  Watcherã€‚

{% box child:codeblock color:purple %}
```js   
mounted() {
  console.log(this.message);
  console.log(this.message);
}
```
{% endbox %}

##### 5.1.3.2.4 å»é‡åœºæ™¯å››ï¼šåŠ¨æ€ç»„ä»¶å’Œæ¡ä»¶æ¸²æŸ“

åœ¨åŠ¨æ€ç»„ä»¶å’Œæ¡ä»¶æ¸²æŸ“ä¸­ï¼Œå¦‚æœåŒä¸€ä¸ªå“åº”å¼å±æ€§åœ¨ä¸åŒçš„æ¡ä»¶åˆ†æ”¯ä¸­è¢«å¤šæ¬¡è®¿é—®ï¼Œä¹Ÿå¯èƒ½å¯¼è‡´é‡å¤æ·»åŠ  Watcherã€‚

{% box child:codeblock color:purple %}
```js   
<template>
  <div>
    <component :is="currentComponent" />
    <p v-if="showMessage">{{ message }}</p>
    <p v-else>{{ message }}</p>
  </div>
</template>

<script>
export default {
  data() {
    return {
      currentComponent: 'ComponentA',
      showMessage: true,
      message: 'Hello, Vue!'
    };
  }
};
</script>
```
{% endbox %}


### 5.1.4 notifyæ–¹æ³•

notify æ–¹æ³•æ˜¯ Dep ç±»ä¸­çš„ä¸€ä¸ªé‡è¦æ–¹æ³•ï¼Œç”¨äºåœ¨æ•°æ®å˜åŒ–æ—¶é€šçŸ¥æ‰€æœ‰ä¾èµ–äºè¯¥æ•°æ®çš„ Watcher å®ä¾‹ã€‚

è¿™ä¸ªæ–¹æ³•ç¡®ä¿æ‰€æœ‰ç›¸å…³çš„ Watcher éƒ½èƒ½æ¥æ”¶åˆ°æ•°æ®å˜åŒ–çš„é€šçŸ¥ï¼Œå¹¶è§¦å‘ç›¸åº”çš„æ›´æ–°æ“ä½œã€‚

{% box child:codeblock color:purple %}
```js   
notify(info?: DebuggerEventExtraInfo) {
    // stabilize the subscriber list first
    const subs = this.subs.filter(s => s) as DepTarget[]
    if (__DEV__ && !config.async) {
      // subs aren't sorted in scheduler if not running async
      // we need to sort them now to make sure they fire in correct
      // order
      subs.sort((a, b) => a.id - b.id)
    }
    for (let i = 0, l = subs.length; i < l; i++) {
      const sub = subs[i]
      if (__DEV__ && info) {
        sub.onTrigger &&
          sub.onTrigger({
            effect: subs[i],
            ...info
          })
      }
      sub.update()
    }
}
```
{% endbox %}

{% image /assets/topic/vue2/observe/14.jpg %}

#### 5.1.4.1 å»æ‰ç©ºå€¼

{% box child:codeblock color:purple %}
```js   
const subs = this.subs.filter(s => s) as DepTarget[]
```
{% endbox %}

è¿™ä¸€æ­¥æ˜¯ä¸ºäº†ç¡®ä¿ subs åˆ—è¡¨ä¸­æ²¡æœ‰ null æˆ– undefined çš„å€¼ã€‚filter(s => s) ä¼šè¿‡æ»¤æ‰æ‰€æœ‰éçœŸå€¼çš„é¡¹ã€‚

#### 5.1.4.2 æ’åºè®¢é˜…è€…ï¼ˆä»…åœ¨å¼€å‘æ¨¡å¼ä¸‹ä¸”æœªå¼‚æ­¥è¿è¡Œæ—¶ï¼‰

{% box child:codeblock color:purple %}
```js   
if (__DEV__ && !config.async) {
  // subs aren't sorted in scheduler if not running async
  // we need to sort them now to make sure they fire in correct
  // order
  subs.sort((a, b) => a.id - b.id)
}
```
{% endbox %}

* __DEV__ æ˜¯ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œè¡¨ç¤ºå½“å‰æ˜¯å¦å¤„äºå¼€å‘æ¨¡å¼ã€‚
* config.async æ˜¯ä¸€ä¸ªé…ç½®é€‰é¡¹ï¼Œè¡¨ç¤ºæ˜¯å¦å¼‚æ­¥æ‰§è¡Œæ›´æ–°ã€‚
* å¦‚æœå¤„äºå¼€å‘æ¨¡å¼ä¸”æœªå¼‚æ­¥è¿è¡Œï¼Œsubs åˆ—è¡¨éœ€è¦æŒ‰ id æ’åºï¼Œä»¥ç¡®ä¿ Watcher æŒ‰æ­£ç¡®çš„é¡ºåºè§¦å‘æ›´æ–°ã€‚è¿™æ˜¯å› ä¸ºå¼‚æ­¥è°ƒåº¦å™¨ä¼šè‡ªåŠ¨å¤„ç†æ’åºï¼Œè€Œåœ¨åŒæ­¥æ¨¡å¼ä¸‹éœ€è¦æ‰‹åŠ¨æ’åºã€‚

#### 5.1.4.3 é€šçŸ¥æ¯ä¸ªè®¢é˜…è€…

{% box child:codeblock color:purple %}
```js   
for (let i = 0, l = subs.length; i < l; i++) {
  const sub = subs[i]
  if (__DEV__ && info) {
    sub.onTrigger &&
      sub.onTrigger({
        effect: subs[i],
        ...info
      })
  }
  sub.update()
}
```
{% endbox %}

* éå† subs åˆ—è¡¨ï¼Œé€ä¸ªé€šçŸ¥æ¯ä¸ª Watcherã€‚
* å¦‚æœå¤„äºå¼€å‘æ¨¡å¼ä¸”æä¾›äº† infoï¼Œè°ƒç”¨ sub.onTrigger æ–¹æ³•ï¼Œä¼ é€’è°ƒè¯•ä¿¡æ¯ã€‚
* æœ€ç»ˆè°ƒç”¨ sub.update() æ–¹æ³•ï¼Œè§¦å‘ Watcher çš„æ›´æ–°æ“ä½œã€‚

## 5.2 Watcheræ¨¡å— 

### 5.2.1 å°†æ¸²æŸ“å‡½æ•°æŒ‚è½½åˆ°å®ä¾‹ä¸Š 

åœ¨ä¸Šä¸€ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬åˆæ¬¡æ¸²æŸ“æ—¶ä¼šå®ä¾‹åŒ–ä¸€ä¸ª watcherå®ä¾‹ã€‚

ç„¶åå°†æ¸²æŸ“çš„æ–¹æ³•ä¼ å…¥ watcherå®ä¾‹ä¸­ã€‚

ç„¶åå°±ä¼šæ‰§è¡Œå¯¹åº”çš„æ¸²æŸ“æ–¹æ³•ã€‚

æ‰€ä»¥å¯ä»¥æƒ³åˆ°æ¸²æŸ“çš„é€»è¾‘åº”è¯¥æ˜¯å†™åœ¨äº† Watcherç±»çš„æ„é€ å™¨ä¸­ã€‚ 

{% box child:codeblock color:purple %}
```js   
// åˆæ¬¡æ¸²æŸ“æ—¶ 
new Watcher(æ¸²æŸ“å‡½æ•°)


class Watcher{
    constructor(æ¸²æŸ“å‡½æ•°){
        this.æ¸²æŸ“å‡½æ•° = æ¸²æŸ“å‡½æ•°;
        // æ‰§è¡Œæ¸²æŸ“
        this.æ¸²æŸ“å‡½æ•°();
    }
}
```
{% endbox %}

å½“ç„¶æºç ä¸­å®é™…ä¸Šä¸ä»…ä»…è¿™ä¹ˆç®€å•ã€‚

{% box child:codeblock color:purple %}
```js   
// åˆæ¬¡æ¸²æŸ“æ—¶ 
new Watcher(æ¸²æŸ“å‡½æ•°)


class Watcher{
    constructor(æ¸²æŸ“å‡½æ•°){
        this.æ¸²æŸ“å‡½æ•° = æ¸²æŸ“å‡½æ•°;
        // æ‰§è¡Œæ¸²æŸ“
        this.æ¸²æŸ“å‡½æ•°();
    }
}
```
{% endbox %}

æºç ä¸­å°†æ¸²æŸ“å‡½æ•°æŒ‚è½½åˆ°äº† getterä¸Šã€‚
 
{% box child:codeblock color:purple %}
```js   
this.getter = expOrFn
```
{% endbox %}

ç„¶ååœ¨ getæ–¹æ³•ä¸­è°ƒç”¨ getteræ–¹æ³•ã€‚

åœ¨ getæ–¹æ³•ä¸­è®¾ç½® Dep.targetä¸ºå½“å‰çš„ watcherã€‚

{% box child:codeblock color:purple %}
```js   
get() {
    pushTarget(this)
    let value
    const vm = this.vm
    try {
      value = this.getter.call(vm, vm)
    } catch (e: any) {
      if (this.user) {
        handleError(e, vm, `getter for watcher "${this.expression}"`)
      } else {
        throw e
      }
    } finally {
      // "touch" every property so they are all tracked as
      // dependencies for deep watching
      if (this.deep) {
        traverse(value)
      }
      popTarget()
      this.cleanupDeps()
    }
    return value
  }
```
{% endbox %}

### 5.2.2 updateæ–¹æ³•

åœ¨æ•°æ®è¢«è®¿é—®æ—¶ï¼Œä¼šè°ƒç”¨ dep.notifyé€šçŸ¥ä¾èµ–éœ€è¦æ›´æ–°æ¸²æŸ“ï¼Œç„¶åè°ƒç”¨ watcher.updateã€‚

ç„¶åä¼šè°ƒç”¨ runæ–¹æ³•ï¼Œæœ€åè°ƒç”¨ getæ–¹æ³•é‡æ–°æ‰§è¡Œæ¸²æŸ“æ–¹æ³•ã€‚ 

# å…­ã€æ€»ç»“

è¿™ä¸€ç¯‡ä¸­æˆ‘ä»¬è¯¦ç»†è§£é‡Šäº†æ•°æ®å“åº”å¼ç›¸å…³çš„åŸç†ã€‚

ä¸€å¥è¯å°±æ˜¯{% u åœ¨æ•°æ®è®¿é—®æ—¶æ”¶é›†ä¾èµ–ï¼Œåœ¨æ•°æ®è¢«ä¿®æ”¹æ—¶æ›´æ–°ä¾èµ– %}

{% image /assets/topic/vue2/observe/15.jpg %}