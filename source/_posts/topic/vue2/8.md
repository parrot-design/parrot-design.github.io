---
title: ğŸ”¥Vue2æ•°æ®å“åº”å¼åŸç†
permalink: posts/vue2-observe.html
date: 2024-11-18 14:39
topic: vue2
banner: /assets/topic/vue2/banner/init-render.jpg
---  
 
&nbsp;

{% button è¿”å› javascript:window.history.back() icon:solar:back-white color:orange size:xs %}

{% quot ä¸“æ ç¬¬å…«ç¯‡-æ•°æ®å“åº”å¼åŸç† %}

ä¸Šä¸€ç¯‡ä¸­æˆ‘ä»¬å°†åˆæ¬¡æ¸²æŸ“é¡µé¢çš„æµç¨‹å¤§è‡´çš„è¿‡äº†ä¸€éã€‚

å½“ç„¶ï¼Œè¿˜æœ‰å¾ˆå¤šç»†èŠ‚æ²¡æœ‰æè¿°ã€‚

Vueä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†çš„å°±æ˜¯æ•°æ®é©±åŠ¨è§†å›¾ï¼Œæ‰€è°“å“åº”å¼å°±æ˜¯å½“æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œç•Œé¢ä¼šåŒæ­¥æ›´æ–°ã€‚

# ä¸€ã€æ•°æ®ä»£ç†çš„åŸºç¡€

æ•°æ®ä»£ç†ï¼Œæœ‰æ—¶ä¹Ÿè¢«ç§°ä½œæ•°æ®åŠ«æŒï¼Œæ˜¯ä¸€ç§æŠ€æœ¯æ‰‹æ®µï¼Œå®ƒèƒ½å¤Ÿæˆªè·å¯¹å¯¹è±¡å±æ€§çš„è®¿é—®å’Œä¿®æ”¹æ“ä½œï¼Œå¹¶åœ¨è¿™äº›æ“ä½œå‘ç”Ÿæ—¶æ‰§è¡Œé¢å¤–çš„é€»è¾‘æˆ–ä¿®æ”¹è¿”å›çš„ç»“æœã€‚

åœ¨ Vue.js ä¸­ï¼Œå“åº”å¼ç³»ç»Ÿçš„æ ¸å¿ƒæœºåˆ¶æ­£æ˜¯åŸºäºæ•°æ®ä»£ç†ã€‚

é€šè¿‡ä»£ç†ï¼ŒVue èƒ½å¤Ÿ{% u åœ¨æ•°æ®è¢«è®¿é—®æ—¶æ”¶é›†ä¾èµ–ï¼Œåœ¨æ•°æ®è¢«ä¿®æ”¹æ—¶æ›´æ–°è¿™äº›ä¾èµ– %}ï¼Œè¿™æ˜¯å“åº”å¼ç³»ç»Ÿè¿ä½œçš„åŸºæœ¬ç†å¿µã€‚

è€Œè¿™ä¸€åˆ‡éƒ½ä¾èµ–äº Vue å¯¹æ•°æ®è¿›è¡Œçš„æ‹¦æˆªå’Œä»£ç†æ“ä½œã€‚

å°½ç®¡å“åº”å¼ç‰¹æ€§æœ¬èº«å¹¶éæœ¬èŠ‚çš„è®¨è®ºé‡ç‚¹ï¼Œæˆ‘ä»¬å°†æ¢ç´¢æ•°æ®ä»£ç†åœ¨å…¶ä»–åœºæ™¯ä¸‹çš„åº”ç”¨ã€‚

åœ¨æ·±å…¥åˆ†æä¹‹å‰ï¼Œé‡è¦çš„æ˜¯è¦ç†è§£å®ç°æ•°æ®ä»£ç†çš„ä¸¤ç§ä¸»è¦æ–¹æ³•ï¼š{% u Object.defineProperty %}å’Œ {% u Proxy %}ã€‚

è¿™ä¸¤ç§æ–¹æ³•ä¸ºæˆ‘ä»¬æä¾›äº†å¼ºå¤§çš„æ”¯æŒï¼Œä»¥å®ç°å¯¹æ•°æ®è®¿é—®å’Œä¿®æ”¹è¡Œä¸ºçš„ç²¾ç»†æ§åˆ¶ã€‚ 

## 1.1 Object.defineProperty

Vueæ˜¯é€šè¿‡è¿™ä¸ªAPIå¯¹æ•°æ®è¿›è¡Œç›‘å¬çš„ã€‚

> Object.defineProperty() æ–¹æ³•ç”¨äºåœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šç›´æ¥å®šä¹‰ä¸€ä¸ªæ–°å±æ€§ï¼Œæˆ–è€…ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„ç°æœ‰å±æ€§ï¼Œå¹¶è¿”å›è¯¥å¯¹è±¡ã€‚

åŸºæœ¬ä½¿ç”¨å¦‚ä¸‹ï¼š

{% box child:codeblock color:purple %}
```js
Object.defineProperty(obj, prop, descriptor)
```
{% endbox %}

å‚æ•°è¯´æ˜ï¼š

> objï¼šå¿…éœ€ã€‚ç›®æ ‡å¯¹è±¡
> propsï¼šå¿…éœ€ã€‚éœ€å®šä¹‰æˆ–ä¿®æ”¹çš„å±æ€§çš„åå­—
> descriptorï¼šå¿…éœ€ã€‚ç›®æ ‡å±æ€§æ‰€æ‹¥æœ‰çš„ç‰¹æ€§

Object.defineProperty() å…è®¸æˆ‘ä»¬ç²¾ç¡®åœ°æ·»åŠ æˆ–ä¿®æ”¹å¯¹è±¡çš„å±æ€§ã€‚ 

ç»™å¯¹è±¡çš„å±æ€§æ·»åŠ ç‰¹æ€§æè¿°æœ‰ä¸¤ç§å½¢å¼ï¼š{% u 1.æ•°æ®æè¿°å’Œ2.å­˜å–æè¿° color:orange %}ã€‚

æ•°æ®æè¿°å’Œå­˜å–æè¿°æ‰€å¯¹åº”çš„å±æ€§æ˜¯ä¸åŒçš„ã€‚

### 1.1.1 æ•°æ®æè¿°

å½“ä¿®æ”¹æˆ–å®šä¹‰å¯¹è±¡çš„æŸä¸ªå±æ€§çš„æ—¶å€™ï¼Œç»™è¿™ä¸ªå±æ€§æ·»åŠ ä¸€äº›ç‰¹æ€§ã€‚

{% box child:codeblock color:purple %}
```js
let obj = {
    test:'hello world'
}
//å¯¹å·²æœ‰çš„å±æ€§æ·»åŠ ç‰¹æ€§æè¿°
Object.defineProperty(obj,"test",{
    configurable:true | false,
    enumerable:true | false,
    value:ä»»æ„ç±»å‹çš„å€¼,
    writable:true | false
});
//å¯¹æ–°æ·»åŠ çš„å±æ€§çš„ç‰¹æ€§æè¿°
Object.defineProperty(obj,"newKey",{
    configurable:true | false,
    enumerable:true | false,
    value:ä»»æ„ç±»å‹çš„å€¼,
    writable:true | false
});
```
{% endbox %}

æ•°æ®æè¿°ä¸­æœ‰å››ä¸ªå±æ€§ï¼Œéƒ½æ˜¯å¯é€‰çš„ï¼Œæ¥çœ‹ä¸€ä¸‹æ¯ä¸€ä¸ªå±æ€§çš„ä½œç”¨ã€‚

#### 1.1.1.1 value 

å±æ€§å¯¹åº”çš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨ä»»æ„ç±»å‹çš„å€¼ï¼Œé»˜è®¤ä¸º undefinedã€‚

{% box child:codeblock color:purple %}
```js
let obj = {}
//ç¬¬ä¸€ç§æƒ…å†µï¼šä¸è®¾ç½®valueå±æ€§
Object.defineProperty(obj,"newKey",{

});
console.log( obj.newKey );  //undefined
----------------------------------------
//ç¬¬äºŒç§æƒ…å†µï¼šè®¾ç½®valueå±æ€§
Object.defineProperty(obj,"newKey",{
    value:"hello"
});
console.log( obj.newKey );  //hello
```
{% endbox %}


#### 1.1.1.2 writable 

å±æ€§çš„å€¼æ˜¯å¦å¯ä»¥è¢«é‡å†™ã€‚è®¾ç½®ä¸ºtrueå¯ä»¥è¢«é‡å†™ï¼›è®¾ç½®ä¸ºfalseï¼Œä¸èƒ½è¢«é‡å†™ã€‚é»˜è®¤ä¸ºfalseã€‚

{% box child:codeblock color:purple %}
```js
let obj = {}
//ç¬¬ä¸€ç§æƒ…å†µï¼šwritableè®¾ç½®ä¸ºfalseï¼Œä¸èƒ½é‡å†™ã€‚
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:false
});
//æ›´æ”¹newKeyçš„å€¼
obj.newKey = "change value";
console.log( obj.newKey );  //hello
------------------------------
//ç¬¬äºŒç§æƒ…å†µï¼šè®¾ç½®valueå±æ€§
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:true
});
//æ›´æ”¹newKeyçš„å€¼
obj.newKey = "change value";
console.log( obj.newKey );  //change value
```
{% endbox %}
 
#### 1.1.1.3 configurable 

æ˜¯å¦å¯ä»¥åˆ é™¤ç›®æ ‡å±æ€§æˆ–æ˜¯å¦å¯ä»¥å†æ¬¡ä¿®æ”¹å±æ€§çš„ç‰¹æ€§ï¼ˆwritable, configurable, enumerableï¼‰ã€‚è®¾ç½®ä¸ºtrueå¯ä»¥è¢«åˆ é™¤æˆ–å¯ä»¥é‡æ–°è®¾ç½®ç‰¹æ€§ï¼›è®¾ç½®ä¸ºfalseï¼Œä¸èƒ½è¢«å¯ä»¥è¢«åˆ é™¤æˆ–ä¸å¯ä»¥é‡æ–°è®¾ç½®ç‰¹æ€§ã€‚é»˜è®¤ä¸ºfalseã€‚

è¿™ä¸ªå±æ€§èµ·åˆ°ä¸¤ä¸ªä½œç”¨ï¼š

1. ç›®æ ‡å±æ€§æ˜¯å¦å¯ä»¥ä½¿ç”¨deleteåˆ é™¤
2. ç›®æ ‡å±æ€§æ˜¯å¦å¯ä»¥å†æ¬¡è®¾ç½®ç‰¹æ€§


{% box child:codeblock color:purple %}
```js
//-----------------æµ‹è¯•ç›®æ ‡å±æ€§æ˜¯å¦èƒ½è¢«åˆ é™¤------------------------
let obj = {}
//ç¬¬ä¸€ç§æƒ…å†µï¼šconfigurableè®¾ç½®ä¸ºfalseï¼Œä¸èƒ½è¢«åˆ é™¤ã€‚
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:false,
    enumerable:false,
    configurable:false
});
//åˆ é™¤å±æ€§
delete obj.newKey;
console.log( obj.newKey ); //hello
//ç¬¬äºŒç§æƒ…å†µï¼šconfigurableè®¾ç½®ä¸ºtrueï¼Œå¯ä»¥è¢«åˆ é™¤ã€‚
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:false,
    enumerable:false,
    configurable:true
});
//åˆ é™¤å±æ€§
delete obj.newKey;
console.log( obj.newKey ); //undefined

//-----------------æµ‹è¯•æ˜¯å¦å¯ä»¥å†æ¬¡ä¿®æ”¹ç‰¹æ€§------------------------
let obj = {}
//ç¬¬ä¸€ç§æƒ…å†µï¼šconfigurableè®¾ç½®ä¸ºfalseï¼Œä¸èƒ½å†æ¬¡ä¿®æ”¹ç‰¹æ€§ã€‚
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:false,
    enumerable:false,
    configurable:false
});
//é‡æ–°ä¿®æ”¹ç‰¹æ€§
//æŠ¥é”™ï¼šUncaught TypeError: Cannot redefine property: newKey
// å› ä¸º writableå’Œ configurableéƒ½ä¸º false å³æ— æ³•é‡æ–°é…ç½®
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:true,
    enumerable:true,
    configurable:true
});


//ç¬¬äºŒç§æƒ…å†µï¼šconfigurableè®¾ç½®ä¸ºtrueï¼Œå¯ä»¥å†æ¬¡ä¿®æ”¹ç‰¹æ€§ã€‚
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:false,
    enumerable:false,
    configurable:true
});
//é‡æ–°ä¿®æ”¹ç‰¹æ€§
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:true,
    enumerable:true,
    configurable:true
});
console.log( obj.newKey ); //hello
```
{% endbox %}

#### 1.1.1.4 enumerable
 
æ­¤å±æ€§æ˜¯å¦å¯ä»¥è¢«æšä¸¾ï¼ˆä½¿ç”¨for...inæˆ–Object.keys()ï¼‰ã€‚è®¾ç½®ä¸ºtrueå¯ä»¥è¢«æšä¸¾ï¼›è®¾ç½®ä¸ºfalseï¼Œä¸èƒ½è¢«æšä¸¾ã€‚é»˜è®¤ä¸ºfalseã€‚

{% box child:codeblock color:purple %}
```js
let obj = {}
//ç¬¬ä¸€ç§æƒ…å†µï¼šenumerableè®¾ç½®ä¸ºfalseï¼Œä¸èƒ½è¢«æšä¸¾ã€‚
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:false,
    enumerable:false
});

//æšä¸¾å¯¹è±¡çš„å±æ€§
for( var attr in obj ){
    console.log( attr );  // æ‰“å°ä¸ºç©º
}
//ç¬¬äºŒç§æƒ…å†µï¼šenumerableè®¾ç½®ä¸ºtrueï¼Œå¯ä»¥è¢«æšä¸¾ã€‚
Object.defineProperty(obj,"newKey",{
    value:"hello",
    writable:false,
    enumerable:true
});

//æšä¸¾å¯¹è±¡çš„å±æ€§
for( var attr in obj ){
    console.log( attr );  //newKey
}
```
{% endbox %}

> {% u ä¸€æ—¦ä½¿ç”¨Object.definePropertyç»™å¯¹è±¡æ·»åŠ å±æ€§ï¼Œé‚£ä¹ˆå¦‚æœä¸è®¾ç½®å±æ€§çš„ç‰¹æ€§ï¼Œé‚£ä¹ˆconfigurableã€enumerableã€writableè¿™äº›å€¼éƒ½ä¸ºé»˜è®¤çš„false color:orange %}

### 1.1.2 å­˜å–å™¨æè¿°

å­˜å–å™¨æè¿°ç¬¦ä¹Ÿæœ‰å››ä¸ªå±æ€§ï¼šgetã€setã€enumerableã€configureã€‚

{% box child:codeblock color:purple %}
```js
let obj = {};
Object.defineProperty(obj,"newKey",{
    get:function (){} | undefined,
    set:function (value){} | undefined
    configurable: true | false
    enumerable: true | false
});
```
{% endbox %}

> å½“ä½¿ç”¨äº†getteræˆ–setteræ–¹æ³•ï¼Œä¸å…è®¸ä½¿ç”¨writableå’Œvalueè¿™ä¸¤ä¸ªå±æ€§


#### 1.1.2.1 getter/setter

å½“è®¾ç½®æˆ–è·å–å¯¹è±¡çš„æŸä¸ªå±æ€§çš„å€¼çš„æ—¶å€™ï¼Œå¯ä»¥æä¾›getter/setteræ–¹æ³•ã€‚

* getter æ˜¯ä¸€ç§è·å¾—å±æ€§å€¼çš„æ–¹æ³•
* setteræ˜¯ä¸€ç§è®¾ç½®å±æ€§å€¼çš„æ–¹æ³•ã€‚

åœ¨ç‰¹æ€§ä¸­ä½¿ç”¨get/setå±æ€§æ¥å®šä¹‰å¯¹åº”çš„æ–¹æ³•ã€‚

{% box child:codeblock color:purple %}
```js
let obj = {};
let initValue = 'hello';
Object.defineProperty(obj,"newKey",{
    get:function (){
        //å½“è·å–å€¼çš„æ—¶å€™è§¦å‘çš„å‡½æ•°
        return initValue;    
    },
    set:function (value){
        //å½“è®¾ç½®å€¼çš„æ—¶å€™è§¦å‘çš„å‡½æ•°,è®¾ç½®çš„æ–°å€¼é€šè¿‡å‚æ•°valueæ‹¿åˆ°
        initValue = value;
    }
});
//è·å–å€¼
console.log( obj.newKey );  //hello

//è®¾ç½®å€¼
obj.newKey = 'change value';

console.log( obj.newKey ); //change value
```
{% endbox %}

> æ³¨æ„ï¼šgetæˆ–setä¸æ˜¯å¿…é¡»æˆå¯¹å‡ºç°ï¼Œä»»å†™å…¶ä¸€å°±å¯ä»¥ã€‚å¦‚æœä¸è®¾ç½®æ–¹æ³•ï¼Œåˆ™getå’Œsetçš„é»˜è®¤å€¼ä¸ºundefined

> configurableå’ŒenumerableåŒä¸Šé¢çš„ç”¨æ³•ã€‚

> å±æ€§æè¿°ç¬¦å’Œæ•°æ®æè¿°ç¬¦éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œå¦‚æœä½ åœ¨ç¬¬ä¸‰ä¸ªå‚æ•°ä¸­æ—¢å†™äº† value/writableï¼Œåˆå†™äº† get/set åˆ™ä¼šæŠ¥é”™ã€‚

{% image /assets/topic/vue2/observe/2.png %}

### 1.1.3 å…¼å®¹æ€§

{% image /assets/topic/vue2/observe/1.png %}

å…¼å®¹æ€§å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šåœ¨ie8ä¸‹åªèƒ½åœ¨DOMå¯¹è±¡ä¸Šä½¿ç”¨ï¼Œå°è¯•åœ¨åŸç”Ÿçš„å¯¹è±¡ä½¿ç”¨ Object.defineProperty()ä¼šæŠ¥é”™ã€‚

### 1.1.4 å›°æƒ‘çš„é—®é¢˜

{% image /assets/topic/vue2/observe/3.png %}

å¦‚ä¸Šï¼Œåœ¨ä½¿ç”¨ get æ–¹æ³•åï¼Œæ— æ³•ç›´æ¥çœ‹åˆ°å¯¹è±¡ä¸Šçš„å±æ€§ï¼Œéœ€è¦ç‚¹å‡»æ‰å¯ä»¥ã€‚

## 1.2 Proxy 

### 1.2.1 definePropertyçš„ç¼ºç‚¹

æˆ‘ä»¬çŸ¥é“Vue2ä¸­çš„æ•°æ®å“åº”å¼å¤„ç†ä½¿ç”¨çš„æ˜¯ Object.definePropertyï¼Œè€Œ Vue3ä¸­å®ç°æ•°æ®å“åº”ä½¿ç”¨çš„æ˜¯ Proxyã€‚

Object.definePropertyè™½ç„¶å¯ä»¥å®ç°åŠŸèƒ½ï¼Œä½†æ˜¯æ— æ³•å¯¹æ•°ç»„æˆ–è€…æ·±å±‚æ¬¡å¯¹è±¡è¿›è¡Œç›‘å¬å¤„ç†ã€‚

#### 1.2.1.1 æ•°ç»„

{% box child:codeblock color:purple %}
```js
let arr = [1,2,3,4,5];
arr.forEach((item,index)=>{
    Object.defineProperty(arr,index,{
        get() {
            console.log('æ•°ç»„è¢«getteræ‹¦æˆª')
            return item
        },
        set(value) {
            console.log('æ•°ç»„è¢«setteræ‹¦æˆª')
            return item = value
        }
    })
})
arr[1] = 11;
console.log(arr[1]);
arr.push(6)
arr[10] = 10
// ç»“æœ
æ•°ç»„è¢«setteræ‹¦æˆª
æ•°ç»„è¢«getteræ‹¦æˆª
11
```
{% endbox %}

å¾ˆæ˜¾ç„¶ï¼Œ{% u å·²çŸ¥é•¿åº¦çš„æ•°ç»„å¯ä»¥é€šè¿‡ç´¢å¼•è¿›è¡Œå±æ€§çš„è®¾ç½®ä¸è®¿é—® color:orange %}ã€‚

ç„¶è€Œï¼Œæ•°ç»„çš„æ·»åŠ æ“ä½œå´æ— æ³•è¢«ç›´æ¥æ‹¦æˆªã€‚

è¿™å¾ˆå®¹æ˜“ç†è§£ï¼šæ— è®ºæ˜¯é€šè¿‡ arr.push() æ–¹æ³•è¿˜æ˜¯ç›´æ¥èµ‹å€¼å¦‚ arr[10] = 10 æ¥æ·»åŠ å…ƒç´ ï¼Œæ–°æ·»åŠ çš„ç´¢å¼•å¹¶æœªè¢«åŒ…å«åœ¨é¢„è®¾çš„æ•°æ®æ‹¦æˆªæœºåˆ¶ä¸­ï¼Œå› æ­¤æ— æ³•å®ç°æ‹¦æˆªå¤„ç†ã€‚

è¿™æ˜¯ä½¿ç”¨ Object.defineProperty è¿›è¡Œæ•°æ®ä»£ç†çš„ä¸€ä¸ªå±€é™æ€§ã€‚

Vue åœ¨å…¶å“åº”å¼ç³»ç»Ÿä¸­å¯¹æ•°ç»„æ–¹æ³•è¿›è¡Œäº†é‡å†™ï¼Œä»è€Œé—´æ¥åœ°è§£å†³äº†æ­¤é—®é¢˜ã€‚

#### 1.2.1.2 æ·±å±‚æ¬¡å¯¹è±¡ 

{% box child:codeblock color:purple %}
```js
let obj={
    level1:{
        level2:"ç¬¬äºŒå±‚"
    }
}
// ä¿å­˜ level1 çš„åŸå§‹å€¼ é¿å…å¾ªç¯å¼•ç”¨çš„é”™è¯¯
let originalLevel1 = obj.level1;
Object.defineProperty(obj,'level1',{
    get(){
        console.log("å¯¹è±¡è¢«getteræ‹¦æˆª")
        return originalLevel1
    },
    set(value){
        console.log("å¯¹è±¡è¢«setteræ‹¦æˆª")
        originalLevel1 = value;
    }
})
// ç»“æœ
å¯¹è±¡è¢«setteræ‹¦æˆª
å¯¹è±¡è¢«getteræ‹¦æˆª
obj.level1 = {level3:"ç¬¬ä¸‰å±‚"}
console.log(obj.level1)// {level3:"ç¬¬ä¸‰å±‚"}
```
{% endbox %}

å¯ä»¥çœ‹åˆ°æ›´æ–°è®¾ç½®çš„é‚£ä¸€å±‚æ˜¯æ²¡é—®é¢˜çš„ã€‚

ä½†æ˜¯å¦‚æœæˆ‘ä»¬æ›´æ–°æ›´æ·±å±‚æ¬¡çš„å¯¹è±¡ï¼Œå°±æ— æ³•ç›‘å¬åˆ°ã€‚

{% box child:codeblock color:purple %}
```js
let obj={
    level1:{
        level2:"ç¬¬äºŒå±‚"
    }
}
// ä¿å­˜ level1 çš„åŸå§‹å€¼ é¿å…å¾ªç¯å¼•ç”¨çš„é”™è¯¯
let originalLevel1 = obj.level1;
Object.defineProperty(obj,'level1',{
    get(){
        console.log("å¯¹è±¡è¢«getteræ‹¦æˆª")
        return originalLevel1
    },
    set(value){
        console.log("å¯¹è±¡è¢«setteræ‹¦æˆª")
        originalLevel1 = value;
    }
}) 
obj.level1.level2 = 'ç¬¬äºŒå±‚-å¤åˆ¶'
//ç»“æœ
å¯¹è±¡è¢«getteræ‹¦æˆª
```
{% endbox %}

å¯ä»¥çœ‹å‡ºæ¥å¹¶æ²¡æœ‰æ‰§è¡Œ set æ–¹æ³•ï¼Œå¦‚æœæƒ³è¦æ·±å±‚æ¬¡çš„å±æ€§ä¹Ÿè¢«ç›‘å¬åˆ°çš„è¯ï¼Œéœ€è¦é€’å½’åœ°ç»™å¯¹è±¡ä¸­çš„æ¯ä¸€ä¸ªå±æ€§æ·»åŠ å±æ€§æè¿°ã€‚


{% box child:codeblock color:purple %}
```js
function walk(obj){
    // å¦‚æœä¸æ˜¯å¯¹è±¡ æ— éœ€å¤„ç†
    if(!(obj instanceof Object))  return obj
    for(let k in obj){
        let val = obj[k];
        walk(val);
        Object.defineProperty(obj,k,{
            enumerable:true,
            configurable:true,
            get(){
                console.log(`è®¿é—®obj.${k}å±æ€§è§¦å‘`)
                return val
            },
            set(newValue) {
                console.log(`ä¿®æ”¹obj.${k}å±æ€§è§¦å‘` , newValue)
                if (val === newValue) return;
                val = newValue
                walk(newValue)
            } 
        })
    }
    return obj;
}
// é€’å½’ç›‘å¬æ‰€æœ‰å±‚çº§å¯¹è±¡
let obj = {a:{b:{c:'d'}}}
walk(obj)
obj.a
obj.a.b
obj.a.b.c
```
{% endbox %}

### 1.2.2 Proxyçš„ä»‹ç»

Proxyå°±å¯ä»¥è§£å†³Object.definePropertyçš„è¿™äº›é—®é¢˜ã€‚

ä»£ç†æ˜¯ç›®æ ‡å¯¹è±¡çš„æŠ½è±¡ã€‚

ä»–å¯ä»¥ç”¨ä½œç›®æ ‡å¯¹è±¡çš„æ›¿èº«ï¼Œä½†åˆå®Œå…¨ç‹¬ç«‹äºç›®æ ‡å¯¹è±¡ã€‚

ç›®æ ‡å¯¹è±¡æ—¢å¯ä»¥ç›´æ¥è¢«æ“ä½œï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä»£ç†æ¥æ“ä½œã€‚ä½†æ˜¯ç›´æ¥æ“ä½œä¼šç»•è¿‡ä»£ç†èµ‹äºˆçš„è¡Œä¸ºã€‚

#### 1.2.2.1 ç©ºä»£ç†

æœ€ç®€å•çš„ä»£ç†æ˜¯ç©ºä»£ç†ï¼Œå³é™¤äº†ä½œä¸ºä¸€ä¸ªæŠ½è±¡çš„ç›®æ ‡å¯¹è±¡ï¼Œä»€ä¹ˆä¹Ÿä¸åšã€‚

ä»£ç†å¯¹è±¡ä¸Šæ‰§è¡Œçš„æ‰€æœ‰æ“ä½œéƒ½ä¼šæ— éšœç¢çš„ä¼ æ’­åˆ°ç›®æ ‡å¯¹è±¡ã€‚

{% box child:codeblock color:purple %}
```js
const target = {
    id: 'target'
}

const handler = {}

const proxy = new Proxy(target, handler)
// idå±æ€§ä¼šè®¿é—®åŒä¸€ä¸ªå€¼
console.log(target.id); // target
console.log(proxy.id); // target

// ç»™ç›®æ ‡å±æ€§èµ‹å€¼ä¼šåæ˜ åœ¨ä¸¤ä¸ªå¯¹è±¡ä¸Š
// å› ä¸ºä¸¤ä¸ªå¯¹è±¡è®¿é—®çš„æ˜¯åŒä¸€ä¸ªå€¼
target.id = 'foo';
console.log(target.id); // foo
console.log(proxy.id); // foo 

// ç»™ä»£ç†å±æ€§èµ‹å€¼ä¼šåæ˜ åœ¨ä¸¤ä¸ªå¯¹è±¡ä¸Š
// å› ä¸ºè¿™ä¸ªèµ‹å€¼ä¼šè½¬ç§»åˆ°ç›®æ ‡å¯¹è±¡
proxy.id = 'bar';
console.log(target.id); // bar
console.log(proxy.id); // bar

// Proxy.prototype æ˜¯ undefined
// å› æ­¤ä¸èƒ½ä½¿ç”¨ instanceof æ“ä½œç¬¦
console.log(target instanceof Proxy); // TypeError: Function has non-object prototype 
console.log(proxy instanceof Proxy); // TypeError: Function has non-object prototype

// ä¸¥æ ¼ç›¸ç­‰å¯ä»¥ç”¨æ¥åŒºåˆ†ä»£ç†å’Œç›®æ ‡
console.log(target === proxy); // false
```
{% endbox %}

#### 1.2.2.2 å®šä¹‰æ•è·å™¨

å½“ç„¶ï¼Œæ­£å¸¸ä½¿ç”¨ä¸ä¼šç»™ä¸€ä¸ªç©ºä»£ç†ï¼Œè‚¯å®šæ˜¯è¦é€šè¿‡ä»£ç†å¯¹è®¿é—®å’Œä¿®æ”¹è¿›è¡Œæ•è·ã€‚

æœ¬èŠ‚æš‚ä¸”ä»‹ç»å‡ ä¸ªå¸¸ç”¨çš„æ•è·å™¨ã€‚è¦†ç›–Vue2ä¸­ä½¿ç”¨çš„æ‰€æœ‰æ•è·å™¨ã€‚

#### 1.2.2.2.1 get æ•è·å™¨

getæ•è·å™¨ä¼šåœ¨è·å–å±æ€§å€¼çš„æ“ä½œä¸­è¢«è°ƒç”¨ã€‚

{% box child:codeblock color:purple %}
```js 
const target = {
    foo: 'bar'
}; 

const handler = {
    // æ•è·å™¨åœ¨å¤„ç†ç¨‹åºå¯¹è±¡ä¸­ä»¥æ–¹æ³•åä¸ºé”®
    get(){
        return 'handler override';
    }
}

const proxy = new Proxy(target, handler)

// åªæœ‰åœ¨ä»£ç†å¯¹è±¡ä¸Šæ‰§è¡Œè¿™äº›æ“ä½œæ‰ä¼šè§¦å‘æ•è·å™¨ åœ¨ç›®æ ‡å¯¹è±¡ä¸Šæ‰§è¡Œè¿™äº›æ“ä½œä»ç„¶ä¼šäº§ç”Ÿæ­£å¸¸çš„è¡Œä¸º
console.log(target.foo) // bar
console.log(proxy.foo) // handler override
```
{% endbox %}

1. è¿”å›å€¼

è¿”å›å€¼æ— é™åˆ¶ã€‚

2. æ‹¦æˆªçš„æ“ä½œ

* proxy.property
* proxy[property]
* Object.create(proxy)[property]
* Reflect.get(proxy, property, receiver)

3. æ•è·å™¨å¤„ç†ç¨‹åºå‚æ•°

* target: ç›®æ ‡å¯¹è±¡
* property: å¼•ç”¨ç›®æ ‡å¯¹è±¡ä¸Šçš„å­—ç¬¦ä¸²é”®å±æ€§
* receiver: ä»£ç†å¯¹è±¡æˆ–ç»§æ‰¿ä»£ç†å¯¹è±¡çš„å¯¹è±¡  

#### 1.2.2.2.2 setæ•è·å™¨

set()æ•è·å™¨ä¼šåœ¨è®¾ç½®å±æ€§å€¼çš„æ“ä½œä¸­è¢«è°ƒç”¨ã€‚

{% box child:codeblock color:purple %}
```js 
const myTarget = {};
const proxy = new Proxy(myTarget, {
 set(target, property, value, receiver) {
    console.log('è§¦å‘äº†set');
    return Reflect.set(...arguments)
 }
});
proxy.foo = 'bar';
// è§¦å‘äº†set
```
{% endbox %}

1. è¿”å›å€¼

è¿”å› true è¡¨ç¤ºæˆåŠŸï¼›è¿”å› false è¡¨ç¤ºå¤±è´¥ï¼Œä¸¥æ ¼æ¨¡å¼ä¸‹ä¼šæŠ›å‡º TypeErrorã€‚

2. æ‹¦æˆªçš„æ“ä½œ

* proxy.property = value
* proxy.[property]  = value
* Object.create(proxy)[property] = value
* Reflect.set(proxy, property, value, receiver)

3. æ•è·å™¨å¤„ç†ç¨‹åºå‚æ•°

* target: ç›®æ ‡å¯¹è±¡
* property: å¼•ç”¨ç›®æ ‡å¯¹è±¡ä¸Šçš„å­—ç¬¦ä¸²é”®å±æ€§
* valueï¼šè¦èµ‹ç»™å±æ€§çš„å€¼ã€‚
* receiver: æ¥æ”¶æœ€åˆèµ‹å€¼çš„å¯¹è±¡  

#### 1.2.2.2.3 hasæ•è·å™¨

has()æ•è·å™¨ä¼šåœ¨ in æ“ä½œç¬¦ä¸­è¢«è°ƒç”¨ã€‚

{% box child:codeblock color:purple %}
```js 
const myTarget = {};
const proxy = new Proxy(myTarget, {
    has(target, property) {
        console.log('è§¦å‘äº†haså‡½æ•°');
        return Reflect.has(...arguments)
    }
});
'foo' in proxy;
// è§¦å‘äº†haså‡½æ•°
```
{% endbox %}

1. è¿”å›å€¼

has()å¿…é¡»è¿”å›å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºå±æ€§æ˜¯å¦å­˜åœ¨ã€‚è¿”å›éå¸ƒå°”å€¼ä¼šè¢«è½¬å‹ä¸ºå¸ƒå°”å€¼ã€‚

2. æ‹¦æˆªçš„æ“ä½œ

* property in proxy
* property in Object.create(proxy)
* with(proxy) {(property);}
* Reflect.has(proxy, property)

3. æ•è·å™¨å¤„ç†ç¨‹åºå‚æ•°

* target: ç›®æ ‡å¯¹è±¡
* property: å¼•ç”¨ç›®æ ‡å¯¹è±¡ä¸Šçš„å­—ç¬¦ä¸²é”®å±æ€§ 

### 1.2.3 è¯•è¯•æ·±å±‚æ¬¡å¯¹è±¡å’Œæ•°ç»„

ä¸Šé¢æˆ‘ä»¬è¯´åˆ°Object.definePropertyå¯¹äºæ•°ç»„æ ¼å¼å’Œæ·±å±‚æ¬¡å¯¹è±¡å¤„ç†ä¸äº†ã€‚

é‚£æˆ‘ä»¬æ¥è¯•è¯• Proxyæ˜¯å¦å¯ä»¥å¤„ç†ã€‚

#### 1.2.3.1 å¤„ç†æ•°ç»„

{% box child:codeblock color:purple %}
```js
let target = [1,2,3,4] 

let proxy = new Proxy(target,{
    get(){
        console.log("è§¦å‘äº†è·å–æ•°ç»„")
        return Reflect.get(...arguments)
    },
    set(){ 
        console.log("è§¦å‘äº†è®¾ç½®æ•°ç»„")
        return Reflect.set(...arguments) 
    }
}) 

proxy1.push(5);
console.log(proxy1[4]);
```
{% endbox %}

{% image /assets/topic/vue2/observe/4.png %}

å¯ä»¥çœ‹åˆ°æ‰“å°äº†å¤šæ¬¡ã€‚

ä½†æ˜¯è¿™é‡Œæœ‰ç‚¹ä»¤æˆ‘å›°æƒ‘çš„æ˜¯{% wavy ä¸ºä»€ä¹ˆä¼šæ‰“å°è¿™ä¹ˆå¤šæ¬¡? %}ã€‚

#### 1.2.3.2 å¤„ç†æ·±å±‚æ¬¡å¯¹è±¡

{% box child:codeblock color:purple %}
```js 
let target = {a:{b:{c:'d'}}}

let proxy = new Proxy(target,{
    get(){
        console.log("è§¦å‘äº†è·å–å¯¹è±¡")
        return Reflect.get(...arguments)
    },
    set(){ 
        console.log("è§¦å‘äº†è®¾ç½®å¯¹è±¡")
        return Reflect.set(...arguments) 
    }
}) 

proxy.a.b.c
proxy.a.b.c = 'e'
```
{% endbox %}

# äºŒã€initProxy

è™½ç„¶Vue2ä¸­çš„æ•°æ®åŠ«æŒå¹¶æ²¡æœ‰ä½¿ç”¨ Proxyï¼Œä½†æ˜¯å´åœ¨æ£€æµ‹ data æ—¶ä½¿ç”¨äº†Proxyã€‚

è¿˜è®°å¾—æˆ‘ä»¬åœ¨å‰é¢ç« èŠ‚[ä¸“æ ç¬¬å››ç¯‡-åˆå§‹åŒ–å¹²äº†ä»€ä¹ˆäº‹](/posts/vue2-init.html)ä¸­ä»‹ç»äº†Vueå®ä¾‹åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨ initProxyï¼Œä½†æ˜¯å½“æ—¶æˆ‘ä»¬å¹¶æ²¡æœ‰å¯¹è¿™ä¸ªæ–¹æ³•è¿›è¡Œæ·±åº¦å‰–æï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯ä½¿ç”¨ Proxy æ¥è¿›è¡Œæ•°æ®ä»£ç†ã€‚

ä½†æ˜¯æˆ‘ä»¬ç°åœ¨å·²ç»å­¦ä¹ äº† Proxyï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™å‡ æ¥è¯¦ç»†çœ‹ä¸‹è¿™å—çš„é€»è¾‘ã€‚

{% box child:codeblock color:purple %}
```js 
 Vue.prototype._init = function (options) {
    if (__DEV__) {
        initProxy(vm)
    } else {
        vm._renderProxy = vm
    }
 }
```
{% endbox %}

åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œè°ƒç”¨äº† initProxyã€‚

è€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹å¹¶æ²¡æœ‰è°ƒç”¨ï¼Œè€Œæ˜¯å°†å®ä¾‹æœ¬èº«èµ‹å€¼åˆ°_renderProxyå±æ€§ä¸­ã€‚

ä¸€èˆ¬ä»…å­˜åœ¨äºå¼€å‘ç¯å¢ƒä¸­çš„é€»è¾‘éƒ½æ˜¯ä¸€äº›æŠ¥é”™æç¤ºä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›²çŒœinitProxyä¹Ÿæ˜¯æ·»åŠ äº†å¼€å‘æ—¶æŠ¥é”™çš„æç¤ºä¿¡æ¯ã€‚

{% box child:codeblock color:purple %}
```js  
const hasHandler = {
    has(target, key) {
      const has = key in target
      const isAllowed =
        allowedGlobals(key) ||
        (typeof key === 'string' &&
          key.charAt(0) === '_' &&
          !(key in target.$data))
      if (!has && !isAllowed) {
        if (key in target.$data) warnReservedPrefix(target, key)
        else warnNonPresent(target, key)
      }
      return has || !isAllowed
    }
}

const getHandler = {
    get(target, key) {
      if (typeof key === 'string' && !(key in target)) {
        if (key in target.$data) warnReservedPrefix(target, key)
        else warnNonPresent(target, key)
      }
      return target[key]
    }
}

initProxy = function initProxy(vm) {
    if (hasProxy) {
      // determine which proxy handler to use
      const options = vm.$options
      const handlers =
        options.render && options.render._withStripped ? getHandler : hasHandler
      vm._renderProxy = new Proxy(vm, handlers)
    } else {
      vm._renderProxy = vm
    }
  }
}
```
{% endbox %}

## 2.1 hasProxy

é¦–å…ˆåˆ¤æ–­å½“å‰å®¿ä¸»ç¯å¢ƒä¸­æ˜¯å¦å­˜åœ¨Proxyï¼Œé€šè¿‡Proxyæ˜¯å¦å®šä¹‰å’Œæ˜¯åŸç”Ÿå±æ€§æ¥åˆ¤æ–­ã€‚

{% box child:codeblock color:purple %}
```js  
export function isNative(Ctor: any): boolean {
  return typeof Ctor === 'function' && /native code/.test(Ctor.toString())
}

const hasProxy = typeof Proxy !== 'undefined' && isNative(Proxy)
```
{% endbox %}

## 2.2 _renderProxy

åœ¨å¼€å‘ç¯å¢ƒä¸‹ç»™ vm è®¾ç½®ä»£ç†åï¼Œå°†_renderProxyè®¾ç½®ä¸ºä»£ç†å¯¹è±¡ã€‚ä»£ç†ç›®æ ‡ä¸º vueå®ä¾‹ vmã€‚è¿™æ„å‘³ç€å½“è®¿é—® vmæ—¶ï¼Œä¼šè§¦å‘ä»£ç†æ•è·å™¨ã€‚

åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ç›´æ¥å°†_renderProxyè®¾ç½®ä¸ºå®ä¾‹ vmã€‚

æ‰€ä»¥å¯ä»¥çœ‹å‡ºæ¥ä¸è®ºæ˜¯åœ¨å¼€å‘ç¯å¢ƒæˆ–è€…ç”Ÿäº§ç¯å¢ƒå¦‚ä½•éƒ½æ˜¯ç»™ vm._renderProxyè®¾ç½®å€¼ã€‚

é‚£ä¹ˆè¿™é‡Œçš„_renderProxyæ˜¯åœ¨ä½•æ—¶ä½¿ç”¨çš„å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯åœ¨æ‰§è¡Œ_renderæ–¹æ³•ç”Ÿæˆ vnodeçš„æ—¶å€™ï¼Œå°† vm._renderProxy å½“åšç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥renderæ–¹æ³•ä¸­ã€‚

{% box child:codeblock color:purple %}
```js  
vnode = render.call(vm._renderProxy, vm.$createElement)
```
{% endbox %}

æ¯”å¦‚æˆ‘ä»¬åœ¨.vueæ–‡ä»¶çš„æ¨¡ç‰ˆä¸­ç¼–å†™ä¸€æ®µä»£ç ï¼š

{% box child:codeblock color:purple %}
```html  
<div>{{ msg }}</div>
```
{% endbox %}

ä¸Šé¢è¿™æ®µä»£ç ä¼šè¢«è½¬åŒ–æˆä¸€ä¸ªrenderå‡½æ•°ã€‚

{% box child:codeblock color:purple %}
```js
render = function(){
    // è·å– this
    const _vm = this;
    // _vm._self æ˜¯ vue å®ä¾‹
    // _cæ˜¯åˆ›å»º vnodeçš„æ–¹æ³•
    const _c = _vm._self._c
    // _sæ˜¯è½¬æˆå­—ç¬¦ä¸²çš„æ–¹æ³•
    const _s = _vm._self._s
    return _c('div',_s(_vm.msg))
}
```
{% endbox %}

å¯ä»¥çœ‹å‡ºæ¥ renderå‡½æ•°çš„ thisæŒ‡å‘çš„å°±æ˜¯vm._renderProxyï¼Œä¹Ÿå°±æ˜¯ vueå®ä¾‹ã€‚

ç„¶åé€šè¿‡ {% u vm.xxx %} è®¿é—®å®ä¾‹ä¸Šçš„å±æ€§æ—¶å°±å¯ä»¥è§¦å‘ä»£ç†ä¸Šçš„å®šä¹‰çš„æ•è·å™¨é€»è¾‘ã€‚

## 2.3 æ¨¡æ¿æ¸²æŸ“çš„å‡ ç§æƒ…å†µ

åœ¨æˆ‘ä»¬äº†è§£æ•è·å™¨ä¸­çš„è¯¦ç»†é€»è¾‘å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ç¼–å†™Vueæ¸²æŸ“ä¸­çš„ä¸‰ç§æƒ…å†µã€‚

çŸ¥é“å¯¹åº”çš„ä»£ç å¤„ç†çš„æ˜¯å“ªäº›åœºæ™¯æœ‰åŠ©äºæˆ‘ä»¬æ›´å¥½çš„äº†è§£æºç ã€‚

### 2.3.1 ç”¨æˆ·è‡ªå®šä¹‰ template æ¨¡æ¿

{% box child:codeblock color:purple %}
```js
new Vue({
    template:`<div>{{ msg }}</div>`,
    data(){
        return {
            msg:'Hello World'
        }
    }
}).$mount("#app");
```
{% endbox %}

å¯¹templateé€‰é¡¹è¿›è¡Œæ¨¡ç‰ˆç¼–è¯‘æ˜¯å‘ç”Ÿåœ¨å®ä¾‹çš„æŒ‚è½½é˜¶æ®µã€‚

æ‰€ä»¥åœ¨åˆå§‹åŒ–æ—¶ï¼Œé€‰é¡¹ä¸­åªæœ‰ templateæ ‡ç­¾ã€‚

ç»è¿‡é€‰é¡¹åˆå¹¶åï¼Œvm.$optionsä¸Šåªæœ‰ templateé€‰é¡¹å¹¶æ²¡æœ‰ renderæ–¹æ³•ã€‚

{% wavy æ‰€ä»¥è¿™ç§æƒ…å†µåœ¨æ‰§è¡ŒinitProxyæ–¹æ³•å¯¹ç›®æ ‡å¯¹è±¡å®ä¾‹ vm è¿›è¡Œä»£ç†æ—¶ï¼Œæ³¨å†Œçš„æ˜¯hasHandleræ–¹æ³•ã€‚%}

hasHandleræ–¹æ³•ä¸­ä½¿ç”¨çš„æ˜¯hasæ•è·å™¨ï¼Œhasæ•è·å™¨ç”¨äºå¤„ç†å±æ€§çš„å­˜åœ¨æ€§æ£€æŸ¥ã€‚

vueåœ¨å¯¹templateé€‰é¡¹è¿›è¡Œæ¨¡æ¿ç¼–è¯‘æ—¶ï¼Œä¼šå°†å…¶è½¬åŒ–ä¸º renderå‡½æ•°ï¼Œä¸”ä¼šè¢« withåŒ…è£¹ã€‚

{% image /assets/topic/vue2/observe/6.png %}

è€Œå‰é¢æˆ‘ä»¬è¯´è¿‡hasæ•è·å™¨å¯ä»¥æ‹¦æˆª withè¯­å¥ä¸‹çš„ä½œç”¨ã€‚åœ¨æ‰§è¡Œ withè¯­å¥çš„è¿‡ç¨‹ä¸­ï¼Œè¯¥ä½œç”¨åŸŸä¸‹çš„å˜é‡éƒ½ä¼šè§¦å‘ hasé’©å­ã€‚è¿™ä¹Ÿæ˜¯æ¨¡ç‰ˆæ¸²æŸ“æ—¶ä¹‹æ‰€ä»¥ä¼šè§¦å‘ä»£ç†æ‹¦æˆªçš„åŸå› ã€‚

### 2.3.2 ä½¿ç”¨.vueæ–‡ä»¶æ¥ç¼–å†™é¡µé¢

è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ç¼–å†™ vueé¡¹ç›®ä¸­æœ€å¸¸ç”¨çš„å†™æ³•ã€‚

{% box child:codeblock color:purple %}
```js
// Test.vue
<template>
  <div>
    {{ msg }}
  </div> 
</template>

<script> 

export default {
  data(){
    return {
      msg: "Hello World"
    }
  }
};
</script>
```
{% endbox %}

.vueæ–‡ä»¶åœ¨webpacké¢„ç¼–è¯‘é˜¶æ®µä¼šè¢« vue-loader è§£ææˆä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­æ¨¡æ¿éƒ¨åˆ†ä¼šè¢«è§£ææˆrenderå‡½æ•°ã€‚

å¹¶ä¸”åœ¨ä¼šåœ¨renderæ–¹æ³•ä¸­æŒ‚è½½_withStrippedä¸ºtrueã€‚

æ‰€ä»¥è¿™ä¸ªå˜é‡æ ‡è¯†ç€å½“å‰çš„ renderå‡½æ•°æ˜¯ä½¿ç”¨.vueæ–‡ä»¶ç¼–å†™ç¼–è¯‘è€Œæ¥çš„ã€‚

{% wavy æ‰€ä»¥è¿™ç§æƒ…å†µåœ¨æ‰§è¡ŒinitProxyæ–¹æ³•å¯¹ç›®æ ‡å¯¹è±¡å®ä¾‹ vm è¿›è¡Œä»£ç†æ—¶ï¼Œæ³¨å†Œçš„æ˜¯getHandleræ–¹æ³•ã€‚%}

getHandleræ–¹æ³•ä¸­ä½¿ç”¨çš„æ˜¯getæ•è·å™¨ï¼Œgetæ•è·å™¨ç”¨äºå¤„ç†å¯¹ Vue å®ä¾‹å±æ€§çš„è¯»å–æ“ä½œã€‚

webpack + vue-loaderå¯¹.vueæ–‡ä»¶è¿›è¡Œç¼–è¯‘æ—¶ï¼Œä¼šè½¬åŒ–æˆä¸‹é¢è¿™ç§å½¢å¼ã€‚

{% image /assets/topic/vue2/observe/7.png %}

å¯ä»¥çœ‹åˆ°ç›´æ¥ä½¿ç”¨ vm.xxx è®¿é—®çš„å±æ€§ã€‚æ‰€ä»¥å¯ä»¥ä½¿ç”¨ getæ•è·å™¨è¿›è¡Œæ•è·ã€‚

### 2.3.3 ç”¨æˆ·è‡ªå®šä¹‰ renderæ–¹æ³•æ¥ç¼–å†™é¡µé¢

{% box child:codeblock color:purple %}
```js
// main.js
import Fun from "./Fun.js"; 
 
new Vue(Fun).$mount("#app");

// fun.js
let Component = {
  render:function(h){
    return h('div',this.msg)
  },
  data(){
    return {
      msg:'Hello World'
    }
  }
}

export default Component;
```
{% endbox %}

è™½ç„¶è¿™ç§æƒ…å†µåœ¨ä¹Ÿå­˜åœ¨ renderæ–¹æ³•ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ _withStripped å±æ€§

{% wavy æ‰€ä»¥è¿™ç§æƒ…å†µåœ¨æ‰§è¡ŒinitProxyæ–¹æ³•å¯¹ç›®æ ‡å¯¹è±¡å®ä¾‹ vm è¿›è¡Œä»£ç†æ—¶ï¼Œæ³¨å†Œçš„æ˜¯hasHandleræ–¹æ³•ã€‚%}

ä½†æ˜¯è‡ªå®šä¹‰ renderçš„æƒ…å†µå¹¶æ²¡æœ‰ä½¿ç”¨ inæˆ–è€… withçš„æƒ…å†µã€‚

æ‰€ä»¥ç”¨æˆ·è‡ªå®šä¹‰çš„æ–¹æ³•ä¸ä¼šæœ‰æŠ¥é”™æç¤ºã€‚

## 2.4 æ•è·å™¨é‡Œé¢çš„å…·ä½“é€»è¾‘

å‰é¢æˆ‘ä»¬è¯´åˆ°äº†ä¸‰ç§æƒ…å†µéƒ½æœ‰å¯¹åº”çš„æ•è·æ–¹æ³•ã€‚

é‚£ä¹ˆè¿™ä¸ªæ•è·æ–¹æ³•å†…éƒ¨ç©¶ç«Ÿåšäº†äº›ä»€ä¹ˆæ“ä½œå‘¢ï¼Ÿ

ä¸»è¦æ˜¯åœ¨å¼€å‘è€…å¼€å‘æ—¶å¯¹å±æ€§å’Œæ–¹æ³•çš„å®šä¹‰åšæç¤ºã€‚

1. å½“å¼€å‘è€…åœ¨æ¸²æŸ“å†…å®¹ä¸­ä½¿ç”¨äº†_ä½œä¸ºå˜é‡åçš„å‰ç¼€æ—¶ï¼Œæç¤ºä¸å¯ä»¥ä½¿ç”¨è¿™ç§å‘½åæ–¹å¼ã€‚å› ä¸ºè¿™ç§æ–¹å¼å¯èƒ½ä¼šä¸å†…éƒ¨çš„å˜é‡å­˜åœ¨å†²çªã€‚
2. å½“å¼€å‘è€…åœ¨æ¸²æŸ“å†…å®¹ä¸­ä½¿ç”¨äº†æœªå®šä¹‰çš„å˜é‡æ—¶ï¼Œæç¤ºè¯¥å˜é‡å¹¶æ²¡æœ‰åœ¨ vueå®ä¾‹ä¸Šæ‰¾åˆ°ã€‚

è€Œå‰é¢æˆ‘ä»¬è¯´åˆ°äº†ç”¨æˆ·è‡ªå®šä¹‰çš„æ–¹æ³•ä¸ä¼šæœ‰æŠ¥é”™æç¤ºã€‚

æˆ‘ä»¬å¯ä»¥å®éªŒä¸€ä¸‹ï¼š

{% box child:codeblock color:purple %}
```js
// main.js
import Fun from "./Fun.js"; 
 
new Vue(Fun).$mount("#app");

// fun.js
let Component = {
  render:function(h){
    // ä½¿ç”¨äº†æœªå®šä¹‰çš„å˜é‡
    return h('div',this.msg1)
  },
  data(){
    return {
      msg:'Hello World'
    }
  }
}

export default Component;
```
{% endbox %}

æˆ‘ä»¬åœ¨renderæ–¹æ³•ä¸­ä½¿ç”¨äº†ä¸€ä¸ªæœªä½¿ç”¨çš„å˜é‡ msg1ã€‚

ç„¶åæ‰“å¼€æ§åˆ¶å°å¹¶æ²¡æœ‰æŠ¥é”™æç¤ºã€‚

å› ä¸ºæ­¤æ—¶ä»£ç†ä½¿ç”¨çš„æ˜¯hasæ•è·å™¨ï¼Œè€Œæˆ‘ä»¬æ—¢æ²¡æœ‰ä½¿ç”¨ withï¼Œä¹Ÿæ²¡ä½¿ç”¨ inã€‚

é‚£ä¹ˆæœ‰æ²¡æœ‰è§£å†³åŠæ³•å‘¢ï¼Ÿ

æœ‰ï¼Œé‚£å°±æ˜¯åœ¨ renderä¸ŠæŒ‚è½½ä¸€ä¸ª_withStrippedå˜é‡ï¼Œè®©ä»–åœ¨ initProxyæ—¶æ³¨å†Œ getæ•è·å™¨ã€‚

{% box child:codeblock color:purple %}
```js
let Component = {
  render:function(h){
    return h('div',this.msg1)
  },
  data(){
    return {
      msg:'Hello World'
    }
  }
}
// åœ¨ renderæ–¹æ³•ä¸­æŒ‚è½½_withStrippedå±æ€§
Component.render._withStripped = true;
export default Component;
```
{% endbox %}

å¯ä»¥çœ‹åˆ°æ§åˆ¶å°å‡ºç°äº†æŠ¥é”™ä¿¡æ¯ã€‚

{% image /assets/topic/vue2/observe/8.png %}

# ä¸‰ã€å®ç°ç®€æ˜“ç‰ˆvueä¾èµ–æ”¶é›†

å› ä¸ºVueä¸­å¯¹æ•°æ®å“åº”å¼è¿™å—çš„ä»£ç æ¯”è¾ƒå¤šï¼Œæ¶‰åŠå¤šä¸ªæ–‡ä»¶ã€‚

ä½†æ˜¯æˆ‘ä»¬çŸ¥é“æ•°æ®å“åº”å¼çš„åŸç†å°±æ˜¯{% u é¡µé¢æ¸²æŸ“æ—¶è¿›è¡Œæ•°æ®è®¿é—®æ—¶æ”¶é›†ä¾èµ–ï¼Œåœ¨æ•°æ®æ›´æ–°æ—¶æ›´æ–°å¯¹åº”ä¾èµ–çš„æ¸²æŸ“å†…å®¹ %}

{% image /assets/topic/vue2/observe/10.jpg %}

{% box child:codeblock color:purple %}
```js
// =================== æ–°å¢ç‚¹å‡»äº‹ä»¶æ›´æ”¹===================
const btnElement = document.createElement('button');
document.body.appendChild(btnElement);
btnElement.innerHTML = 'ç‚¹å‡»';
btnElement.onclick = function(){
    // ç‚¹å‡»äº‹ä»¶
    debugger;
}

// Aé¡µé¢
let PageA = {
    msg:'Hello World',
    render(){
        const appElement = document.getElementById('#app');
        appElement.innerHTML = this.msg;
    }
}

// å­˜å‚¨ä¾èµ–çš„é¡µé¢
let Dep = [];

Object.defineProperty(PageA,'msg',{
    get(){
        //è®¿é—®msgå˜é‡æ—¶æ‰§è¡Œ
        console.log("è®¿é—®äº† msgå˜é‡")
    },
    set(){
        //è®¾ç½®msgå˜é‡æ—¶æ‰§è¡Œ
        console.log("è®¾ç½®äº† msgå˜é‡")
    }
})

// æ‰§è¡Œæ¸²æŸ“å‡½æ•°
PageA.render();
```
{% endbox %}