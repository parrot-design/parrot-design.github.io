---
title: ğŸ”¥Vue2ä¸°å¯Œçš„é€‰é¡¹åˆå¹¶ç­–ç•¥
permalink: posts/vue2-merge-options.html
date: 2024-11-12 13:55
topic: vue2
banner: /assets/topic/vue2/banner/mergeoptions.png
--- 

{% quot ä¸“æ ç¬¬äº”ç¯‡-ä¸°å¯Œçš„é€‰é¡¹åˆå¹¶ç­–ç•¥ %}

# ä¸€ã€å®ä¾‹åŒ–æ—¶åˆå¹¶é€‰é¡¹

åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æ‰§è¡ŒVueåˆå§‹åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¯´åˆ°äº†é€‰é¡¹åˆå¹¶ã€‚

é‚£ä»€ä¹ˆæ˜¯é€‰é¡¹å‘¢ï¼Ÿ

åœ¨ {% mark new Vue(é€‰é¡¹) color:orange %}ä¸­ï¼ŒVueæ„é€ å‡½æ•°ä¸­ä¼ å…¥çš„æ•°æ®å°±æ˜¯é€‰é¡¹ï¼Œä»£è¡¨{% mark ä¼ å…¥çš„é€‰é¡¹ color:orange %}ï¼Œä¸€èˆ¬ä»¥å¯¹è±¡å½¢å¼ä¼ å…¥ã€‚

åœ¨Vueæºç ä¸­ä½¿ç”¨å˜é‡optionsè¡¨ç¤ºé€‰é¡¹ï¼Œåœ¨æºç ä¸­ä½ ç»å¸¸èƒ½çœ‹åˆ° optionsçš„èº«å½±ã€‚
 
> åœ¨å®ä¾‹åŒ–æ—¶éœ€è¦å°†å®ä¾‹å¯¹åº”çš„æ„é€ å‡½æ•°ä¸Šçš„é€‰é¡¹å’Œä¼ å…¥çš„é€‰é¡¹åˆå¹¶åˆ°å®ä¾‹çš„é€‰é¡¹ä¸Šã€‚
 

{% image /assets/topic/vue2/mergeoptions/1.png %}
 
{% box child:codeblock color:purple %}
```js
vm.$options = mergeOptions(
    resolveConstructorOptions(vm.constructor),
    options || {},
    vm
)
```
{% endbox %}

ä¸Šé¢ mergeOptions åˆ™æ˜¯ç”¨äºåˆå¹¶ 2 ä¸ª optionsï¼ŒresolveConstructorOptionsç”¨äºè·å–æ„é€ å‡½æ•°ä¸Šçš„optionsã€‚ 
 
> åœ¨å‰é¢çš„æ–‡ç«  Vueçš„åŸå‹è®¾è®¡ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ vm.constructor å°±æ˜¯æŒ‡çš„ Vueæ„é€ å‡½æ•° 

# äºŒã€Vueæ„é€ å‡½æ•°çš„é»˜è®¤é€‰é¡¹

å‰é¢æˆ‘ä»¬çŸ¥é“ vm.$options ä¸­ä¼šåˆå¹¶Vueæ„é€ å‡½æ•°çš„ optionsã€‚

é‚£ä¹ˆ Vue.options æœ‰å€¼å—ï¼Ÿ 

å®é™…ä¸ŠVueæ„é€ å‡½æ•°æœ¬èº«ä¼šè‡ªå¸¦ä¸€äº›é»˜è®¤çš„é€‰é¡¹ã€‚

åœ¨Vueè¢«å¼•å…¥æ—¶ï¼Œä¼šæ‰§è¡Œå¤šä¸ªæ–¹æ³•ç»™Vue.optionsæ³¨å…¥å±æ€§ã€‚


## 2.1 initGlobalAPIæ–¹æ³•åˆ›å»º Vue.options

initGlobalAPIæ–¹æ³•åœ¨Vueè¢«å¼•å…¥æ—¶æ‰§è¡Œã€‚

{% box child:codeblock color:purple %}
```js
// core/global-api/index.ts

const ASSET_TYPES = ['component','directive','filter'];

const builtInComponents = {
    KeepAlive
}

export function initGlobalAPI(Vue){
    // Object.createç”¨äºåˆ›å»ºä¸€ä¸ªå¯¹è±¡ è¯¥å¯¹è±¡æ²¡æœ‰åŸå‹
    Vue.options = Object.create(null)
    ASSET_TYPES.forEach(type => {
      Vue.options[type + 's'] = Object.create(null)
    });
    Vue.options._base = Vue; 
    extend(Vue.options.components, builtInComponents) 
}
```
{% endbox %}

å¯ä»¥çœ‹åˆ°ï¼ŒinstallGlobalAPIæ–¹æ³•ä¸­åˆ›å»ºäº† Vue.optionsä¸ºä¸€ä¸ªçº¯å‡€çš„ç©ºå¯¹è±¡ï¼Œç„¶ååœ¨optionsä¸Šé¢æ³¨å…¥äº†ä¸€äº›å±æ€§ã€‚


{% mark _baseå°±æ˜¯ Vueæ„é€ å‡½æ•° color:orange %}ã€‚æ¯ä¸ªVueç»„ä»¶éƒ½æ˜¯é€šè¿‡_baseå±æ€§è·å–åˆ°Vueæ„é€ å‡½æ•°ï¼Œç„¶åä½¿ç”¨Vue.extendæ¥ç”Ÿæˆå¯¹åº”çš„ VueComponentæ„é€ å‡½æ•°ã€‚

{% box child:codeblock color:purple %}
> extendæ–¹æ³•æ˜¯vueä¸­çš„ä¸€ä¸ªé€šç”¨æ–¹æ³•ã€‚
>
> ç”¨äºå°†ç¬¬äºŒä¸ªå‚æ•°çš„å€¼åˆå¹¶åˆ°ç¬¬ä¸€ä¸ªå‚æ•°ä¸­ï¼Œè¿”å›ç¬¬ä¸€ä¸ªå‚æ•°ã€‚
>
> ç¬¬äºŒä¸ªå‚æ•°çš„å€¼ç›´æ¥è¦†ç›–è¿›ç¬¬ä¸€ä¸ªå‚æ•°
{% endbox %}

{% folding child:codeblock open:false color:purple extendå‡½æ•°æºç  %}
```js
export function extend(
  to,
  _from
){
  // ç”¨äºåˆå¹¶ç¬¬äºŒä¸ªå‚æ•°åˆ°ç¬¬ä¸€ä¸ªå‚æ•°ä¸­  
  for (const key in _from) {
    // è¦†ç›–å‚æ•°å±æ€§
    to[key] = _from[key]
  }
  return to
}
```
{% endfolding %}

## 2.2 åˆå¹¶æŒ‡ä»¤ & å†…ç½®ç»„ä»¶ 

{% box child:codeblock color:purple %}
```js
// platforms/web/runtime/index
const platformDirectives = {
    model,
    show
}

const platformComponents = {
    Transition,
    TransitionGroup
}


extend(Vue.options.directives, platformDirectives)
extend(Vue.options.components, platformComponents)
```
{% endbox %}

è¯¥æ®µé€»è¾‘ä¹Ÿæ˜¯åœ¨ Vueè¢«å¼•å…¥æ—¶æ‰§è¡Œï¼Œæ‰©å±•äº†ä¸€äº›è·Ÿ webå¹³å°ç›¸å…³çš„æŒ‡ä»¤å’Œç»„ä»¶ã€‚

## 2.3 æ€»ç»“

ç»è¿‡æˆ‘ä»¬çš„ç ”ç©¶å‘ç°ï¼ŒVueæ„é€ å‡½æ•°çš„é»˜è®¤é€‰é¡¹æœ‰ï¼š

1.  {% mark _base color:orange %}ï¼š ä»£è¡¨Vueæ„é€ å‡½æ•°ï¼Œåç»­ç”¨æ¥åˆ›å»ºç»„ä»¶çš„æ„é€ å‡½æ•°VueComponentã€‚
2.  {% mark directive color:orange %}ï¼šä»£è¡¨éœ€è¦æ³¨å†Œçš„æŒ‡ä»¤ï¼Œé»˜è®¤çš„æä¾›äº† v-modelã€v-showçš„å†…ç½®æŒ‡ä»¤ã€‚
3.  {% mark components color:orange %}ï¼šä»£è¡¨éœ€è¦æ³¨å†Œçš„ç»„ä»¶é€‰é¡¹ï¼Œé»˜è®¤æä¾›äº† KeepAliveã€Transitionã€TransitionGroupçš„å†…ç½®ç»„ä»¶ã€‚
4.  {% mark filter color:orange %} ï¼šä»£è¡¨éœ€è¦æ³¨å†Œçš„è¿‡æ»¤å™¨ï¼Œé»˜è®¤æ²¡æœ‰æä¾›é»˜è®¤å€¼ã€‚

{% image /assets/topic/vue2/mergeoptions/2.png %}

{% image /assets/topic/vue2/mergeoptions/4.png %}

# ä¸‰ã€å­ç±»æ„é€ å‡½æ•°çš„ options

å­¦ä¹ å®Œä¸ŠèŠ‚æˆ‘ä»¬çŸ¥é“åœ¨Vueè¢«å¼•å…¥æ—¶ï¼Œåœ¨Vueæ„é€ å‡½æ•°ä¸Šæ³¨å…¥äº†ä¸€äº›é»˜è®¤é€‰é¡¹ã€‚

åœ¨[ä¸“æ ç¬¬ä¸‰ç¯‡](/posts/vue2-constructor.html)ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† Vue.extendå‡½æ•°ã€‚
 
> 1. åœ¨renderé˜¶æ®µç”Ÿæˆè™šæ‹ŸèŠ‚ç‚¹æ—¶ï¼Œä¼šè°ƒç”¨ Vue.extend ç”Ÿæˆç»„ä»¶æ„é€ å‡½æ•°VueComponentï¼Œå¹¶å­˜åœ¨ vnodeä¸Šã€‚
>
> 2. ç„¶ååœ¨updateé˜¶æ®µå¼€å§‹æŒ‚è½½èŠ‚ç‚¹æ—¶ï¼Œä¼šè°ƒç”¨ç»„ä»¶æ„é€ å‡½æ•° VueComponentæ¥åˆ›å»ºç»„ä»¶å®ä¾‹ï¼Œå†è¿›è¡Œåç»­ç»„ä»¶å®ä¾‹åˆå§‹åŒ–ã€æ¸²æŸ“ç­‰æ“ä½œã€‚

é‚£ä¹ˆVueComponentæ„é€ å‡½æ•°ä½œä¸ºVueæ„é€ å‡½æ•°çš„å­ç±»ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿç»§æ‰¿äº†å®ƒçš„é»˜è®¤é€‰é¡¹å‘¢ï¼Ÿ

æˆ‘ä»¬å†æ¬¡æ‰“å¼€ Vue.extend çš„æºç ä¸€æ¢ç©¶ç«Ÿã€‚

{% box child:codeblock color:purple %}
```js
Vue.extend = function(extendOptions){
    extendOptions = extendOptions || {}
    // æ–°å¢_Ctorå±æ€§ 
    const cachedCtors = extendOptions._Ctor || (extendOptions._Ctor = {})
    const Super = this;
    const Sub = function VueComponent(){
        this._init();
    } 
    // mergeOptionsç”¨äºåˆå¹¶2ä¸ªé€‰é¡¹è¿”å›ä¸€ä¸ªåˆå¹¶é€‰é¡¹
    Sub.options = mergeOptions(Super.options, extendOptions)
}
```
{% endbox %}

è™½ç„¶æˆ‘ä»¬ä¸çŸ¥é“ mergeOptionsçš„å…·ä½“é€»è¾‘ï¼Œä½†æ˜¯æˆ‘ä»¬å¾ˆå®¹æ˜“çœ‹å‡ºæ¥ï¼ŒVueComponentæ„é€ å‡½æ•°ä¸Šçš„ optionså±æ€§åˆå¹¶äº†â€œçˆ¶ç±»â€œæ„é€ å‡½æ•°ä¸Šçš„optionså±æ€§ä»¥åŠextendæ–¹æ³•ä¼ å…¥çš„é€‰é¡¹ã€‚
 
> åœ¨ VueComponentæ„é€ å‡½æ•°ä¸Šæ–°å¢äº†ä¸€ä¸ª\_Ctorå±æ€§ï¼Œå¯ä»¥é¿å…æ¯æ¬¡é‡æ–°åˆ›å»ºå­ç±»ï¼Œæé«˜æ€§èƒ½ï¼Œåé¢æˆ‘ä»¬ä¼šä¸“é—¨è¯´è¿™é‡Œï¼Œè¿™é‡Œä¸è¿›è¡Œå±•å¼€ã€‚
 

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼š{% mark å­ç±»æ„é€ å‡½æ•°çš„é€‰é¡¹ç»§æ‰¿äº†å…¶çˆ¶ç±»æ„é€ å‡½æ•°çš„é€‰é¡¹ color:orange %}ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

{% box child:codeblock color:purple %}
```js
const VueComponent = Vue.extend({
    template:`<div>æˆ‘æ˜¯å­ç±»æ„é€ å‡½æ•°</div>`
}); 
```
{% endbox %}

æ­¤æ—¶ VueComponent.options ä¸Šæ—¢åŒ…å«äº†è‡ªèº«ä¼ å…¥çš„ template é€‰é¡¹ï¼Œä¹ŸåŒ…å«äº†ç»§æ‰¿è‡ªVueæ„é€ å‡½æ•°ä¸Šçš„å±æ€§ã€‚
 
> è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨åˆå¹¶çˆ¶ç±»æ„é€ å‡½æ•°çš„ optionsæ—¶ï¼Œä¸åŒ optionçš„åˆå¹¶ç­–ç•¥ä¸åŒï¼Œå¯¹äºcomponentsã€filterã€directivesç­‰å†…ç½®é€‰é¡¹ä¼šåˆå¹¶åˆ°åŸå‹é“¾ä¸­ã€‚ 

{% image /assets/topic/vue2/mergeoptions/3.png %}

{% image /assets/topic/vue2/mergeoptions/5.png %}

æˆ‘ä»¬çŸ¥é“ï¼ŒVueComponentæ„é€ å‡½æ•°æœ¬èº«æ˜¯å…·æœ‰å†æ¬¡æ‰©å±•çš„èƒ½åŠ›çš„ã€‚

{% box child:codeblock color:purple %}
```js
const VueComponentChild = VueComponent.extend({
    data(){
        return {
            name:"VueComponentChildConstructor"
        }
    }
})
```
{% endbox %}

åŒç†ï¼Œ{% mark VueComponentChildConstructoræ˜¯VueComponentçš„å­ç±»ï¼Œæ‰€ä»¥VueComponentChildConstructorå°±ç»§æ‰¿äº†VueComponentçš„ options color:orange %}ã€‚

{% image /assets/topic/vue2/mergeoptions/6.png %}

{% image /assets/topic/vue2/mergeoptions/7.png %}

# å››ã€è·å–æ„é€ å‡½æ•°ä¸Šçš„ options

åœ¨Vueåˆå§‹åŒ–æ“ä½œæ‰§è¡Œæ—¶ï¼Œä½¿ç”¨ resolveConstructorOptions å‡½æ•°æ¥è·å–æ„é€ å‡½æ•°ä¸Šçš„ optionsã€‚

{% box child:codeblock color:purple %}
```js
export function resolveConstructorOptions(Ctor){
    let options = Ctor.options;
    if (Ctor.super) {
        const superOptions = resolveConstructorOptions(Ctor.super)
        const cachedSuperOptions = Ctor.superOptions
        if (superOptions !== cachedSuperOptions) {
            // super option changed,
            // need to resolve new options.
            Ctor.superOptions = superOptions
            // check if there are any late-modified/attached options (#4976)
            const modifiedOptions = resolveModifiedOptions(Ctor)
            // update base extend options
            if (modifiedOptions) {
                extend(Ctor.extendOptions, modifiedOptions)
            }
            options = Ctor.options = mergeOptions(superOptions, Ctor.extendOptions)
            if (options.name) {
                options.components[options.name] = Ctor
            }
        }
    }
    return options;
}
```
{% endbox %}

çœ‹åˆ°è¿™ä¹ˆå¤šä»£ç ï¼Œæƒ³å¿…å¤§å®¶ä¹Ÿæ˜¯æå…¶æ‡µé€¼çš„ã€‚

å› ä¸ºæˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼š

1.  {% mark Vueæ„é€ å‡½æ•°çš„é€‰é¡¹æ˜¯åœ¨åˆå§‹åŒ–æ—¶æ³¨å…¥çš„ color:orange %}ã€‚
2.  {% mark VueComponentæ„é€ å‡½æ•°åŠå…¶æ‰©å±•å­ç±»çš„é€‰é¡¹åˆ™æ˜¯åœ¨extendæ–¹æ³•ä¸­è¿›è¡Œæ³¨å…¥çš„ color:orange %}ã€‚

é‚£ç›´æ¥ä½¿ç”¨{% mark .options color:red %}è·å–æ„é€ å‡½æ•°çš„é€‰é¡¹ä¸å°±è¡Œäº†ï¼Œä¸ºä»€ä¹ˆè¿˜æœ‰è¿™ä¹ˆä¸€å¤§æ®µé€»è¾‘å‘¢ï¼Ÿ

{% box child:codeblock color:purple %}
```js
Vue.options // è·å–Vueæ„é€ å‡½æ•°çš„é€‰é¡¹
VueComponent.options // è·å–VueComponentæ„é€ å‡½æ•°çš„é€‰é¡¹
```
{% endbox %}

å…¶å®è¿™ä¸€æ®µé€»è¾‘ä¸»è¦æ˜¯åº”å¯¹çˆ¶ç±»æ„é€ å‡½æ•°ä¸Šé€‰é¡¹å˜åŒ–çš„æƒ…å†µã€‚

## 4.1 Ctor.super

å¯ä»¥çœ‹åˆ°åªæœ‰ Ctor.super å­˜åœ¨æ—¶æ‰ä¼šèµ°è¿™ä¸€å¤§æ®µé€»è¾‘ã€‚

é‚£ä¹ˆ Ctor.super æŒ‡çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

åœ¨ä½¿ç”¨ extendç”Ÿæˆå­ç±»æ„é€ å‡½æ•°æ—¶ï¼Œä¼šåœ¨å­ç±»æ„é€ å‡½æ•°ä¸Šæ–°å¢äº†ä¸€ä¸ª superå±æ€§ï¼ŒæŒ‡å‘å®ƒçš„çˆ¶ç±»ã€‚

{% box child:codeblock color:purple %}
```js
Vue.extend = function(){
    let Sub = function VueComponent(){
        this._init
    }
    let Super = this;
    // çœç•¥éƒ¨åˆ†ä»£ç 
    // superå³ä»£è¡¨å®ƒçš„çˆ¶ç±»
    Sub['super'] = Super;
}
```
{% endbox %}

æ‰€ä»¥å¦‚æœå­˜åœ¨ super å±æ€§ï¼Œåˆ™ä»£è¡¨ç°åœ¨è¿™é‡Œçš„ Ctorä½¿ç”¨çš„æ˜¯extendç”Ÿæˆçš„VueComponentæ„é€ å‡½æ•°ã€‚æ‰€ä»¥è¿™é‡Œåˆ†ä¸º 2 ç§æƒ…å†µï¼š

1.  æ²¡æœ‰superå±æ€§ï¼Œä»£è¡¨è¿™æ˜¯ Vueæ„é€ å‡½æ•°ï¼Œç›´æ¥è¿”å› Vue.options å³å¯ã€‚

2.  å¦‚æœå­˜åœ¨superå±æ€§ï¼Œä»£è¡¨è¿™æ˜¯extendç”Ÿæˆçš„ VueComponentæ„é€ å‡½æ•°ï¼Œéœ€è¦è¿›è¡Œè¿›ä¸€æ­¥åˆ¤æ–­ã€‚

å› ä¸º VueComponent.optionsçš„å€¼æ˜¯åœ¨ extendæ—¶åˆå¹¶äº†çˆ¶ç±»é€‰é¡¹å’Œextendä¼ å…¥é€‰é¡¹çš„å…¨æ–°é€‰é¡¹ã€‚

æ‰€ä»¥å¦‚æœåç»­Vue.optionså˜åŒ–äº†æ— æ³•è·å–æœ€æ–°çš„é€‰é¡¹ã€‚

## 4.2 åˆ¤æ–­çˆ¶ç±»æ„é€ å‡½æ•°ä¸Šçš„ options æ˜¯å¦å˜åŒ–

é‚£ä¹ˆæœ‰å“ªäº›æ“ä½œå¯ä»¥ä¿®æ”¹çˆ¶ç±»æ„é€ å‡½æ•°ä¸Šçš„ optionså‘¢ï¼Ÿ

æ¯”å¦‚ä½¿ç”¨ Vue.mixin apiï¼Œè¿™ä¸ª apiå°±ä¿®æ”¹äº†Vue.optionsé€‰é¡¹ã€‚

è¿™ä¸ªæ—¶å€™å°±éœ€è¦æœ‰ä¸€äº›é€»è¾‘å¯ä»¥æ›´æ–° VueComponentä¸Šçš„ optionsã€‚

æˆ‘ä»¬æ¥çœ‹ä¸‹ Vueæ˜¯æ€ä¹ˆæ›´æ–°çš„ã€‚

{% box child:codeblock color:purple %}
```js
const superOptions = resolveConstructorOptions(Ctor.super)
const cachedSuperOptions = Ctor.superOptions
if (superOptions !== cachedSuperOptions) {
    // è¿›å…¥è¿™ä¸ªé€»è¾‘è¯´æ˜ Vue.optionså˜åŒ–äº†
}
```
{% endbox %}

ä¸Šé¢ä»£ç ä¸­å¦‚æœ superOptions ä¸ç­‰äº cachedSuperOptionsï¼Œå³è¡¨ç¤ºçˆ¶ç±»æ„é€ å‡½æ•°å‘ç”Ÿäº†å˜åŒ–ã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦ææ˜ç™½è¿™ 2 ä¸ªå€¼åˆ†åˆ«è¡¨ç¤ºä»€ä¹ˆï¼Ÿ

1. superOptionsæ˜¯åœ¨resolveConstructorOptionsä¸­é€’å½’å‘ä¸ŠæŸ¥æ‰¾çš„ï¼Œå°±æ˜¯è¡¨ç¤ºçˆ¶ç±»æ„é€ å‡½æ•°çš„æœ€æ–°é€‰é¡¹ã€‚
2. cachedSuperOptions æ˜¯æŒ‡çš„æ„é€ å‡½æ•°ä¸Šçš„ superOptionså±æ€§ï¼Œè¿™ä¸ªå±æ€§æ˜¯åœ¨ extendä¸­å®šä¹‰çš„ï¼š

{% box child:codeblock color:purple %}
```js
Vue.extend = function(){
    let Super = this;
    let Sub = function VueComponent(){
        this._init();
    }
    // è¿™é‡Œå­˜å‚¨çš„å°±æ˜¯çˆ¶ç±»æ„é€ å‡½æ•°çš„ options
    Sub.superOptions = Super.options
}
```
{% endbox %}

æ‰€ä»¥è¿™ 2 ä¸ªå€¼éƒ½æ˜¯æŒ‡çš„çˆ¶ç±»æ„é€ å‡½æ•°ï¼ŒæŒ‡å‘çš„æ˜¯åŒä¸€å—å†…å­˜åœ°å€ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¼šæœ‰ä¸ä¸€æ ·çš„æƒ…å†µå‘¢ï¼Ÿ

åœ¨ Vue æ—§ç‰ˆæœ¬ä¸­æ›¾ç»æœ‰ä¸€ä¸ªç›¸å…³çš„ bugã€‚æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹è¿™ä¸ª bugï¼š

### 4.2.1 Vueæ—§ç‰ˆæœ¬çš„ bug

[github issue #4976](https://github.com/vuejs/vue/issues/4976)

{% image /assets/topic/vue2/mergeoptions/8.png %}

è¿™ä¸ªbugçš„å¤§æ¦‚æ„æ€å°±æ˜¯è¯´ï¼š{% mark å…ˆç”ŸæˆVueComponentæ„é€ å‡½æ•°ï¼Œç„¶åå†åœ¨æ„é€ å‡½æ•°ä¸Šçš„ options æ·»åŠ å±æ€§ï¼Œåœ¨resolveComponentOptionså‡½æ•°æ‰§è¡Œåï¼Œåæ·»åŠ çš„å±æ€§æ¶ˆå¤±äº†ã€‚ color:orange %}

è¿™æ˜¯å¤ç°é“¾æ¥ï¼š[optionsæ¶ˆå¤±](https://jsfiddle.net/vvxLyLvq/2/)ã€‚

æˆ‘ä»¬è¿™é‡Œçœ‹ä¸€ä¸‹ä»£ç ï¼š

{% box child:codeblock color:purple %}
```js
const Test = Vue.extend({
  foo: 'Foo'
})

// Inject options later
// vue-loader and vue-hot-reload-api are doing like this
Test.options.computed = { $style: { test: 'abcde' } }
Test.options.beforeCreate = [
  () => { console.log('Should be printed') }
]
Test.options.render = function (h) {
  return h('div', '$style: ' + this.$style)
}

// Update super constructor's options
Vue.mixin({})

new Vue({
	render: h => h(Test)
}).$mount('#app')

// This is retained
console.log(Test.options.foo)

// Should be appear but not
console.log(Test.options.computed)
console.log(Test.options.beforeCreate)
```
{% endbox %}

å¯ä»¥çœ‹åˆ°é¦–å…ˆä½¿ç”¨ Vue.extend ç”Ÿæˆäº†ä¸€ä¸ª Testæ„é€ å‡½æ•°ã€‚

ç„¶ååœ¨ Testçš„ optionsä¸Šæ–°å¢äº† 2 ä¸ªå±æ€§ã€‚

æ‰§è¡Œå®ŒVue.mixinåï¼Œå…ˆå‰å®šä¹‰çš„{% mark computedã€beforeCreate color:orange %}2ä¸ªå±æ€§ä¸è§äº†ã€‚

### 4.2.2 Vue.mixin

é‚£ä¹ˆè¿™ä¸ª Vue.mixinç©¶ç«Ÿæ˜¯å¹²äº†å•¥å‘¢ï¼Ÿ

{% box child:codeblock color:purple %}
```js
Vue.mixin = function (mixin: Object) {
    this.options = mergeOptions(this.options, mixin)
    return this
}
```
{% endbox %}

å¯ä»¥çœ‹åˆ°mixinå‡½æ•°ä»…ä»…æ˜¯æ”¹å˜äº†æ„é€ å‡½æ•°ä¸Šçš„optionsã€‚

ä½†æ˜¯ mergeOptions ä¼šè¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå¯¼è‡´æ„é€ å‡½æ•°çš„ options å‘ç”Ÿäº†å˜åŒ–ã€‚

ä¹Ÿå°±å¯¼è‡´äº†å‰é¢è¯´çš„ {% mark superOptions !== cachedSuperOptions color:orange %} æƒ…å†µçš„å‘ç”Ÿã€‚

å› ä¸º superOptions è·å–çš„æ˜¯å½“å‰æœ€æ–°çš„é€‰é¡¹ï¼Œä¹Ÿå°±æ˜¯ mixin æ‰§è¡Œè¿‡çš„åˆå¹¶é€‰é¡¹ã€‚

è€Œ cachedSuperOptions åˆ™æ˜¯åœ¨æ‰§è¡Œ Vue.extend æ—¶å½“æ—¶çš„çˆ¶ç±»æ„é€ å‡½æ•°çš„é€‰é¡¹ã€‚

### 4.2.3 æ—§ç‰ˆæœ¬Vueä¸­ resolveConstructorOptions çš„é€»è¾‘æ˜¯ä»€ä¹ˆï¼Ÿ

ä½†æ˜¯ Vue.mixin ä»…ä»…æ˜¯æ›´æ”¹äº† Vue.optionsã€‚

åº”è¯¥ä¸ä¼šå°†VueComponentæ„é€ å‡½æ•°è‡ªèº«æ·»åŠ çš„å±æ€§æ¸…é™¤ã€‚

æ‰€ä»¥åº”è¯¥æ˜¯ Vueå†…éƒ¨å¯¹å…¶åšäº†ä¸€äº›ç‰¹æ®Šå¤„ç†ã€‚

æˆ‘ä»¬æ‰“å¼€ [Vue 2.1.10](https://github.com/vuejs/vue/blob/v2.1.10/src/core/instance/init.js) ç‰ˆæœ¬çš„ç›¸å…³æºç ã€‚

{% box child:codeblock color:purple %}
```js
export function resolveConstructorOptions (Ctor) {
 let options = Ctor.options
  if (Ctor.super) {
    const superOptions = Ctor.super.options
    const cachedSuperOptions = Ctor.superOptions
    const extendOptions = Ctor.extendOptions
    if (superOptions !== cachedSuperOptions) {
      // super option changed
      Ctor.superOptions = superOptions
      extendOptions.render = options.render
      extendOptions.staticRenderFns = options.staticRenderFns
      extendOptions._scopeId = options._scopeId
      options = Ctor.options = mergeOptions(superOptions, extendOptions)
      if (options.name) {
        options.components[options.name] = Ctor
      }
    }
  }
  return options
}
```
{% endbox %}

1.  è·å–äº†çˆ¶æ„é€ å‡½æ•°çš„å½“å‰çš„ optionsï¼š{% mark const superOptions = Ctor.super.options color:orange %}ã€‚
2.  è·å–äº†çˆ¶æ„é€ å‡½æ•°æ‰§è¡Œextendæ—¶çš„optionsï¼š{% mark const cachedSuperOptions = Ctor.superOptions color:orange %}ã€‚
3.  è·å–äº†å­æ„é€ å‡½æ•° extendæ—¶ä¼ å…¥çš„é€‰é¡¹{% mark extendOptions color:orange %}ã€‚
4.  å› ä¸ºæ‰§è¡Œäº†mixinï¼Œå¯¼è‡´çˆ¶æ„é€ å‡½æ•°ä¸­çš„ optionså‘ç”Ÿäº†å˜åŒ–ï¼Œå³{% mark superOptions !== cachedSuperOptions color:orange %}ï¼Œç„¶åç»§ç»­æ‰§è¡Œå†…éƒ¨çš„é€»è¾‘ã€‚

{% box child:codeblock color:purple %}
```js
options = Ctor.options = mergeOptions(superOptions, extendOptions)
```
{% endbox %}

å¯ä»¥çœ‹åˆ°å®ƒæ˜¯å°†è·å–åˆ°çš„çˆ¶æ„é€ å‡½æ•° optionså’Œå½“åˆ extendä¼ å…¥çš„ optionsåˆå¹¶ï¼Œç„¶åé‡æ–°èµ‹å€¼ç»™äº† Ctor.optionsã€‚

æ‰€ä»¥åæ·»åŠ çš„`computed`ã€`beforeCreate`å°±æ¶ˆå¤±äº†ï¼Œå› ä¸ºæŒ‡å‘äº†ä¸åŒçš„å†…å­˜ç©ºé—´ã€‚

{% image /assets/topic/vue2/mergeoptions/9.png %}

### 4.2.4 æ€»ç»“

é€šè¿‡ä¸Šé¢å‡ èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“äº†ä¸ºä»€ä¹ˆéœ€è¦åˆ¤æ–­çˆ¶ç±»æ„é€ å‡½æ•°çš„å˜åŒ–ã€‚

æˆ‘ä»¬ç³»ç»Ÿæä¾›äº†å…¨å±€æ³¨å…¥çš„ APIï¼š{% mark Vue.mixin color:orange %}ã€‚

ä½¿ç”¨è¿™ä¸ªå‡½æ•°å¯ä»¥å‘å…¨å±€æ³¨å…¥ä¸€äº›é€‰é¡¹ã€‚

è€Œå®é™…ä¸Šå°±æ˜¯é€šè¿‡æ”¹å˜Vueæ„é€ å‡½æ•°ä¸Šçš„optionï¼Œå†é€šè¿‡è¿™é‡Œçš„å˜æ›´é€»è¾‘é‡æ–°èµ‹å€¼åˆ° VueComponent.optionsä¸Šï¼Œè¿™æ ·ç”Ÿæˆçš„å®ä¾‹å°±å¯ä»¥è®¿é—®åˆ° Vue.mixinæ³¨å…¥çš„å±æ€§äº†ã€‚


## 4.3 ä½¿ç”¨resolveModifiedOptionsè·å–æ›´æ”¹çš„å±æ€§

åº”å¯¹ä¸Šé¢è¯´çš„è¿™ä¸ª bugï¼ŒVueå®˜æ–¹ä¹Ÿå¯¹è¿™resolveConstructorOptionsæ–¹æ³•è¿›è¡Œäº†è°ƒæ•´ã€‚

é’ˆå¯¹VueComponentæ„é€ å‡½æ•°ä¸Šå¯èƒ½å­˜åœ¨çš„optionsæ›´æ”¹è¿›è¡Œäº†å¤„ç†ã€‚

1.  é¦–å…ˆåœ¨ Vue.extendsä¸­ä¿å­˜äº†VueComponentçš„å½“æ—¶çš„optionsã€‚

{% box child:codeblock color:purple %}
```js
Vue.extend = function(){
    // çœç•¥éƒ¨åˆ†ä»£ç 
    // å­˜å‚¨äº†å½“æ—¶çš„ options
    Sub.sealedOptions = extend({}, Sub.options)
}
```
{% endbox %}

2.  ä½¿ç”¨resolveModifiedOptionsæŸ¥æ‰¾ä¿®æ”¹çš„optionéƒ¨åˆ†

{% box child:codeblock color:purple %}
```js
function resolveModifiedOptions(Ctor){
  let modified
  const latest = Ctor.options
  const sealed = Ctor.sealedOptions
  for (const key in latest) {
    if (latest[key] !== sealed[key]) {
      if (!modified) modified = {}
      modified[key] = latest[key]
    }
  }
  return modified
}
```
{% endbox %}

3.  å°†ä¿®æ”¹çš„ optionsåˆè¿› extendOptions

{% box child:codeblock color:purple %}
```js
if (modifiedOptions) {
    extend(Ctor.extendOptions, modifiedOptions)
}
```
{% endbox %}

4. åˆå¹¶ extendOptionsä»¥åŠ superOptions

extendOptionsæ˜¯æœ€æ–°çš„å­ç±»æ„é€ å‡½æ•° optionsã€‚

superOptionsæ˜¯æœ€æ–°çš„çˆ¶ç±»æ„é€ å‡½æ•° optionsã€‚

å°†ä¸¤è€…åˆå¹¶å°±ä¸ä¼šæœ‰é—®é¢˜äº†ã€‚

{% box child:codeblock color:purple %}
```js
options = Ctor.options = mergeOptions(superOptions, Ctor.extendOptions)
```
{% endbox %}

## 5.4 æ€»ç»“

è¿™ä¸ªå‡½æ•°å¯ä»¥è·å–åˆ°æ„é€ å‡½æ•°ä¸Šæœ€æ–°çš„optionsã€‚

åŒæ—¶å¯ä»¥æ›´æ–°å­ç±»æ„é€ å‡½æ•°å’Œçˆ¶ç±»æ„é€ å‡½æ•°ä¸Šçš„`superOptionsã€extendOptionsä»¥åŠ options`ã€‚

# äº”ã€mergeOptionsçš„åˆå¹¶åœºæ™¯

mergeOptionsåœ¨å®ä¾‹åŒ–æ—¶ç”¨äºåˆå¹¶æ„é€ å‡½æ•°çš„ optionså’Œä¼ å…¥çš„ optionsã€‚

mergeOptions æ˜¯å®ç°ç»§æ‰¿å’Œå®ä¾‹åŒ–çš„æ ¸å¿ƒå‡½æ•°ã€‚

{% box child:codeblock color:purple %}
```js
function mergeOptions(parent,child,vm){
  // parentä»£è¡¨åˆå¹¶çˆ¶ç±»
  // childä»£è¡¨åˆå¹¶å­ç±»
  // vmä»£è¡¨å½“å‰çš„ vmå®ä¾‹
  // å¦‚æœvmå®ä¾‹å­˜åœ¨ï¼Œåˆ™è¡¨ç¤ºè¿™æ˜¯åœ¨å®ä¾‹åŒ–æ—¶è°ƒç”¨çš„
}
```
{% endbox %}

mergeOptionså‡½æ•°ä¸ä»…ä»…ç”¨äºç”Ÿæˆå®ä¾‹çš„$optionså±æ€§ã€‚

ä¹Ÿå¯ä»¥ç”¨äºå­ç±»æ„é€ å‡½æ•°å’Œçˆ¶ç±»æ„é€ å‡½æ•°çš„é€‰é¡¹åˆå¹¶ã€‚

åœ¨å¤šä¸ªåœºæ™¯éƒ½æ˜¯ç”¨äº†è¿™ä¸ªå‡½æ•°ã€‚

## 5.1 Vue.extend

{% box child:codeblock color:purple %}
```js
Vue.extend = function(extendOptions){
  // çœç•¥éƒ¨åˆ†ä»£ç 
  Sub.options = mergeOptions(Super.options,extendOptions)
}
```
{% endbox %}

å‰é¢æˆ‘ä»¬å·²ç»å¤šæ¬¡æåŠè¿™ä¸ªæ–¹æ³•äº†ã€‚

è¿™é‡Œçš„ mergeOptions ç”¨äºåˆå¹¶çˆ¶ç±»æ„é€ å‡½æ•°é€‰é¡¹å’Œä¼ å…¥çš„é€‰é¡¹ï¼Œç”Ÿæˆå­ç±»æ„é€ å‡½æ•°çš„é€‰é¡¹ã€‚

åœ¨è¿™é‡Œï¼š{% mark çˆ¶ç±»æ„é€ å‡½æ•°çš„é€‰é¡¹ç›¸å½“äºçˆ¶ç±»ï¼Œè€Œä¼ å…¥çš„é€‰é¡¹ç›¸å½“äºå­ç±» color:orange %}ã€‚ä¸ä¼ å…¥vmå®ä¾‹ã€‚

## 5.2 Vue.mixin

{% box child:codeblock color:purple %}
```js
Vue.mixin = function (mixin: Object) {
  this.options = mergeOptions(this.options, mixin)
  return this
}
```
{% endbox %}

å‰é¢æˆ‘ä»¬ä¹Ÿå¤šæ¬¡æåˆ°è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯ç”¨äºåˆå¹¶æ„é€ å‡½æ•°çš„optionsï¼Œå’Œä¼ å…¥mixiné€‰é¡¹ï¼Œç”Ÿæˆå…¨æ–°çš„æ„é€ å‡½æ•°çš„ optionsã€‚

åœ¨è¿™é‡Œï¼š{% mark æ„é€ å‡½æ•°çš„é€‰é¡¹ç›¸å½“äºçˆ¶ç±»ï¼Œè€Œä¼ å…¥çš„ mixiné€‰é¡¹ç›¸å½“äºå­ç±» color:orange %}ã€‚ä¸ä¼ å…¥vmå®ä¾‹ã€‚

## 5.3 vm.$options

{% box child:codeblock color:purple %}
```js
vm.$options = mergeOptions(
  resolveConstructorOptions(vm.constructor as any),
  options || {},
  vm
)
```
{% endbox %}

è¯¥æ–¹æ³•ç”¨äºåœ¨å®ä¾‹åŒ–çš„æ—¶å€™ç”Ÿæˆå®ä¾‹çš„$optionså±æ€§ã€‚è¿™ä¸ªæ–¹æ³•ä¸»è¦ç”¨äºåˆå¹¶å®ä¾‹å¯¹åº”çš„æ„é€ å‡½æ•°çš„é€‰é¡¹å’Œä¼ å…¥çš„é€‰é¡¹ï¼Œç”Ÿæˆä¸€ä¸ªå®Œæ•´åœ°å®ä¾‹é€‰é¡¹ã€‚

åœ¨è¿™é‡Œï¼š{% mark æ„é€ å‡½æ•°çš„é€‰é¡¹ç›¸å½“äºçˆ¶ç±»ï¼Œè€Œå®ä¾‹åŒ–æ—¶ä¼ å…¥çš„ mixiné€‰é¡¹ç›¸å½“äºå­ç±»`ã€‚`æ­¤æ—¶ä¼ å…¥vmå®ä¾‹ color:orange %}ã€‚

# å…­ã€åˆå¹¶ç­–ç•¥

åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œä¼šå°†æ„é€ å‡½æ•°ä¸Šçš„é€‰é¡¹å’Œç”¨æˆ·ä¼ å…¥çš„é€‰é¡¹è¿›è¡Œåˆå¹¶ï¼Œå°†æœ€ç»ˆçš„åˆå¹¶é€‰é¡¹æ³¨å…¥åˆ°å®ä¾‹ä¸­ã€‚

{% box child:codeblock color:purple %}
```js
vm.$options = mergeOptions(
  resolveConstructorOptions(vm.constructor as any),
  options || {},
  vm
)
```
{% endbox %}

mergeOptionså‡½æ•°ç”¨äºåˆå¹¶2ä¸ªé€‰é¡¹ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„é€‰é¡¹ã€‚

{% box child:codeblock color:purple %}
```js
function mergeOptions(parent,child){
    // çœç•¥éƒ¨åˆ†ä»£ç 
    let key
    const options = {};
    for(key in parent){
        mergeField(key)
    }
    for (key in child) {
        if (!hasOwn(parent, key)) {
            mergeField(key)
        }
    }
    function mergeField(key){
        const strat = strats[key] || defaultStrat;
        options[key] = strat(parent[key], child[key], vm, key)
    }
    return options;
}
```
{% endbox %}

å¤§å®¶å¯ä»¥å…ˆæ€è€ƒä¸€ä¸‹åˆå¹¶2ä¸ªå¯¹è±¡éœ€è¦æ³¨æ„äº›ä»€ä¹ˆå‘¢ï¼Ÿ

å‡è®¾æ„é€ å‡½æ•°çš„optionså’Œä¼ å…¥çš„optionsä¸­éƒ½å­˜åœ¨dataï¼Œè¿™ä¸ªæ—¶å€™åˆå¹¶çš„æ˜¯ï¼š

1.  {% mark ç›´æ¥è¦†ç›–ï¼Ÿ color:red %}
2.  {% mark å¦‚æœè¦†ç›–çš„è¯æ˜¯ä½¿ç”¨æ„é€ å‡½æ•°çš„dataè¿˜æ˜¯ä¼ å…¥çš„data? color:red %}
3.  {% mark è¿˜æ˜¯å°†dataä¸­çš„å†…å®¹å†è¿›è¡Œåˆå¹¶å‘¢ï¼Ÿ color:red %}

{% image /assets/topic/vue2/mergeoptions/10.png %}
 
å®é™…ä¸Šä¸åŒçš„é€‰é¡¹ä¸­çš„éƒ½å­˜åœ¨è‡ªå·±çš„åˆå¹¶é€»è¾‘ã€‚

æ¯”å¦‚dataé€‰é¡¹å’Œç”Ÿå‘½å‘¨æœŸé’©å­é€‰é¡¹åˆå¹¶ç­–ç•¥è‚¯å®šæ˜¯ä¸åŒçš„ã€‚

## 6.1 è‡ªå®šä¹‰ç­–ç•¥

åœ¨Vueä¸­ï¼Œå¯ä»¥è‡ªå·±å®šä¹‰ä¸åŒçš„åˆå¹¶ç­–ç•¥ã€‚

{% box child:codeblock color:purple %}
```js
// å¯ä»¥é…ç½®åˆå¹¶ç­–ç•¥
Vue.config.optionMergeStrategies = {
  customArray:[]
};
```
{% endbox %} 

é…ç½®å®Œä»¥åï¼Œå°±å¯ä»¥åœ¨{% mark optionMergeStrategies %}è·å–ç”¨æˆ·é…ç½®çš„ç­–ç•¥ã€‚

{% box child:codeblock color:purple %}
```js
// æºç ä¸­å®šä¹‰ç­–ç•¥å˜é‡é¦–å…ˆè·å–optionMergeStrategies å¦‚æœæ²¡æœ‰é…ç½® optionMergeStrategies é»˜è®¤æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡
const strats = config.optionMergeStrategies
```
{% endbox %} 

ç„¶åå†åœ¨ stratsè¿™ä¸ªå¯¹è±¡ä¸Šæ·»åŠ å±æ€§ï¼Œå®šä¹‰ä¸åŒçš„ç­–ç•¥ã€‚

{% box child:codeblock color:purple %}
```js
// dataçš„åˆå¹¶ç­–ç•¥
strats.data = (parentVal,ChildVal,vm)=>{
  // xxx
}
// propsçš„åˆå¹¶ç­–ç•¥
strats.props = (parentVal,ChildVal,vm)=>{
  // xxx
}
// computedçš„åˆå¹¶ç­–ç•¥
strats.computed = (parentVal,ChildVal,vm)=>{
  // xxx
}
```
{% endbox %} 


> ç”±äºstratsæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥ä½ å¦‚æœå®šä¹‰äº†å’Œå†…éƒ¨å®šä¹‰çš„ç­–ç•¥ç›¸åŒçš„é€‰é¡¹ï¼Œä¼šè¢«è¦†ç›–æ‰ã€‚ä¹Ÿå°±æ„å‘³ç€ä½ æ— æ³•é‡æ–°å®šä¹‰ dataã€computedã€propsç­‰å†…éƒ¨ç­–ç•¥

ä½†æ˜¯ä½ å¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„é€‰é¡¹ã€‚

{% box child:codeblock color:purple %}
```js
import Vue from "vue/dist/vue.esm.browser" 
import Test from "./Test.vue"
 
Vue.mixin({
    customArray:[1,3,5,8,9]
})
 
const vm = new Vue({
    render: h=>h(Test),
    customArray: [1,4,5,7]
}).$mount("#app")  
 
console.log(vm);
```
{% endbox %} 

æ¯”å¦‚ä½ æƒ³è¦å®ç°ä½ è‡ªå®šä¹‰çš„ customArrayé€‰é¡¹ æ•°ç»„å†…å®¹åˆå¹¶å¹¶ä¸”å»é‡ï¼Œå¯ä»¥ä½¿ç”¨ä½¿ç”¨`optionMergeStrategies`:

{% box child:codeblock color:purple %}
```js
// parentValä»£è¡¨æ„é€ å‡½æ•°ä¸Šçš„é€‰é¡¹å€¼ï¼Œ childValä»£è¡¨ä¼ å…¥çš„é€‰é¡¹å€¼
Vue.config.optionMergeStrategies.customArray = (parentVal,childVal)=>{ 
    // å…¶ä»–Vueç»„ä»¶æ²¡æœ‰å®šä¹‰ä¸è¿›è¡Œå¤„ç†
    if(!childVal) return [];
    return Array.from(new Set([...parentVal,...childVal]))
}
```
{% endbox %} 

æˆ‘ä»¬æ‰“å°ä¸€ä¸‹è¿™ä¸ªå®ä¾‹ï¼Œå¯ä»¥å‘ç°å·²ç»æˆåŠŸäº†ã€‚
 
{% image /assets/topic/vue2/mergeoptions/11.png %}

## 6.2 é»˜è®¤çš„åˆå¹¶ç­–ç•¥

ç”±äºå¯ä»¥é€‰é¡¹é«˜åº¦å¯è‡ªå®šä¹‰ï¼Œæ‰€ä»¥ Vueä¸­å†…ç½®äº†ä¸€å¥—é»˜è®¤çš„åˆå¹¶ç­–ç•¥ã€‚

ä¸»è¦åº”å¯¹æ²¡æœ‰è®¾ç½®å¯¹åº”ç­–ç•¥çš„åˆå¹¶æƒ…å†µã€‚

{% box child:codeblock color:purple %}
```js
const defaultStrat = function (parentVal, childVal) {
  return childVal === undefined ? parentVal : childVal
}
```
{% endbox %} 

å¯ä»¥çœ‹å‡ºæ¥é»˜è®¤çš„åˆå¹¶ç­–ç•¥æ˜¯ä¼ å…¥çš„optionsç›´æ¥å¯¹æ„é€ å‡½æ•°çš„optionsè¿›è¡Œå¼ºåˆ¶è¦†ç›–ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰ã€‚

## 6.3 elã€propsDataçš„åˆå¹¶ç­–ç•¥

å¯ä»¥çœ‹å‡ºæ¥ elã€propsDataçš„åˆå¹¶ç­–ç•¥å’Œé»˜è®¤ç­–ç•¥ä¸€æ ·ï¼Œåªæ˜¯å¤šäº†ä¸€ä¸ªå¼€å‘ç¯å¢ƒçš„æŠ¥é”™æç¤ºã€‚

{% box child:codeblock color:purple %}
```js
if (__DEV__) {
  strats.el = strats.propsData = function (
    parent: any,
    child: any,
    vm: any,
    key: any
  ) {
    if (!vm) {
      warn(
        `option "${key}" can only be used during instance ` +
          'creation with the `new` keyword.'
      )
    }
    return defaultStrat(parent, child)
  }
}
```
{% endbox %} 

é‚£ä¹ˆè¿™ä¸ªæŠ¥é”™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ

> ç­–ç•¥å‡½æ•°çš„çš„ç¬¬ä¸‰ä¸ªå‚æ•°vmä»£è¡¨vueå®ä¾‹ã€‚
>
> è€Œè¿™ä¸ªvmåŒæ—¶ä¹Ÿæ˜¯mergeOptionsçš„ç¬¬ä¸‰ä¸ªå‚æ•°ã€‚
>
> è€Œ mergeOptionsä½œä¸ºä¸€ä¸ªé€šç”¨å‡½æ•°ï¼Œä¸ä»…åªæ˜¯åœ¨å®ä¾‹åˆå§‹åŒ–çš„æ—¶å€™è¢«è°ƒç”¨ï¼ŒåŒæ—¶ä¹Ÿåœ¨Vue.extendã€Vue.mixinç­‰å¤šä¸ªæ–¹æ³•ä¸­è¢«ä½¿ç”¨ï¼Œè¿™ä¸ªæ—¶å€™è¿˜æ²¡æœ‰ç”Ÿæˆ vmå®ä¾‹ï¼Œæ‰€ä»¥ vmä¸ºç©ºã€‚è€Œ elå±æ€§ã€propsDataå±æ€§æ˜¯å±äºè·Ÿå®ä¾‹ç›¸å…³çš„å±æ€§ï¼Œæ‰€ä»¥å¦‚æœåœ¨Vue.mixinç­‰æ–¹æ³•ä¸­æ³¨å…¥ elå±æ€§ï¼Œåˆ™ä¼šæŠ¥é”™ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œè¿™è¡ŒæŠ¥é”™çš„æ„æ€å°±æ˜¯ç¦æ­¢åœ¨é™¤äº†å®ä¾‹åŒ–ä¹‹å¤–çš„åœ°æ–¹æ³¨å…¥ elé€‰é¡¹ã€‚

æ¯”å¦‚è°ƒç”¨ï¼š

{% box child:codeblock color:purple %}
```js
Vue.mixin({
  el:"#select"
})
```
{% endbox %} 

æ§åˆ¶å°å°±ä¼šæŠ¥é”™ï¼š

{% image /assets/topic/vue2/mergeoptions/12.png %}

## 6.4 dataçš„åˆå¹¶ç­–ç•¥

dataé€‰é¡¹åœ¨ Vueä¸­æ— ç–‘æ˜¯ä½¿ç”¨æœ€é¢‘ç¹çš„é€‰é¡¹ä¹‹ä¸€ã€‚

æ‰€ä»¥å®ƒçš„åˆå¹¶ç­–ç•¥ç›¸å½“å¤æ‚ã€‚

{% box child:codeblock color:purple %}
```js
strats.data = function (
  parentVal: any,
  childVal: any,
  vm?: Component
): Function | null {
  if (!vm) {
    if (childVal && typeof childVal !== 'function') {
      __DEV__ &&
        warn(
          'The "data" option should be a function ' +
            'that returns a per-instance value in component ' +
            'definitions.',
          vm
        )

      return parentVal
    }
    return mergeDataOrFn(parentVal, childVal)
  }

  return mergeDataOrFn(parentVal, childVal, vm)
}
```
{% endbox %} 

### 6.4.1 åœ¨å®šä¹‰æ—¶æŠ¥é”™

æˆ‘ä»¬çŸ¥é“é€šå¸¸åœ¨ç»„ä»¶ä¸­ï¼Œå»ºè®®å°† dataå®šä¹‰æˆå‡½æ•°ï¼Œå› ä¸ºå¦‚æœå°† dataå®šä¹‰æˆæ™®é€šå¯¹è±¡ï¼Œåœ¨è¯¥ç»„ä»¶è¢«å¼•å…¥åˆ°å¤šå¤„æ—¶ï¼Œç”±äº extendå‡½æ•°å†…éƒ¨ä¼šç¼“å­˜è¿™ä¸ªæ„é€ å‡½æ•°ï¼Œæ‰€ä»¥ dataä¸­çš„æ•°æ®å¯èƒ½ä¼šè¢«å¤šä¸ªç»„ä»¶å…±äº«ï¼Œå¯¼è‡´ bugçš„äº§ç”Ÿã€‚

childValåœ¨è¿™é‡Œä»£è¡¨ä¼ å…¥çš„é€‰é¡¹ï¼Œå³åœ¨ç»„ä»¶ä¸­å®šä¹‰çš„é€‰é¡¹ã€‚

æ‰€ä»¥ä¼šæç¤ºä½ éœ€è¦å°† dataå®šä¹‰æˆå‡½æ•°ï¼Œå¹¶ä¸”ä¾æ—§è°ƒç”¨ mergeDataOrFnã€‚

åœ¨æ‰§è¡Œæ„é€ å‡½æ•°æ—¶åˆ›å»ºå­ç±»æ„é€ å‡½æ•°æ—¶ï¼Œè™½ç„¶å·²ç»æœ‰äº† vmäº†ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä¼ å…¥ mergeOptionsã€‚

{% box child:codeblock color:purple %}
```js
Vue.extend = function(){
  Sub.options = mergeOptions(Super.options, extendOptions);
}
```
{% endbox %} 

æ‰€ä»¥è¿™ä¸ªæŠ¥é”™æ˜¯åœ¨åˆ›å»ºå­ç±»æ„é€ å‡½æ•°æ—¶è¿›è¡Œæç¤ºçš„ã€‚

### 6.4.2 mergeDataOrFn

{% box child:codeblock color:purple %}
```js
export function mergeDataOrFn(
    parentVal,
    childVal,
    vm
) {
    return function mergedInstanceDataFn() {
        // instance merge
        const instanceData = isFunction(childVal)
            ? childVal.call(vm, vm)
            : childVal
        const defaultData = isFunction(parentVal)
            ? parentVal.call(vm, vm)
            : parentVal
        if (instanceData) {
            return mergeData(instanceData, defaultData)
        } else {
            return defaultData
        }
    }
}
```
{% endbox %} 

è¯¥å‡½æ•°ç”Ÿæˆäº†ä¸€ä¸ªåˆå¹¶å‡½æ•°ã€‚

{% mark å½“è¿™ä¸ªåˆå¹¶å‡½æ•°æ‰§è¡Œçš„æ—¶å€™å°†è·å–æ„é€ å‡½æ•°çš„ä¸Šçš„dataå’Œä¼ å…¥çš„data color:orange %}

1.  å½“ä¼ å…¥çš„é€‰é¡¹ä¸­å­˜åœ¨ dataï¼Œåˆ™è°ƒç”¨mergeDataåˆå¹¶ 2 ä¸ªdataå¹¶è¿”å›ã€‚
2.  å½“ä¼ å…¥çš„é€‰é¡¹ä¸­ä¸å­˜åœ¨ dataæ—¶ï¼Œåˆ™ç›´æ¥è¿”å›æ„é€ å‡½æ•°ä¸Šçš„ dataã€‚

### 6.4.3 mergeData

å½“æ„é€ å‡½æ•°çš„é€‰é¡¹å’Œä¼ å…¥çš„é€‰é¡¹éƒ½å­˜åœ¨ dataæ—¶ï¼Œéœ€è¦è°ƒç”¨ mergeDataå¯¹ 2 ä¸ªé€‰é¡¹è¿›è¡Œåˆå¹¶ã€‚

{% box child:codeblock color:purple %}
```js
function mergeData(
  to,
  from,
  recursive = true
){
  if (!from) return to
  let key, toVal, fromVal

  const keys = hasSymbol
    ? Reflect.ownKeys(from)
    : Object.keys(from)

  for (let i = 0; i < keys.length; i++) {
    key = keys[i]
    // in case the object is already observed...
    if (key === '__ob__') continue
    toVal = to[key]
    fromVal = from[key]
    if (!recursive || !hasOwn(to, key)) {
      set(to, key, fromVal)
    } else if (
      toVal !== fromVal &&
      isPlainObject(toVal) &&
      isPlainObject(fromVal)
    ) {
      mergeData(toVal, fromVal)
    }
  }
  return to
}
```
{% endbox %} 

è¿™ä¸ªå‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯åˆå¹¶ä¸¤ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œå¯ä»¥ç”¨äºåˆå§‹åŒ–ç»„ä»¶çš„æ•°æ®å¯¹è±¡ï¼Œæˆ–è€…åœ¨ç»„ä»¶çš„ created é’©å­ä¸­åˆå¹¶çˆ¶ç»„ä»¶å’Œå­ç»„ä»¶çš„æ•°æ®ã€‚é€šè¿‡ recursive å‚æ•°ï¼Œå®ƒå¯ä»¥çµæ´»åœ°è¿›è¡Œæµ…åˆå¹¶æˆ–æ·±åº¦åˆå¹¶ã€‚

ç”±äºå…¶ä¸­æ¶‰åŠåˆ°å“åº”å¼æ•°æ®çš„å†…å®¹ï¼Œæ‰€ä»¥ä¸åœ¨è¿™é‡Œæ·±å…¥è®¨è®ºã€‚

åé¢ä¼šå•ç‹¬å‡ºå“åº”å¼æ•°æ®çš„å†…å®¹ã€‚

## 6.5 ç”Ÿå‘½å‘¨æœŸçš„åˆå¹¶ç­–ç•¥

{% box child:codeblock color:purple %}
```js
export const LIFECYCLE_HOOKS = [
  'beforeCreate',
  'created',
  'beforeMount',
  'mounted',
  'beforeUpdate',
  'updated',
  'beforeDestroy',
  'destroyed',
  'activated',
  'deactivated',
  'errorCaptured',
  'serverPrefetch',
  'renderTracked',
  'renderTriggered'
]

LIFECYCLE_HOOKS.forEach(hook => {
  strats[hook] = mergeLifecycleHook
})

// ç”Ÿå‘½å‘¨æœŸçš„åˆå¹¶ç­–ç•¥
export function mergeLifecycleHook(
  parentVal,
  childVal
){
  const res = childVal
    ? parentVal
      ? parentVal.concat(childVal)
      : isArray(childVal)
      ? childVal
      : [childVal]
    : parentVal
  return res ? dedupeHooks(res) : res
}
function dedupeHooks(hooks) {
  const res = []
  for (let i = 0; i < hooks.length; i++) {
    if (res.indexOf(hooks[i]) === -1) {
      res.push(hooks[i])
    }
  }
  return res
}
```
{% endbox %} 

ä¸Šé¢è¿™ä¸ªä¸‰å…ƒè¡¨è¾¾å¼è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ã€‚

1.  å¦‚æœå­ç±»å’Œçˆ¶ç±»éƒ½æ‹¥æœ‰ç›¸åŒçš„é’©å­é€‰é¡¹ï¼Œåˆ™å°†å­ç±»é€‰é¡¹å’Œçˆ¶ç±»é€‰é¡¹åˆå¹¶ã€‚
2.  å¦‚æœçˆ¶ç±»ä¸å­˜åœ¨é’©å­é€‰é¡¹ï¼Œå­ç±»å­˜åœ¨æ—¶ï¼Œåˆ™ä»¥æ•°ç»„å½¢å¼è¿”å›å­ç±»é’©å­é€‰é¡¹ã€‚
3.  å½“å­ç±»ä¸å­˜åœ¨é’©å­é€‰é¡¹æ—¶ï¼Œåˆ™ä»¥çˆ¶ç±»é€‰é¡¹è¿”å›ã€‚
4.  å­çˆ¶åˆå¹¶æ—¶ï¼Œæ˜¯å°†å­ç±»é€‰é¡¹æ”¾åœ¨æ•°ç»„çš„æœ«å°¾ï¼Œè¿™æ ·åœ¨æ‰§è¡Œé’©å­æ—¶ï¼Œæ°¸è¿œæ˜¯çˆ¶ç±»é€‰é¡¹ä¼˜å…ˆäºå­ç±»é€‰é¡¹æ‰§è¡Œã€‚

ç®€å•æ€»ç»“ä¸€ä¸‹ï¼š{% mark å¯¹äºç”Ÿå‘½å‘¨æœŸé’©å­é€‰é¡¹ï¼Œå­ç±»å’Œçˆ¶ç±»ç›¸åŒçš„é€‰é¡¹å°†åˆå¹¶æˆæ•°ç»„ï¼Œè¿™æ ·åœ¨æ‰§è¡Œå­ç±»é’©å­å‡½æ•°æ—¶ï¼Œçˆ¶ç±»é’©å­é€‰é¡¹ä¹Ÿä¼šæ‰§è¡Œï¼Œå¹¶ä¸”çˆ¶ä¼šä¼˜å…ˆäºå­æ‰§è¡Œã€‚ color:orange %}

{% image /assets/topic/vue2/mergeoptions/13.png %}

## 6.6 ç»„ä»¶ã€æŒ‡ä»¤ã€è¿‡æ»¤å™¨çš„åˆå¹¶ç­–ç•¥

{% box child:codeblock color:purple %}
```js
export const ASSET_TYPES = ['component', 'directive', 'filter']

ASSET_TYPES.forEach(function (type) {
  strats[type + 's'] = mergeAssets
})

function mergeAssets(
  parentVal,
  childVal,
  vm,
  key
) {
  const res = Object.create(parentVal || null)
  if (childVal) {
    return extend(res, childVal)
  } else {
    return res
  }
}
```
{% endbox %} 

å¾ˆæ˜æ˜¾ ç»„ä»¶ã€æŒ‡ä»¤ã€è¿‡æ»¤å™¨çš„åˆå¹¶ç­–ç•¥å°±æ˜¯ç›´æ¥å¯¹æ„é€ å‡½æ•°çš„é€‰é¡¹è¿›è¡Œè¦†ç›–ã€‚

{% mark Object.create()æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œä½¿ç”¨åˆ›å»ºçš„å¯¹è±¡æ¥æä¾›æ–°åˆ›å»ºçš„å¯¹è±¡çš„__proto__ã€‚ color:orange %}

è¿™æ„å‘³ç€è¿™ä¸ªåˆå¹¶ç­–ç•¥è®©å†…ç½®çš„ä¸€äº›èµ„æºé€‰é¡¹å˜æˆäº†åŸå‹é“¾çš„å½¢å¼ã€‚

è¿™æ ·å­ç±»å¿…é¡»é€šè¿‡åŸå‹é“¾æ‰èƒ½æŸ¥æ‰¾å¹¶ä½¿ç”¨å†…ç½®çš„ç»„ä»¶å’Œå†…ç½®æŒ‡ä»¤ã€‚

## 6.7 watchçš„åˆå¹¶ç­–ç•¥

åœ¨ä½¿ç”¨ Vue è¿›è¡Œå¼€å‘æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å¯¹æ•°æ®å˜åŒ–åšå‡ºå“åº”ï¼Œå°¤å…¶æ˜¯å½“æ¶‰åŠåˆ°éœ€è¦æ‰§è¡Œå¼‚æ­¥æ“ä½œæˆ–è®¡ç®—æˆæœ¬è¾ƒé«˜çš„ä»»åŠ¡æ—¶ï¼Œwatch é€‰é¡¹å°±æ˜¾å¾—å°¤ä¸ºé«˜æ•ˆã€‚

å…³äº watch é€‰é¡¹çš„åˆå¹¶ç­–ç•¥ï¼Œå®ƒä¸ç”Ÿå‘½å‘¨æœŸé’©å­çš„åˆå¹¶æœ‰ç›¸ä¼¼ä¹‹å¤„ï¼šå¦‚æœçˆ¶ç»„ä»¶å’Œå­ç»„ä»¶æœ‰ç›¸åŒçš„è§‚å¯Ÿå­—æ®µï¼Œå®ƒä»¬çš„ watch é€‰é¡¹å°†è¢«åˆå¹¶ä¸ºä¸€ä¸ªæ•°ç»„ã€‚

å½“ç›‘æµ‹åˆ°å­—æ®µå˜åŒ–æ—¶ï¼Œçˆ¶ç±»å’Œå­ç±»çš„ç›‘å¬ä»£ç å°†è¢«åŒæ—¶è§¦å‘ã€‚

ä¸ç”Ÿå‘½å‘¨æœŸé’©å­çš„å¤„ç†æ–¹å¼ä¸åŒï¼Œwatch é€‰é¡¹åœ¨åˆå¹¶åçš„æ•°ç»„ä¸­å¯ä»¥å‘ˆç°å¤šç§å½¢å¼ï¼šå®ƒä»¬å¯ä»¥æ˜¯åŒ…å«é€‰é¡¹çš„å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯å›è°ƒå‡½æ•°ï¼Œæˆ–è€…æ˜¯æ–¹æ³•åçš„å­—ç¬¦ä¸²ã€‚

è¿™ç§çµæ´»æ€§ä½¿å¾— watch é€‰é¡¹èƒ½å¤Ÿé€‚åº”æ›´å¤šçš„ä½¿ç”¨åœºæ™¯ï¼Œæ— è®ºæ˜¯ç®€å•çš„æ•°æ®å˜åŒ–ç›‘å¬è¿˜æ˜¯å¤æ‚çš„å¼‚æ­¥æ“ä½œå¤„ç†ã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒVue å…è®¸å¼€å‘è€…åœ¨ç»„ä»¶å’Œæ··å…¥ä¸­çµæ´»åœ°å®šä¹‰å’Œåˆå¹¶ watch é€‰é¡¹ï¼Œä»è€Œå®ç°ç²¾ç»†åŒ–çš„æ•°æ®ç›‘æ§å’Œç®¡ç†ã€‚

{% box child:codeblock color:purple %}
```js
strats.watch = function (parentVal,childVal,vm,key) {
    //ç«ç‹æµè§ˆå™¨åœ¨Objectçš„åŸå‹ä¸Šæ‹¥æœ‰watchæ–¹æ³•ï¼Œè¿™é‡Œå¯¹è¿™ä¸€ç°è±¡åšäº†å…¼å®¹
    // var nativeWatch = ({}).watch;
    if (parentVal === nativeWatch) { parentVal = undefined; }
    if (childVal === nativeWatch) { childVal = undefined; }
    // æ²¡æœ‰å­ï¼Œåˆ™é»˜è®¤ç”¨çˆ¶é€‰é¡¹
    if (!childVal) { return Object.create(parentVal || null) }
    {
      // ä¿è¯watché€‰é¡¹æ˜¯ä¸€ä¸ªå¯¹è±¡
      assertObjectType(key, childVal, vm);
    }
    // æ²¡æœ‰çˆ¶åˆ™ç›´æ¥ç”¨å­é€‰é¡¹
    if (!parentVal) { return childVal }
    var ret = {};
    extend(ret, parentVal);
    for (var key$1 in childVal) {
      var parent = ret[key$1];
      var child = childVal[key$1];
      // çˆ¶çš„é€‰é¡¹å…ˆè½¬æ¢æˆæ•°ç»„
      if (parent && !Array.isArray(parent)) {
        parent = [parent];
      }
      ret[key$1] = parent
        ? parent.concat(child)
        : Array.isArray(child) ? child : [child];
    }
    return ret
};
```
{% endbox %} 

ä¸‹é¢ç»“åˆå…·ä½“çš„ä¾‹å­çœ‹åˆå¹¶ç»“æœï¼š


{% box child:codeblock color:purple %}
```js
var Parent = Vue.extend({
  watch: {
    'test': function() {
      console.log('parent change')
    }
  }
})
var Child = Parent.extend({
  watch: {
    'test': {
      handler: function() {
        console.log('child change')
      }
    }
  },
  data() {
    return {
      test: 1
    }
  }
})
var vm = new Child().$mount('#app');
vm.test = 2;
// è¾“å‡ºç»“æœ
parent change
child change
```
{% endbox %} 

ç®€è€Œè¨€ä¹‹:{% mark Vue åœ¨å¤„ç† watch é€‰é¡¹çš„åˆå¹¶æ—¶ï¼Œä¼šå°†å­ç»„ä»¶ä¸çˆ¶ç»„ä»¶çš„ watch é€‰é¡¹åˆå¹¶æˆä¸€ä¸ªæ•°ç»„ã€‚è¿™ä¸ªæ•°ç»„ä¸­çš„æˆå‘˜å¯ä»¥æ˜¯å›è°ƒå‡½æ•°ã€åŒ…å«é…ç½®çš„å¯¹è±¡ï¼Œæˆ–è€…æ˜¯æŒ‡å‘å‡½æ•°çš„æ–¹æ³•åã€‚è¿™æ ·çš„è®¾è®¡æä¾›äº†çµæ´»çš„é€‰é¡¹ï¼Œä»¥é€‚åº”ä¸åŒçš„æ•°æ®ç›‘æ§éœ€æ±‚ã€‚ color:orange %}


## 6.8 props methods inject computedåˆå¹¶

åœ¨ Vue çš„æºç è®¾è®¡ä¸­ï¼Œpropsã€methodsã€inject å’Œ computed è¿™äº›é€‰é¡¹è¢«å½’ä¸ºä¸€ç±»ï¼Œå¹¶ä¸”å®ƒä»¬éµå¾ªç›¸åŒçš„åˆå¹¶ç­–ç•¥ã€‚

{% box child:codeblock color:purple %}
```js
strats.props =
    strats.methods =
    strats.inject =
    strats.computed =
    function (
        parentVal,
        childVal,
        vm,
        key
) {
    if (childVal && __DEV__) {
        assertObjectType(key, childVal, vm)
    }
    if (!parentVal) return childVal
    const ret = Object.create(null)
    extend(ret, parentVal)
    if (childVal) extend(ret, childVal)
    return ret
}
```
{% endbox %} 

ç®€è€Œè¨€ä¹‹ã€‚

1.  çˆ¶ç±»æ²¡æœ‰ç›¸åº”çš„é€‰é¡¹ï¼Œåˆ™ç›´æ¥ä½¿ç”¨å­ç±»çš„é€‰é¡¹
2.  å½“çˆ¶ç»„ä»¶å’Œå­ç»„ä»¶éƒ½æä¾›äº†è¿™äº›é€‰é¡¹æ—¶ï¼Œå­ç»„ä»¶çš„é€‰é¡¹ä¼šè¦†ç›–çˆ¶ç»„ä»¶çš„é€‰é¡¹ã€‚è¿™ç§ç­–ç•¥ç¡®ä¿äº†ç»„ä»¶èƒ½å¤Ÿç»§æ‰¿å’Œæ‰©å±•è¡Œä¸ºï¼ŒåŒæ—¶å…è®¸å­ç»„ä»¶é€šè¿‡æä¾›è‡ªå·±çš„é€‰é¡¹æ¥è¦†ç›–ç»§æ‰¿è‡ªçˆ¶ç»„ä»¶æˆ–æ··å…¥çš„é€‰é¡¹ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

{% box child:codeblock color:purple %}
```js
var Parent = Vue.extend({
  methods:{
    handleClick:function(){
      console.log("çˆ¶ç±»ç‚¹å‡»äº‹ä»¶")
    },
    getParentName:function(){
      console.log("è·å–çˆ¶ç±»åç§°")
    }
  }
})
var Child = Parent.extend({
  methods:{
    handleClick:function(){
      console.log("å­ç±»ç‚¹å‡»äº‹ä»¶")
    },
    getChildName:function(){
      console.log("è·å–çˆ¶ç±»åç§°")
    }
  }
})
var vm = new Child().$mount('#app');
console.log(vm.$options.methods);
// åˆå¹¶å­ç±»å’Œçˆ¶ç±»ï¼Œé‡åˆ°ç›¸åŒçš„å±æ€§ï¼Œä½¿ç”¨å­ç±»è¦†ç›–çˆ¶ç±»
{
  getChildName:f(),
  getParentName:f(),
  handleClick:f(),
}
```
{% endbox %} 

## 6.9 provideåˆå¹¶

ç¡®ä¿äº†å­ç»„ä»¶çš„ provide é€‰é¡¹å¯ä»¥è¦†ç›–çˆ¶ç»„ä»¶çš„åŒåé€‰é¡¹ï¼ŒåŒæ—¶ä¿ç•™äº†çˆ¶ç»„ä»¶çš„å…¶ä»–é€‰é¡¹ã€‚è¿™ç§è®¾è®¡å…è®¸ç»„ä»¶åœ¨ç»§æ‰¿å’Œæ‰©å±• provide æ•°æ®æ—¶æœ‰æ›´å¤šçš„çµæ´»æ€§ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒVue å…è®¸å¼€å‘è€…åœ¨ç»„ä»¶æ ‘ä¸­æœ‰æ•ˆåœ°ä¼ é€’æ•°æ®ï¼Œè€Œæ— éœ€é€šè¿‡æ¯ä¸ªå±‚çº§çš„ç»„ä»¶æ˜¾å¼åœ°ä¼ é€’ propsã€‚ 

{% box child:codeblock color:purple %}
```js
strats.provide = function (parentVal, childVal) {
  if (!parentVal) return childVal
  return function () {
    const ret = Object.create(null)
    mergeData(ret, isFunction(parentVal) ? parentVal.call(this) : parentVal)
    if (childVal) {
      mergeData(
        ret,
        isFunction(childVal) ? childVal.call(this) : childVal,
        false // non-recursive
      )
    }
    return ret
  }
}
```
{% endbox %} 
