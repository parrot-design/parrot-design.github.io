---
title: ğŸ”¥Vue2æ¸²æŸ“åŸºç¡€
permalink: posts/vue2-vnode.html
date: 2024-11-13 15:55
topic: vue2
banner: /assets/topic/vue2/banner/vnode.png
--- 

{% quot ä¸“æ ç¬¬å…­ç¯‡-è™šæ‹ŸèŠ‚ç‚¹ä»¥åŠcreateElementå‡½æ•° %}

åœ¨å‰é¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†Vueåˆå§‹åŒ–çš„ä¸€ç³»åˆ—æ“ä½œã€‚
 
å¯ä»¥Vueç»ˆå½’åªæ˜¯ä¸ºäº†ç”»é¡µé¢ã€‚

åé¢çš„ç« èŠ‚å°±å¸¦ç€å¤§å®¶æ¥è§£ææ¸²æŸ“ç›¸å…³çš„é€»è¾‘ï¼Œä¸€æ­¥ä¸€æ­¥è§£æVueæ˜¯å¦‚ä½•å°†æ¨¡æ¿æŒ‚è½½åˆ°é¡µé¢ä¸Šçš„ã€‚

ä½†æ˜¯åœ¨è§£ææ¸²æŸ“ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹Vueæ¡†æ¶æ¸²æŸ“çš„åŸºç¡€-è™šæ‹Ÿ DOMã€‚

# ä¸€ã€æ¸²æŸ“å™¨çš„æ¸²æŸ“æµç¨‹  

åœ¨è®¨è®ºè™šæ‹ŸèŠ‚ç‚¹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹æµè§ˆå™¨æ¸²æŸ“çš„æµç¨‹ã€‚

å½“æµè§ˆå™¨æ¥æ”¶åˆ°ä¸€ä¸ª HTML æ–‡ä»¶åï¼ŒJavaScript å¼•æ“ä¸æµè§ˆå™¨çš„æ¸²æŸ“å¼•æ“éšå³å¼€å§‹è¿è¡Œã€‚

ä»æ¸²æŸ“å¼•æ“çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒé¦–å…ˆä¼šæŠŠ HTML æ–‡ä»¶è§£æä¸ºä¸€ä¸ª DOM æ ‘ã€‚

ä¸æ­¤åŒæ—¶ï¼Œæµè§ˆå™¨ä¼šè¯†åˆ«å¹¶åŠ è½½ CSS æ ·å¼ï¼Œç„¶åå°†å…¶ä¸ DOM æ ‘åˆå¹¶ï¼Œå½¢æˆä¸€ä¸ªæ¸²æŸ“æ ‘ã€‚

åœ¨æœ‰äº†æ¸²æŸ“æ ‘ä¹‹åï¼Œæ¸²æŸ“å¼•æ“ä¼šè®¡ç®—æ‰€æœ‰å…ƒç´ çš„ä½ç½®ä¿¡æ¯ï¼Œæœ€åé€šè¿‡ç»˜åˆ¶æ“ä½œï¼Œåœ¨å±å¹•ä¸Šå‘ˆç°å‡ºæœ€ç»ˆçš„å†…å®¹ã€‚

JavaScript å¼•æ“å’Œæ¸²æŸ“å¼•æ“è™½ç„¶å¤„äºä¸¤ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ä¹‹ä¸­ï¼Œç„¶è€Œ JavaScript å¼•æ“å´èƒ½å¤Ÿè§¦å‘æ¸²æŸ“å¼•æ“å¼€å§‹å·¥ä½œã€‚

å½“æˆ‘ä»¬å€ŸåŠ©è„šæœ¬å»æ›´æ”¹å…ƒç´ çš„ä½ç½®æˆ–è€…å¤–è§‚æ—¶ï¼ŒJavaScript å¼•æ“ä¼šè¿ç”¨ä¸ DOM ç›¸å…³çš„ API æ–¹æ³•æ¥æ“ä½œ DOM å¯¹è±¡ã€‚

æ­¤æ—¶æ¸²æŸ“å¼•æ“ä¾¿å¼€å§‹è¿ä½œï¼Œæ¸²æŸ“å¼•æ“ä¼šè§¦å‘å›æµæˆ–è€…é‡ç»˜æ“ä½œã€‚

æˆ‘ä»¬æ¥äº†è§£ä¸‹å›æµä»¥åŠé‡ç»˜çš„æ¦‚å¿µï¼š

*   å›æµï¼šå½“æˆ‘ä»¬å¯¹DOMçš„ä¿®æ”¹å¼•å‘äº†{% mark å…ƒç´ å°ºå¯¸çš„å˜åŒ– color:orange %}æ—¶ï¼Œæµè§ˆå™¨éœ€è¦é‡æ–°è®¡ç®—å…ƒç´ çš„å¤§å°å’Œä½ç½®ï¼Œæœ€åå°†é‡æ–°è®¡ç®—çš„ç»“æœç»˜åˆ¶å‡ºæ¥ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå›æµã€‚

*   é‡ç»˜ï¼šå½“æˆ‘ä»¬å¯¹DOMçš„ä¿®æ”¹åªå•çº¯{% mark æ”¹å˜å…ƒç´ çš„é¢œè‰² color:orange %}æ—¶ï¼Œæµè§ˆå™¨æ­¤æ—¶å¹¶ä¸éœ€è¦é‡æ–°è®¡ç®—å…ƒç´ çš„å¤§å°å’Œä½ç½®ï¼Œè€Œåªè¦é‡æ–°ç»˜åˆ¶æ–°æ ·å¼ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºé‡ç»˜ã€‚

{% mark å¾ˆæ˜¾ç„¶ï¼Œå›æµæ¯”èµ·é‡ç»˜æ›´åŠ æ¶ˆè€—æ€§èƒ½ã€‚ color:orange %}

é€šè¿‡äº†è§£æµè§ˆå™¨åŸºæœ¬çš„æ¸²æŸ“æœºåˆ¶ï¼Œæˆ‘ä»¬ä¸éš¾è”æƒ³åˆ°ï¼Œå½“ä¸æ–­åœ°é€šè¿‡ JavaScript ä¿®æ”¹ DOM æ—¶ï¼Œå¾ˆå®¹æ˜“åœ¨ä¸ç»æ„é—´è§¦å‘æ¸²æŸ“å¼•æ“çš„å›æµæˆ–è€…é‡ç»˜ï¼Œè€Œè¿™ç§æ“ä½œæ‰€å¸¦æ¥çš„æ€§èƒ½å¼€é”€æ˜¯éå¸¸å·¨å¤§çš„ã€‚

å› æ­¤ï¼Œä¸ºäº†é™ä½æ€§èƒ½å¼€é”€ï¼Œæˆ‘ä»¬éœ€è¦åšçš„æ˜¯å°½å¯èƒ½åœ°å‡å°‘å¯¹ DOM çš„æ“ä½œã€‚

è™šæ‹ŸèŠ‚ç‚¹å°±æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹å­•è‚²è€Œç”Ÿã€‚
 

# äºŒ. ç¼“å†²å±‚-è™šæ‹ŸDOM

è™šæ‹Ÿ DOM ï¼ˆVirtual DOM ä»¥ä¸‹ç®€ç§° VDOMï¼‰æ˜¯ä¸ºäº†è§£å†³é¢‘ç¹æ“ä½œ DOM æ‰€å¼•å‘çš„æ€§èƒ½é—®é¢˜è€Œäº§ç”Ÿçš„äº§ç‰©ã€‚

VDOMæ˜¯æŠŠé¡µé¢çš„çŠ¶æ€æŠ½è±¡æˆ JS å¯¹è±¡çš„å½¢å¼å‘ˆç°ã€‚

ä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œå®ƒå¤„äº JS ä¸çœŸå® DOM ä¹‹é—´ï¼Œèµ·ç€ä¸­é—´å±‚çš„ä½œç”¨ã€‚

å½“æˆ‘ä»¬éœ€è¦ä½¿ç”¨ JS è„šæœ¬è¿›è¡Œå¤§æ‰¹é‡çš„ DOM æ“ä½œæ—¶ï¼Œä¼šä¼˜å…ˆåœ¨è™šæ‹Ÿ VDOM è¿™ä¸ª JS å¯¹è±¡ä¸Šè¿›è¡Œæ“ä½œã€‚

æœ€åï¼Œé€šè¿‡å¯¹æ¯”æ‰¾å‡ºå°†è¦æ”¹åŠ¨çš„éƒ¨åˆ†ï¼Œå¹¶å°†è¿™äº›æ”¹åŠ¨é€šçŸ¥å¹¶æ›´æ–°åˆ°çœŸå®çš„ DOM ä¸Šã€‚

å°½ç®¡æœ€ç»ˆä»ç„¶æ˜¯å¯¹çœŸå®çš„ DOM è¿›è¡Œæ“ä½œï¼Œç„¶è€Œè™šæ‹Ÿ DOM èƒ½å¤Ÿå°†å¤šä¸ªæ”¹åŠ¨åˆå¹¶ä¸ºä¸€ä¸ªæ‰¹é‡æ“ä½œã€‚

è¿™æ ·åšå¯ä»¥å‡å°‘ DOM é‡æ’çš„æ¬¡æ•°ï¼Œè¿›è€Œç¼©çŸ­ç”Ÿæˆæ¸²æŸ“æ ‘ä»¥åŠè¿›è¡Œç»˜åˆ¶æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸€ä¸ªçœŸå®çš„ DOM å…·ä½“åŒ…å«äº†å“ªäº›å†…å®¹ã€‚

{% image /assets/topic/vue2/vnode/1.png %}

æµè§ˆå™¨å°†çœŸå®çš„ DOM è®¾è®¡å¾—æä¸ºå¤æ‚ã€‚

å®ƒä¸ä½†åŒ…å«äº†è‡ªèº«çš„å±æ€§æè¿°ï¼Œå¦‚å¤§å°ã€ä½ç½®ç­‰å®šä¹‰ï¼Œè¿˜å›Šæ‹¬äº† DOM æ‰€æ‹¥æœ‰çš„æµè§ˆå™¨äº‹ä»¶ç­‰å†…å®¹ã€‚

æ­£æ˜¯ç”±äºå…¶å¦‚æ­¤å¤æ‚çš„ç»“æ„ï¼Œæˆ‘ä»¬é¢‘ç¹åœ°å»æ“ä½œ DOM æˆ–å¤šæˆ–å°‘ä¼šç»™æµè§ˆå™¨å¸¦æ¥æ€§èƒ½æ–¹é¢çš„é—®é¢˜ã€‚

è€Œä½œä¸ºæ•°æ®ä¸çœŸå® DOM ä¹‹é—´çš„ä¸€å±‚ç¼“å†²ï¼Œè™šæ‹Ÿ DOM åªæ˜¯ç”¨äºæ˜ å°„åˆ°çœŸå® DOM è¿›è¡Œæ¸²æŸ“ï¼Œæ‰€ä»¥å¹¶ä¸éœ€è¦åŒ…å«æ“ä½œ DOM çš„æ–¹æ³•ã€‚

å®ƒåªéœ€åœ¨å¯¹è±¡ä¸­é‡ç‚¹å…³æ³¨å‡ ä¸ªå±æ€§å°±å¯ä»¥äº†ã€‚

# ä¸‰ã€ VNode

{% box child:codeblock color:purple %}
```js
// çœŸå®DOM
<div id="app"><span>Hello World</span></div>

// çœŸå®DOMå¯¹åº”çš„JSå¯¹è±¡(VNode)
{
  tag:'div',
  data:{
    id:'app'
  },
  children:[{
    tag:'span',
    children:[
      {
        tag:undefined,
        text:'Hello World'
      }
    ]
  }]
} 
```
{% endbox %}

é€šè¿‡ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥{% mark æ¯ä¸€ä¸ª DOMèŠ‚ç‚¹ éƒ½å¯ä»¥ä½¿ç”¨ä¸€ä¸ª VNode æ¥è¡¨ç¤º color:orange %}ã€‚

åœ¨ Vueå†…éƒ¨ï¼Œä½¿ç”¨ VNode è¿™ä¸ªæ„é€ å‡½æ•°å»æè¿°ä¸€ä¸ªèŠ‚ç‚¹ã€‚ 

{% box child:codeblock color:purple %}
```js
export default class VNode {
  tag?: string
  data: VNodeData | undefined
  children?: Array<VNode> | null
  text?: string
  elm: Node | undefined
  ns?: string
  context?: Component // rendered in this component's scope
  key: string | number | undefined
  componentOptions?: VNodeComponentOptions
  componentInstance?: Component // component instance
  parent: VNode | undefined | null // component placeholder node

  // strictly internal
  raw: boolean // contains raw HTML? (server only)
  isStatic: boolean // hoisted static node
  isRootInsert: boolean // necessary for enter transition check
  isComment: boolean // empty comment placeholder?
  isCloned: boolean // is a cloned node?
  isOnce: boolean // is a v-once node?
  asyncFactory?: Function // async component factory function
  asyncMeta: Object | void
  isAsyncPlaceholder: boolean
  ssrContext?: Object | void
  fnContext: Component | void // real context vm for functional nodes
  fnOptions?: ComponentOptions | null // for SSR caching
  devtoolsMeta?: Object | null // used to store functional render context for devtools
  fnScopeId?: string | null // functional scope id support
  isComponentRootElement?: boolean | null // for SSR directives

  constructor(
    tag?: string,
    data?: VNodeData,
    children?: Array<VNode> | null,
    text?: string,
    elm?: Node,
    context?: Component,
    componentOptions?: VNodeComponentOptions,
    asyncFactory?: Function
  ) {
    this.tag = tag
    this.data = data
    this.children = children
    this.text = text
    this.elm = elm
    this.ns = undefined
    this.context = context
    this.fnContext = undefined
    this.fnOptions = undefined
    this.fnScopeId = undefined
    this.key = data && data.key
    this.componentOptions = componentOptions
    this.componentInstance = undefined
    this.parent = undefined
    this.raw = false
    this.isStatic = false
    this.isRootInsert = true
    this.isComment = false
    this.isCloned = false
    this.isOnce = false
    this.asyncFactory = asyncFactory
    this.asyncMeta = undefined
    this.isAsyncPlaceholder = false
  }

  // DEPRECATED: alias for componentInstance for backwards compat.
  /* istanbul ignore next */
  get child(): Component | void {
    return this.componentInstance
  }
} 
```
{% endbox %}

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ new å…³é”®å­—æ¥åˆ›å»ºä¸€ä¸ª VNodeã€‚ 
 
{% box child:codeblock color:purple %}
```js
// åˆ›å»ºä¸€ä¸ªdivçš„ vnode
new VNode('div',{},'Hello World')
// åˆ›å»ºä¸€ä¸ªæœ‰å­èŠ‚ç‚¹çš„ vnode
new VNode('div',{},[
    new VNode('span',{},'1'),
    new VNode('span',{},'2'),
    new VNode('span',{},'3')
])
```
{% endbox %}

VNodeè¿™ä¸ªæ„é€ å‡½æ•°ä¸Šæœ‰éå¸¸å¤šçš„å±æ€§ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆåˆ—ä¸¾å››ä¸ªå¸¸ç”¨çš„å±æ€§ï¼š`tagã€dataã€childrenã€text`ã€‚

å…¶ä½™å±æ€§åœ¨æˆ‘ä»¬åé¢çš„è§£æä¸­ä¼šä¸€ä¸€è¿›è¡Œè§£æã€‚

## 3.1 tagå±æ€§

tagè¡¨ç¤ºåˆ›å»ºçš„è™šæ‹ŸèŠ‚ç‚¹çš„æ ‡ç­¾åç§°ã€‚

å†³å®šäº†æœ€ç»ˆä¼šæ¸²æŸ“æˆä»€ä¹ˆæ ·çš„ DOMå…ƒç´ ã€‚

tagå¯ä»¥æ˜¯ HTML å…ƒç´ ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²{% mark 'span'ã€'div' color:orange %}ã€‚

ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç»„ä»¶å¼•ç”¨ï¼ŒåŒæ ·å¯ä»¥æ˜¯ä¸€ä¸ªåŠ¨æ€æ ‡ç­¾ã€‚

 
{% box child:codeblock color:purple %}
```js
// ç¼–è¯‘å‰ï¼ˆæ™®é€šèŠ‚ç‚¹ï¼‰
<div></div> 
// ç¼–è¯‘å
VNode {
  tag:"div"
}
// ç¼–è¯‘å‰ï¼ˆç»„ä»¶èŠ‚ç‚¹ï¼‰
<CustomComponent></CustomComponent> 
// ç¼–è¯‘å
VNode {
  tag:"CustomComponent"
} 
```
{% endbox %}

## 3.2 dataå±æ€§

data å‚æ•°é€šå¸¸æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«äº†ç”¨äºæè¿° VNode çš„å„ç§å±æ€§å’Œé…ç½®ä¿¡æ¯ã€‚

data å‚æ•°å¯ä»¥ç”±ä»¥ä¸‹å‡ ç§æ„æˆï¼š

*   `attrs`:è¡¨ç¤ºå…ƒç´ çš„ä¸Šé™æ€å±æ€§ï¼Œå¦‚srcã€altç­‰ã€‚
*   `staicClass`:è¡¨ç¤ºå…ƒç´ ä¸Šçš„é™æ€cssç±»ã€‚
*   `style`:è¡¨ç¤ºå…ƒç´ ä¸Šçš„å†…è”æ ·å¼ã€‚
*   `on`:è¡¨ç¤ºå…ƒç´ ä¸Šçš„äº‹ä»¶ç›‘å¬å™¨ã€‚
*   `slot`:è¡¨ç¤ºä½œç”¨åŸŸæ’æ§½æˆ–æ™®é€šæ’æ§½çš„ä½ç½®ã€‚
*   `props`:è¡¨ç¤ºä¼ é€’ç»„ä»¶çš„ props æ•°æ®ã€‚
*   `directives`:è¡¨ç¤ºæ·»åŠ çš„è‡ªå®šä¹‰çš„è¡Œä¸ºï¼Œå¦‚ v-modelã€v-showç­‰ã€‚
*   `key`:è¡¨ç¤ºç»„ä»¶å”¯ä¸€æ ‡è¯†ã€‚

## 3.3 children

children å‚æ•°æ˜¯æŒ‡å®šä¸€ä¸ª VNodeï¼ˆè™šæ‹ŸèŠ‚ç‚¹ï¼‰çš„å­èŠ‚ç‚¹å†…å®¹ã€‚

è¿™ä¸ªå‚æ•°å¯ä»¥åŒ…å«å¤šç§ç±»å‹çš„æ•°æ®ï¼Œç”¨äºæè¿°å­èŠ‚ç‚¹çš„ç»“æ„å’Œå†…å®¹ã€‚

## 3.4 text

æˆ‘ä»¬çŸ¥é“å¹¶ä¸æ˜¯æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰tagçš„ï¼Œæ¯”å¦‚æ–‡å­—èŠ‚ç‚¹å°±æ²¡æœ‰tagã€‚

åœ¨Vueä¸­ï¼Œæ–‡å­—ä¹Ÿä»£è¡¨ä¸€ä¸ªvnodeã€‚

{% box child:codeblock color:purple %}
```js
// ç¼–è¯‘å‰
"æˆ‘æ˜¯" 
// ç¼–è¯‘å
VNode {
  text:"æˆ‘æ˜¯"
}
``` 
{% endbox %}

## 3.1.5 elm

æˆ‘ä»¬çŸ¥é“åœ¨æ¸²æŸ“æ—¶ä¼šæ ¹æ® VNode åˆ›å»ºDOMå…ƒç´ ã€‚

æ¸²æŸ“åæ¯ä¸ªVNodeèŠ‚ç‚¹éƒ½æœ‰å¯¹åº”çš„çœŸå® DOMå…ƒç´ ã€‚

è€Œè¿™ä¸ª elm å°±æŒ‡å‘è¿™ä¸ªçœŸå® DOMå…ƒç´ ã€‚

# å››. createElementå‡½æ•°

ç»è¿‡ä¸Šé¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“è™šæ‹ŸDOMå°±æ˜¯ä¸€ä¸ªJSå¯¹è±¡ï¼Œåªä¸è¿‡ä»–æœ‰å¾ˆå¤šå±æ€§ã€‚

æ‰€ç¤ºè¯´åˆ›å»ºä¸€ä¸ªè™šæ‹ŸDOMä¹Ÿç»ä¸æ˜¯ä»€ä¹ˆéš¾äº‹ï¼Œä½†æ˜¯ Vue æ¡†æ¶ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå‡½æ•°createElementã€‚

è¿™ä¸ªå‡½æ•°å¯ä»¥æ›´æ–¹ä¾¿çš„å¸®æˆ‘ä»¬ç”Ÿæˆè™šæ‹Ÿ DOMï¼Œåœ¨å…¶ä¸­ç£¨å¹³äº†ä¸€äº›ç»†èŠ‚ã€‚

å®ƒè¢«å®šä¹‰åœ¨ `src/core/vdom/create-element.js` ä¸­ï¼š

## 4.1 createElementåœ¨å¼€å‘æ—¶çš„ä½¿ç”¨åœºæ™¯

äº†è§£createElementçš„ä½¿ç”¨åœºæ™¯æœ‰å“ªäº›å¯¹çœ‹æºç æ˜¯æœ‰ä¸€å®šçš„å¸®åŠ©çš„ã€‚

æœ‰åœºæ™¯å¸¦å…¥æºç æ‰çŸ¥é“å¯¹åº”çš„é€»è¾‘æ˜¯åœ¨åšä»€ä¹ˆï¼Œå¦åˆ™ä½ å…‰çœ‹æºç ï¼Œå¯¹äºä¸€äº›é€»è¾‘ä½ æ˜¯æ— æ³•çœ‹æ‡‚çš„ã€‚

### 4.1.1 webpackç¼–è¯‘æ—¶ä½¿ç”¨

Vueæ¡†æ¶åº•å±‚æ¸²æŸ“æ—¶ä¼šè°ƒç”¨å®ä¾‹ä¸Šçš„_renderæ–¹æ³•ï¼Œè¿™ä¸ª renderæ–¹æ³•å®é™…ä¸Šå°±æ˜¯è°ƒç”¨äº†å®ä¾‹é€‰é¡¹ä¸Šçš„ renderæ–¹æ³•ã€‚

{% box child:codeblock color:purple %}
```js
vm._render => vm.$options.render
```
{% endbox %}
ä½ å¯èƒ½ä¼šæœ‰äº›å›°æƒ‘ï¼Œå› ä¸ºå¹³æ—¶æˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨.vueæ–‡ä»¶è¿›è¡Œå•é¡µé¢å¼€å‘ï¼Œæ²¡æœ‰å†™è¿‡ä»€ä¹ˆ renderæ–¹æ³•å•Šï¼Œé‚£è¿™ä¸ª renderæ–¹æ³•æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ

å…¶å®æˆ‘ä»¬å¹³æ—¶ç¼–å†™çš„ templateæ¨¡æ¿æ ‡ç­¾åœ¨ webpacké¢„ç¼–è¯‘é˜¶æ®µä¼šå˜æˆä¸€ä¸ªåˆ›å»ºvnodeçš„å‡½æ•°ã€‚

æ¯”å¦‚æˆ‘ä»¬åœ¨æ¨¡ç‰ˆä¸­ç¼–å†™ä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸²ï¼š

{% box child:codeblock color:purple %}
```js
<template>
  <div>hello world</div>
</template>
```
{% endbox %}

{% mark .vueæ–‡ä»¶åœ¨webpacké¢„ç¼–è¯‘æ—¶ä¼šè§£ææˆä¸€ä¸ªå¯¹è±¡ï¼Œè€Œæ¨¡æ¿éƒ¨åˆ†åˆ™ä¼šç¼–è¯‘æˆ renderå‡½æ•°ã€‚ color:orange %}

{% image /assets/topic/vue2/vnode/2.png %}

æ‰€ä»¥å¹³æ—¶æˆ‘ä»¬`import Test from "./Test"`ï¼Œè¿™é‡Œçš„Testæ‰“å°å‡ºæ¥æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚

æˆ‘ä»¬å†çœ‹ä¸€ä¸‹è¿™é‡Œç¼–è¯‘çš„ renderæ–¹æ³•ï¼Œå‘ç°äº†æ²¡æœ‰ä½¿ç”¨ createElementå‡½æ•°æ¥åˆ›å»ºèŠ‚ç‚¹ï¼Œè€Œä½¿ç”¨äº†_cã€‚

é‚£ä¹ˆè¿™é‡Œçš„_cä»£è¡¨ä»€ä¹ˆï¼Ÿ

_cå®é™…ä¸Šæ˜¯åœ¨ vueåˆå§‹åŒ–æ—¶åœ¨initRenderæ–¹æ³•ä¸­æ³¨å…¥çš„ï¼Œæœ¬è´¨ä¸Šä¹Ÿå°±æ˜¯è°ƒç”¨äº† createElementã€‚

{% box child:codeblock color:purple %}
```js
vm._c = (a, b, c, d) => createElement(vm, a, b, c, d, false)
```
{% endbox %}

### 4.1.2 ç”¨æˆ·è‡ªå®šä¹‰renderæ–¹æ³•

æˆ‘ä»¬çŸ¥é“.vueæ–‡ä»¶ä¼šè¢«è§£ææˆä¸€ä¸ªå¯¹è±¡çš„å½¢å¼ã€‚

æ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å†™ä¸€ä¸ª jsæ–‡ä»¶ï¼Œè‡ªå·±å®šä¹‰ renderæ–¹æ³•ã€‚Vueæä¾›äº†è¿™ç§èƒ½åŠ›ã€‚

æˆ‘ä»¬ä¸€èˆ¬ä¼šè¿™ä¹ˆè‡ªå®šä¹‰å‡½æ•°ã€‚

{% box child:codeblock color:purple %}
```js
{
  render:(h)=>{
    return {
      h('div','hello world')
    }
  }
}
```
{% endbox %}

è€Œæºç ä¸­ä¼šå°† vm.$createElementä¼ å…¥ renderæ–¹æ³•ä¸­ã€‚

{% box child:codeblock color:purple %}
```js
try { 
  vnode = render.call(vm._renderProxy, vm.$createElement)
} catch (e: any) {
  ///
}
```
{% endbox %}

æ‰€ä»¥è¿™é‡Œçš„ vm.$createElementå°±æ˜¯hå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯åˆ›å»º VNodeçš„å‡½æ•°ã€‚

> $createElementå’Œ_cä¸€æ ·ä¹Ÿæ˜¯åœ¨vueåˆå§‹åŒ–æ—¶åœ¨initRenderæ–¹æ³•ä¸­æ³¨å…¥çš„ã€‚
 
{% box child:codeblock color:purple %}
```js
vm.$createElement = (a, b, c, d) => createElement(vm, a, b, c, d, true)
```
{% endbox %}

> _cå’Œ$createElementçš„ä¸åŒä¹‹å¤„æ˜¯$createElementä¸­å¯¹äº createElementçš„ç¬¬å…­ä¸ªå‚æ•°ä¼ é€’çš„å€¼ä¸åŒã€‚
 

## 4.2 createElementå‡½æ•°è§£æ

{% box child:codeblock color:purple %}
```js
export function createElement(
  context: Component,
  tag: any,
  data: any,
  children: any,
  normalizationType: any,
  alwaysNormalize: boolean
): VNode | Array<VNode> {
  if (isArray(data) || isPrimitive(data)) {
    normalizationType = children
    children = data
    data = undefined
  }
  if (isTrue(alwaysNormalize)) {
    normalizationType = ALWAYS_NORMALIZE
  }
  return _createElement(context, tag, data, children, normalizationType)
}
``` 
{% endbox %}
 
createElementçš„å‚æ•°åˆ†åˆ«æ˜¯ï¼š
1. ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºcontextï¼šè¡¨ç¤ºä¸Šä¸‹æ–‡ï¼Œä¸€èˆ¬è¿™é‡Œä¼ é€’çš„æ˜¯vueå®ä¾‹vmã€‚
2. ç¬¬äºŒä¸ªå‚æ•°ä¸º tagï¼šè¡¨ç¤ºåˆ›å»ºçš„è™šæ‹ŸèŠ‚ç‚¹çš„æ ‡ç­¾ã€‚
3. ç¬¬ä¸‰ä¸ªå‚æ•°ä¸º dataï¼šè¡¨ç¤ºåˆ›å»ºçš„è™šæ‹ŸèŠ‚ç‚¹çš„æ•°æ®ã€‚
4. ç¬¬å››ä¸ªå‚æ•°ä¸º childrenï¼šè¡¨ç¤ºè™šæ‹ŸèŠ‚ç‚¹çš„å­èŠ‚ç‚¹ã€‚
5. ç¬¬äº”ä¸ªå‚æ•°ä¸º normalizationTypeï¼šè¿™ä¸ªå‚æ•°å†³å®šè§„èŒƒåŒ–çš„ç±»å‹ã€‚
6. ç¬¬å…­ä¸ªå‚æ•°ä¸º alwaysNormalizeï¼šè¡¨ç¤ºæ˜¯å¦è§„èŒƒåŒ–å­èŠ‚ç‚¹ã€‚

createElement æ–¹æ³•å®é™…ä¸Šæ˜¯å¯¹ _createElement æ–¹æ³•çš„å°è£…ï¼Œå®ƒå…è®¸ä¼ å…¥çš„å‚æ•°æ›´åŠ çµæ´»ï¼Œåœ¨å¤„ç†è¿™äº›å‚æ•°åï¼Œè°ƒç”¨çœŸæ­£åˆ›å»º VNode çš„å‡½æ•° {% mark _createElement color:orange %}ã€‚
 
### 4.2.1 å¯¹ç¬¬äºŒä¸ªå‚æ•°åšå…¼å®¹ 
 
{% box child:codeblock color:purple %}
```js
// å­˜åœ¨ dataçš„æƒ…å†µ
createElement(context,'div',{style:{color:"red"}},'hello world') 
// ä¸å­˜åœ¨ dataçš„æƒ…å†µ
createElement(context,'div',null,'hello world')
``` 
{% endbox %}

å¦‚ä¸Šï¼Œç¬¬ä¸‰ä¸ªå‚æ•°è¡¨ç¤º dataï¼Œç¬¬å››ä¸ªå‚æ•°è¡¨ç¤ºchildrenã€‚

è€Œå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¼ é€’ dataå±æ€§ï¼Œä½†æ˜¯ç”±äºå‚æ•°é¡ºåºçš„åŸå› ï¼Œä¾æ—§éœ€è¦ä¼ é€’ä¸€ä¸ªç©ºå¯¹è±¡æ¥è¿›è¡Œå ä½ã€‚

è¿™ä¸ªæ—¶å€™å‡½æ•°å†…éƒ¨å¯¹è¿™ä¸ªå‚æ•°è¿›è¡Œäº†å…¼å®¹å¤„ç†ã€‚

åˆ¤æ–­å¦‚æœç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯{% mark æ•°ç»„æˆ–è€…åŸå§‹ç±»å‹ï¼ˆå­—ç¬¦ä¸²ï¼Œæ•°å­—ç­‰ï¼‰ color:orange %}ï¼Œåˆ™å°†å…¶ç¬¬ä¸‰ä¸ªå‚æ•°è§†ä¸ºæ˜¯ä¼ é€’çš„å­èŠ‚ç‚¹ã€‚

åŒæ—¶å°†dataç½®ä¸ºundefinedï¼ŒnormalizationTypeä½¿ç”¨ç¬¬å››ä¸ªå‚æ•°ã€‚

å› æ­¤æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆè°ƒç”¨ï¼Œä¸ç”¨å†ä½¿ç”¨ä¸€ä¸ªå ä½ç¬¦äº†ã€‚

{% box child:codeblock color:purple %}
```js 
// ä¸å­˜åœ¨ dataçš„æƒ…å†µ ä¸éœ€è¦ä¼ é€’ dataè¿›è¡Œå ä½
createElement(context,'div','hello world')
``` 
{% endbox %} 

### 4.2.2 å¯¹childrençš„è§„èŒƒåŒ–

ç”±äºVNodeå®é™…ä¸Šæ˜¯ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ï¼Œæ¯ä¸€ä¸ªVNodeå¯èƒ½ä¼šæœ‰è‹¥å¹²ä¸ªå­èŠ‚ç‚¹ï¼Œè¿™äº›å­èŠ‚ç‚¹åº”è¯¥ä¹Ÿæ˜¯ VNode çš„ç±»å‹ã€‚

_createElement æ¥æ”¶çš„ç¬¬ 4 ä¸ªå‚æ•° children æ˜¯ä»»æ„ç±»å‹çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŠŠå®ƒä»¬è§„èŒƒæˆ VNode ç±»å‹ã€‚

normalizationTypeçš„å€¼æœ‰ 2 ç§ï¼š

1. `SIMPLE_NORMALIZE`ï¼šå€¼ä¸º 1ï¼Œè¡¨ç¤ºç®€å•å¤„ç†å­èŠ‚ç‚¹
2. `ALWAYS_NORMALIZE`ï¼šå€¼ä¸º 2ï¼Œè¡¨ç¤ºé€’å½’å¤„ç†æ‰€æœ‰å­èŠ‚ç‚¹

> éœ€è¦æ³¨æ„çš„æ˜¯å¯¹äºç”¨æˆ·æ‰‹åŠ¨åˆ›å»ºrenderæ–¹æ³•ï¼ŒnormalizationTypeä¸€ç›´ä¸ºALWAYS_NORMALIZEã€‚è¡¨ç¤ºéœ€è¦è§„èŒƒå¤„ç†å­èŠ‚ç‚¹ã€‚
>
> å› ä¸ºç”¨æˆ·æœ‰å¯èƒ½ä¸æ˜¯å¾ˆç†Ÿæ‚‰ createElementçš„ä½¿ç”¨æ–¹å¼å’Œ Vueçš„æ¸²æŸ“æœºåˆ¶å¯¼è‡´ä¸€äº›é”™è¯¯æƒ…å†µçš„å‘ç”Ÿï¼Œå¦‚ä¸‹ï¼š

{% box child:codeblock color:purple %}
```js
// å¦‚æœä¸è¿›è¡Œå¤„ç†ï¼Œåœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­ææœ‰å¯èƒ½ä¼šäº§ç”Ÿé—®é¢˜
render(h){
  return h('ul',[
    "è‹¹æœ",
    "é¦™è•‰",
    "æ¢¨"
  ])
}
```
{% endbox %} 
 
è¿™é‡Œæ ¹æ® normalizationType çš„ä¸åŒï¼Œåˆ†åˆ«è°ƒç”¨äº†{% mark normalizeChildren(children) color:orange %} å’Œ {% mark simpleNormalizeChildren(children) color:orange %}æ–¹æ³•ã€‚

å®ƒä»¬çš„å®šä¹‰éƒ½åœ¨ {% mark src/core/vdom/helpers/normalzie-children.js color:orange %} ä¸­ï¼š

#### 4.2.2.1 simpleNormalizeChildren

å½“ normalizationType ä¸º SIMPLE_NORMALIZE æ—¶ï¼Œæ‰ä¼šè°ƒç”¨simpleNormalizeChildrenæ–¹æ³•ã€‚

é‚£ä¹ˆ normalizationType ä½•æ—¶æ‰ä¼šæ˜¯ SIMPLE_NORMALIZEå‘¢ï¼Ÿ

æˆ‘ä»¬çŸ¥é“ç”¨æˆ·è‡ªå®šä¹‰ renderå‡½æ•°çš„æ—¶å€™ï¼ŒnormalizationTypeæ’ä¸ºALWAYS_NORMALIZEï¼Œæ‰€ä»¥åªæœ‰æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™åœ¨_cä¸­æ‰ä¼šä¼ é€’1ã€‚

ç†è®ºä¸Šç¼–è¯‘ç”Ÿæˆçš„childrenéƒ½å·²ç»æ˜¯ VNodeç±»å‹äº†ï¼Œä¸éœ€è¦å¤„ç†äº†æ‰å¯¹ã€‚

#### 4.2.2.1 normalizeChildrené€’å½’å¤„ç†å­èŠ‚ç‚¹

{% box child:codeblock color:purple %}
```js 
export function normalizeChildren(children: any): Array<VNode> | undefined {
  return isPrimitive(children)
    ? [createTextVNode(children)]
    : isArray(children)
    ? normalizeArrayChildren(children)
    : undefined
}
```
{% endbox %} 

normalizeChildrenæ–¹æ³•æœ‰2ç§å®é™…åº”ç”¨åœºæ™¯ï¼š

1. vueå…è®¸ç”¨æˆ·æŠŠchildrenå†™æˆåŸºç¡€ç±»å‹ç”¨æ¥åˆ›å»ºå•ä¸ªç®€å•çš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œå¯¹åº”è¿™ç§åœºæ™¯ï¼Œvueä¼šè°ƒç”¨ createTextVNodeåˆ›å»ºä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹çš„ VNodeï¼Œå¹¶ä¸”ä¼šè½¬åŒ–æˆæ•°ç»„çš„å½¢å¼ã€‚

{% box child:codeblock color:purple %}
```js
// ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰
{
  render:function(){

  }
}
```
{% endbox %} 

2. 

{% box child:codeblock color:purple %}
```js 
function normalizeArrayChildren(
  children: any,
  nestedIndex?: string
): Array<VNode> {
  const res: VNode[] = []
  let i, c, lastIndex, last
  for (i = 0; i < children.length; i++) {
    c = children[i]
    if (isUndef(c) || typeof c === 'boolean') continue
    lastIndex = res.length - 1
    last = res[lastIndex]
    //  nested
    if (isArray(c)) {
      if (c.length > 0) {
        c = normalizeArrayChildren(c, `${nestedIndex || ''}_${i}`)
        // merge adjacent text nodes
        if (isTextNode(c[0]) && isTextNode(last)) {
          res[lastIndex] = createTextVNode(last.text + c[0].text)
          c.shift()
        }
        res.push.apply(res, c)
      }
    } else if (isPrimitive(c)) {
      if (isTextNode(last)) {
        // merge adjacent text nodes
        // this is necessary for SSR hydration because text nodes are
        // essentially merged when rendered to HTML strings
        res[lastIndex] = createTextVNode(last.text + c)
      } else if (c !== '') {
        // convert primitive to vnode
        res.push(createTextVNode(c))
      }
    } else {
      if (isTextNode(c) && isTextNode(last)) {
        // merge adjacent text nodes
        res[lastIndex] = createTextVNode(last.text + c.text)
      } else {
        // default key for nested array children (likely generated by v-for)
        if (
          isTrue(children._isVList) &&
          isDef(c.tag) &&
          isUndef(c.key) &&
          isDef(nestedIndex)
        ) {
          c.key = `__vlist${nestedIndex}_${i}__`
        }
        res.push(c)
      }
    }
  }
  return res
} 
``` 
{% endbox %} 

## 4.3 createElementå‡½æ•°çš„ä¼˜åŠ¿

createElementå‡½æ•°çš„æ„ä¹‰åœ¨äºå®ƒæä¾›äº†ä¸€ç§æ›´æ–¹ä¾¿ã€æ›´ç®€æ´ä¸”æ›´å…·å¯è¯»æ€§çš„æ–¹å¼æ¥åˆ›å»ºvnodeï¼Œç›¸æ¯”ç›´æ¥ç¼–å†™ VNode å…·æœ‰ä»¥ä¸‹å¥½å¤„ï¼š

### 4.3.1 ç›´è§‚çš„å‚æ•°å½¢å¼

ä½¿ç”¨createElementå‡½æ•°å¯ä»¥é€šè¿‡ç›´è§‚çš„å‚æ•°æ¥æè¿°è™šæ‹ŸèŠ‚ç‚¹çš„å±æ€§ã€‚

ç›¸æ¯”ä¹‹ä¸‹ï¼Œç›´æ¥ç¼–å†™ VNode å¯¹è±¡æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨æ„å»ºä¸€ä¸ªåŒ…å«å¤šä¸ªå±æ€§çš„ JavaScript å¯¹è±¡ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä»£ç è¾ƒä¸ºå†—é•¿å’Œå¤æ‚ï¼Œé™ä½äº†å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

### 4.3.2 ç»Ÿä¸€çš„åˆ›å»ºæ–¹å¼

åœ¨é¡¹ç›®ä¸­ä½¿ç”¨createElementå‡½æ•°å¯ä»¥ç¡®ä¿è™šæ‹ŸèŠ‚ç‚¹çš„åˆ›å»ºæ–¹å¼ä¸€è‡´ã€‚

ç›´æ¥ç¼–å†™ VNode å¯¹è±¡å¯èƒ½ä¼šå¯¼è‡´ä¸åŒçš„å¼€å‘è€…é‡‡ç”¨ä¸åŒçš„æ–¹å¼æ¥æ„å»ºè™šæ‹ŸèŠ‚ç‚¹ï¼Œä»è€Œé™ä½äº†ä»£ç çš„ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

### 4.3.3 åŠ¨æ€å±æ€§å’Œæ¡ä»¶åˆ¤æ–­

createElementå‡½æ•°å¯ä»¥æ¥æ”¶åŠ¨æ€çš„å‚æ•°ï¼Œå…è®¸åœ¨è¿è¡Œæ—¶æ ¹æ®æ¡ä»¶æ¥å†³å®šè™šæ‹ŸèŠ‚ç‚¹çš„å±æ€§ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥æ ¹æ®æ•°æ®çš„å˜åŒ–åŠ¨æ€åœ°æ·»åŠ æˆ–ä¿®æ”¹å±æ€§ï¼Œæˆ–è€…æ ¹æ®æ¡ä»¶åˆ¤æ–­æ¥å†³å®šæ˜¯å¦åˆ›å»ºæŸä¸ªå­èŠ‚ç‚¹ã€‚

ç›´æ¥ç¼–å†™ VNode å¯¹è±¡æ—¶ï¼Œè¦å®ç°ç±»ä¼¼çš„åŠ¨æ€è¡Œä¸ºå¯èƒ½éœ€è¦æ›´å¤šçš„ä»£ç å’Œé€»è¾‘å¤„ç†ï¼Œå¢åŠ äº†ä»£ç çš„å¤æ‚æ€§ã€‚

# äº”ã€æ€»ç»“

ä¸ºäº†é¿å…é‡å¤æ“ä½œçœŸå® DOM æ‰€å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ï¼Œvueæ¡†æ¶å¼•å…¥äº†è™šæ‹Ÿ DOMã€‚

è™šæ‹Ÿ DOMæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå…·æœ‰ç‰¹æœ‰å±æ€§çš„ä¸€ä¸ª JSå¯¹è±¡ã€‚

ä¸ºäº†å®ç°åˆ›å»ºè™šæ‹Ÿ DOM çš„ä¸€è‡´æ€§ï¼Œvueæä¾›äº†ä¸€ä¸ªæ–¹æ³• createElement ç”¨æ¥æ–¹ä¾¿å¿«æ·çš„ç”Ÿæˆè™šæ‹Ÿ DOMã€‚