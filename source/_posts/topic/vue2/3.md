---
title: ğŸ”¥Vue2åŸå‹è®¾è®¡
permalink: posts/vue2-constructor.html
date: 2024-11-11 16:54
topic: vue2
banner: /assets/topic/vue2/banner/constructor.webp
---

&emsp;&emsp;åœ¨å‰é¢ä¸¤å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰äº†æºç çš„ç›®å½•ç»“æ„ä»¥åŠæ„å»ºæ–¹å¼ã€‚

&emsp;&emsp;ä»Šå¤©æˆ‘ä»¬ç»§ç»­æ¥è¯´ä¸‹ Vueçš„åŸå‹è®¾è®¡ã€‚

# ä¸€ã€ä¸ºä»€ä¹ˆVueä¸æ˜¯ä¸€ä¸ª class

Vueè¢«å®šä¹‰åœ¨`core/instance/index.js`æ–‡ä»¶ä¸­ã€‚

{% box child:codeblock color:purple %}
```js
function Vue(options) {
  if (__DEV__ && !(this instanceof Vue)) {
    warn('Vue is a constructor and should be called with the `new` keyword')
  }
  this._init(options)
}
```
{% endbox %}

æˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™ä½¿ç”¨ `new Vue()` è¿›è¡Œå®ä¾‹åŒ–ã€‚

é‚£ä¹ˆ vueæºç ä¸­ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ classå‘¢ï¼Ÿ

Vueä¸­æœ‰å¤§é‡çš„æ‰©å±•å®ä¾‹å±æ€§çš„æ“ä½œå¦‚ï¼š`Vue.prototype.$mount=xxx`ã€‚

å…¶å®æœ¬è´¨ä¸Šç±»åªæ˜¯functionçš„è¯­æ³•ç³–ã€‚

è™½ç„¶è¯´ä½¿ç”¨ç±»ä¹Ÿå¯ä»¥è¿›è¡Œæ‰©å±•ï¼š

{% box child:codeblock color:purple %}
```js
class Animate{
}
Animate.prototype.eat = function(){
    console.log("åŠ¨ç‰©åƒä¸œè¥¿")
}
new Animate().eat();// åŠ¨ç‰©åƒä¸œè¥¿
```
{% endbox %}

ä½†æ˜¯ç”¨ç±»å’ŒåŸå‹è¿™ä¹ˆæ··åˆä½¿ç”¨ï¼Œéš¾å…ä¼šè®©äººæ„Ÿåˆ°ä¸é€‚ï¼Œä¹Ÿç®—æ˜¯ä¸€ç§å¼€å‘è§„èŒƒå’Œä¹ æƒ¯å§ã€‚

å¤§éƒ¨åˆ†å¼€æºåº“ä¾æ—§ä½¿ç”¨çš„æ˜¯ function æ¥åˆ›å»ºæ„é€ å‡½æ•°ã€‚

# äºŒã€å¿…é¡»ä½¿ç”¨newå…³é”®å­—æ¥è°ƒç”¨

å¯ä»¥çœ‹åˆ°åœ¨ Vueæ„é€ å‡½æ•°å†…éƒ¨å­˜åœ¨ä¸€ä¸ªåˆ¤æ–­ `this instanceof Vue`ï¼Œé‚£ä¹ˆè¿™è¡Œä»£ç åº”è¯¥å¦‚ä½•ç†è§£å‘¢ï¼Ÿ

æˆ‘ä»¬çŸ¥é“é€šè¿‡ instanceofå¯ä»¥é¡ºç€åŸå‹é“¾å‘ä¸ŠæŸ¥æ‰¾å¯¹åº”çš„æ„é€ å‡½æ•°ã€‚

æ‰€ä»¥è¿™ä¸ªåˆ¤æ–­çš„æ„æ€å°±æ˜¯æ£€æŸ¥å½“å‰ä¸Šä¸‹æ–‡ï¼ˆthisï¼‰æ˜¯å¦æ˜¯ä¸€ä¸ª Vueå®ä¾‹ã€‚

å¦‚æœä¸æ˜¯ä¸€ä¸ªå®ä¾‹ï¼Œå°±ä¼šç»™ä½ ä¸€ä¸ªè­¦å‘Šã€‚

å‘ŠçŸ¥å¼€å‘è€… Vueåº”è¯¥è¦ä½œä¸ºä¸€ä¸ªæ„é€ å‡½æ•°æ¥ä½¿ç”¨ã€‚

{% box child:codeblock color:purple %}
```js
// instance/index.js
function Vue(options) { 
    if(__DEV__ && !this instanceof Vue){
        warn('Vue is a constructor and should be called with the `new` keyword')
    }
}
```
{% endbox %}

å‡è®¾ä½ è¿™ä¹ˆä½¿ç”¨ Vueï¼š

{% box child:codeblock color:purple %}
```js
const vm = Vue()
```
{% endbox %}

é‚£ä¹ˆä½ å°†ä¼šåœ¨æ§åˆ¶å°çœ‹åˆ°ä¸€æ¡æŠ¥é”™ä¿¡æ¯ã€‚ 

{% image /assets/topic/vue2/constructor/1.png %} 

# ä¸‰ã€Vueçš„åŸå‹è®¾è®¡

Vueæ˜¯ä¸€ä¸ªåŸºäºåŸå‹è®¾è®¡çš„å‰ç«¯æ¡†æ¶ã€‚

åœ¨Vueè¢«å¼•å…¥ï¼ˆimport Vue from 'vue'ï¼‰æ—¶ï¼Œä¼šé€šè¿‡å¤šä¸ªå‡½æ•°åœ¨VueåŸå‹ä¸Šæ·»åŠ ä¸Šä¸€ç³»åˆ—çš„æ–¹æ³•ã€‚

{% box child:codeblock color:purple %}
```js
// è¯¥å‡½æ•°åœ¨ Vueè¢«å¼•å…¥æ—¶æ‰§è¡Œ
export function lifecycleMixin(Vue){
    Vue.prototype._update = ()=>{
        // xxxx
    }
}
```
{% endbox %}

é‚£ä¹ˆåœ¨`Vue.prototype`ä¸Šå®šä¹‰æ–¹æ³•æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ

å‰é¢2èŠ‚ï¼Œæˆ‘ä»¬è¯´åˆ° Vueæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼š

{% box child:codeblock color:purple %}
```js
function Vue(){
    //xxx
}
```
{% endbox %}

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ `newå…³é”®å­—` æ¥åˆ›å»ºä¸€ä¸ª vueå®ä¾‹ã€‚

{% box child:codeblock color:purple %}
```js
const vm = new Vue();
```
{% endbox %}


> 1.  `æ„é€ å‡½æ•°ä¸åŸå‹å¯¹è±¡`ï¼šæ¯ä¸ªæ„é€ å‡½æ•°éƒ½æœ‰ä¸€ä¸ª prototypeå±æ€§ï¼ŒæŒ‡å‘ä¸€ä¸ªå¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡è¢«å«åšåŸå‹å¯¹è±¡ï¼ŒåŒ…å«äº†ç”±è¯¥æ„é€ å‡½æ•°åˆ›å»ºçš„å®ä¾‹å…±äº«å±æ€§å’Œæ–¹æ³•ã€‚
>
> 2.  `å®ä¾‹å¯¹è±¡çš„ __proto__ å±æ€§`ï¼šæ¯ä¸ªå®ä¾‹å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª `__proto__` å±æ€§ï¼ŒæŒ‡å‘æ„é€ å‡½æ•°çš„åŸå‹å¯¹è±¡ã€‚

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼š`Vueæ„é€ å‡½æ•°çš„æ˜¾å¼åŸå‹ï¼ˆVue.prototypeï¼‰å’ŒåŸºäºå®ƒåˆ›å»ºçš„å®ä¾‹çš„éšå¼åŸå‹ï¼ˆvm.__proto__ï¼‰æŒ‡å‘çš„æ˜¯åŒä¸€å—å†…å­˜ç©ºé—´`ã€‚

è€ŒVueæ„é€ å‡½æ•°åŒæ—¶ä¹Ÿæ˜¯ Function çš„å®ä¾‹ã€‚

æ‰€ä»¥ï¼š`Vue.__proto__ === Function.prototype`ã€‚

{% image /assets/topic/vue2/constructor/2.png %}

å½“ Vueå®ä¾‹è®¿é—®æŸä¸ªå±æ€§æ—¶ï¼Œå¦‚æœåœ¨è‡ªèº«å±æ€§ä¸­æ‰¾ä¸åˆ°ï¼Œåˆ™ä¼šæ²¿ç€\_\_proto\_\_å±æ€§æŒ‡å‘çš„åŸå‹å¯¹è±¡è¿›è¡ŒæŸ¥æ‰¾ã€‚

æ‰€ä»¥é€šè¿‡ vm å¯ä»¥è®¿é—®åˆ°å®šä¹‰åœ¨ Vue.prototype çš„å±æ€§å’Œæ–¹æ³•ã€‚

é€šç”¨è¿™ç§æ–¹å¼ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„æ‰©å±•æ–¹æ³•ï¼Œå¹¶ä¸ç”¨æ˜¾ç¤ºçš„åœ¨ vm ä¸Šè®¾ç½®æ–¹æ³•ï¼Œåšåˆ°äº†ç›¸å¯¹éš”ç¦»ã€‚

# å››ã€Vue.extendåˆ©ç”¨åŸå‹é“¾ç»§æ‰¿ç”Ÿæˆâ€œå­ç±»â€œæ„é€ å‡½æ•°

Vue.extendæ˜¯å®šä¹‰åœ¨Vueè¿™ä¸ªæ„é€ å‡½æ•°ä¸Šçš„æ–¹æ³•ã€‚

è¯¥æ–¹æ³•ä¸»è¦ç”¨äºåˆ›å»ºVueæ„é€ å‡½æ•°çš„â€œå­ç±»â€œï¼Œè¯¥â€œå­ç±»â€œç»§æ‰¿ Vueæ„é€ å‡½æ•°ä¸Šçš„åŸå‹æ–¹æ³•å’ŒåŸå‹å±æ€§ã€‚

è™½ç„¶Vueåœ¨æŠ€æœ¯ä¸Šä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ç±»ï¼Œä½†æ˜¯`Vue.extend`æä¾›äº†ä¸€ç§ç±»ä¼¼äºé¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ç»§æ‰¿çš„æ–¹å¼æ¥å®šä¹‰ç»„ä»¶ã€‚

{% box child:codeblock color:purple %}
```js
// å¯¹åŸå‡½æ•°è¿›è¡Œäº†ä¸€äº›ç®€åŒ– åªä¿ç•™äº†æ ¸å¿ƒ
Vue.extend = function(){
    // this ä¸º Vueæ„é€ å‡½æ•°
    const Super = this;
    // Sub ä¸º VueComponentæ„é€ å‡½æ•°ï¼Œä»£è¡¨ç»„ä»¶æ„é€ å‡½æ•°
    const Sub = function VueComponent(this){
        // å’Œ Vueæ„é€ å‡½æ•°ä¸€æ · ä¼šè°ƒç”¨_initæ–¹æ³•
        this._init(options);
    };
    // åŸºäº Vue.prototype åˆ›å»ºä¸€å—æ–°çš„å†…å­˜ï¼Œå…±äº«å…¶å±æ€§å’Œæ–¹æ³•ã€‚
    Sub.prototype = Object.create(Super.prototype);
    // ä¿®æ­£ constructoræŒ‡å‘
    Sub.prototype.constructor = Sub;
    return Sub;
}
```
{% endbox %}

æˆ‘ä»¬ç®€å•çš„åˆ†æä¸€ä¸‹è¿™å‡ è¡Œä»£ç ã€‚

> å£°æ˜äº†Superå˜é‡å’Œ Subå˜é‡åˆ†åˆ«æŒ‡å‘`Vueæ„é€ å‡½æ•°`å’Œ `VueComponentæ„é€ å‡½æ•°`ã€‚

{% image /assets/topic/vue2/constructor/3.png %}

## 4.1 ä½¿ç”¨åœºæ™¯

åœ¨Vueæºç å†…éƒ¨å’Œä½¿ç”¨Vueç¼–å†™ä¸šåŠ¡ä»£ç æ—¶éƒ½å¯ä»¥ä½¿ç”¨ Vue.extendè¿™ä¸ª apiã€‚

### 4.1.1 å†…éƒ¨åˆ›å»ºç»„ä»¶

æ¯ä¸€ä¸ªVueç»„ä»¶éƒ½å¯¹åº”ç€ä¸€ä¸ªå®ä¾‹ã€‚

è€Œè¿™äº›å®ä¾‹éƒ½æ˜¯é€šè¿‡ extend æ–¹æ³•åˆ›å»ºçš„ `VueComponentæ„é€ å‡½æ•°` ç”Ÿæˆçš„ã€‚

åœ¨renderé˜¶æ®µï¼Œä¹Ÿå°±æ˜¯åœ¨ç”Ÿæˆç»„ä»¶çš„vnodeçš„æ—¶å€™ä¼šé€šè¿‡ extend æ–¹æ³•åˆ›å»º`VueComponentæ„é€ å‡½æ•°`ã€‚

å¹¶èµ‹å€¼åˆ° vnode ä¸­çš„ componentOptionså±æ€§ä¸­ã€‚

{% box child:codeblock color:purple %}
```js
//  åˆ›å»ºç»„ä»¶çš„ vnode çš„æ–¹æ³•
export function createComponent(Ctor,context){
    // _baseåœ¨å¼•å…¥æ—¶è¢«è®¾ç½®ä¸º Vue
    // è¿™é‡Œçš„optionsåé¢æˆ‘ä»¬ä¼šè¯¦ç»†è¯´æ˜
    const base = context.$options._base;
    // åˆ›å»ºVueå­ç±»æ„é€ å‡½æ•°
    Ctor = base.extend();
    return new Vnode(
        {componentOptions:{Ctor}}
    )
}
```
{% endbox %}

> è¿™é‡Œçš„`_base`å®é™…ä¸Šå°±æ˜¯ Vueã€‚
>
> è¿™é‡Œçš„ contextæ˜¯vmå®ä¾‹ï¼Œ`vm.$options`æ˜¯åœ¨å®ä¾‹åŒ–æ„é€ å‡½æ•°æ—¶é€šè¿‡ `mergeOptions`å‡½æ•°ç”Ÿæˆçš„ã€‚

ç„¶ååœ¨updateé˜¶æ®µï¼ˆæ¸²æŸ“é¡µé¢ï¼‰ï¼Œä¼šåŸºäºCtorç”Ÿæˆå¯¹åº”çš„å®ä¾‹ï¼Œæ‰§è¡Œç›¸åº”çš„åˆå§‹åŒ–ã€æ¸²æŸ“æ–¹æ³•ç­‰ã€‚

{% box child:codeblock color:purple %}
```js
// æ¯ä¸ªç»„ä»¶éƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥åˆ›å»ºå¯¹åº”çš„å®ä¾‹
// è¿™é‡Œçš„ componentOptions.Ctor å°±æ˜¯å¯¹åº”çš„VueComponentæ„é€ å‡½æ•°
export function createComponentInstanceForVnode(vnode){
    return new vnode.componentOptions.Ctor()
}
```
{% endbox %}

### 4.1.2 åœ¨ä¸šåŠ¡ä¸­çš„å®é™…åº”ç”¨åœºæ™¯

åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæœ‰å¾ˆå¤šåœ°æ–¹éƒ½å¯ä»¥åˆ©ç”¨ extend æ¥æ‰©å±•ç»„ä»¶ã€‚

åŒ…æ‹¬åˆ›å»º`å¯å¤ç”¨çš„ç»„ä»¶`ã€`åŠ¨æ€ç»„ä»¶`ã€`å…¨å±€å’Œå±€éƒ¨æ³¨å†Œ`ã€`ä¸´æ—¶ç»„ä»¶`ã€`è‡ªå®šä¹‰æŒ‡ä»¤å’Œæ’ä»¶`ã€‚

æˆ‘ä»¬å¸¸ç”¨çš„ Elementæ¡†æ¶å†…éƒ¨å°±åˆ©ç”¨äº† Vue.extend æ¥æ‰©å±•æŸäº›ä¸´æ—¶æ€§çš„ç»„ä»¶ï¼Œä¾‹å¦‚æ¨¡æ€å¯¹è¯æ¡†ã€æç¤ºä¿¡æ¯ç­‰ã€‚

é€šè¿‡ Vue.extend åˆ›å»ºçš„ç»„ä»¶æ„é€ å‡½æ•°å¯ä»¥æŒ‰éœ€åˆ›å»ºå’Œé”€æ¯ï¼Œé€‚åˆè¿™ç±»ä¸´æ—¶ç»„ä»¶çš„ç®¡ç†ã€‚

{% box child:codeblock color:purple %}
```js
const Main = {
    template:'<div>hello main</div>'
}

const NotificationConstructor = Vue.extend(Main);

let instance;

const Notification = function() {
    // é€šè¿‡VueComponentåˆ›å»ºç»„ä»¶å®ä¾‹
    instance = new NotificationConstructor();
    // ä½¿ç”¨$mountå¯ä»¥åˆ›å»ºä¸€ä¸ªDOMèŠ‚ç‚¹ å¹¶æŒ‚è½½åˆ°instance.$elä¸Š
    instance.$mount();
    document.body.appendChild(instance.$el);
    return instance;
} 

Notification();
```
{% endbox %}

> $mountæ–¹æ³•å¦‚æœæ²¡æœ‰ä¼ å‚ä¸ä¼šæŒ‚è½½ï¼Œä½†æ˜¯ä¾æ—§å¯ä»¥ç”Ÿæˆ DOMèŠ‚ç‚¹ï¼Œå¹¶èµ‹å€¼åœ¨ vm.$elä¸Šã€‚

åœ¨ element ä¸­çš„ Notificationç»„ä»¶ å°±ä½¿ç”¨äº† extend è¿›è¡Œæ‰©å±•ã€‚

### 4.1.3 ä½¿ç”¨VueComponentç»§ç»­æ‰©å±•å®ƒçš„â€œå­ç±»â€æ„é€ å‡½æ•°

éœ€è¦å…³æ³¨çš„æ˜¯åœ¨Vue.extendä¸­ï¼Œå°†Vue.extendæ–¹æ³•åŒæ—¶èµ‹å€¼ç»™äº† VueComponentã€‚

æ„å‘³ç€èµ‹äºˆäº† VueComponentç»§ç»­æ‰©å±•çš„èƒ½åŠ›ï¼š

{% box child:codeblock color:purple %}
```js
Vue.extend = function(){
    const Super = this;
    const Sub = function VueComponent(){
        this._init();
    }
    // çœç•¥éƒ¨åˆ†ä»£ç 
    Sub.extend = Super.extend;
}
```
{% endbox %}

è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æ— é™çš„åŸºäº VueComponentå’Œå®ƒçš„â€œå­ç±»â€æ‰©å±•å­ç±»ã€‚

{% box child:codeblock color:purple %}
```js
import Vue from "@/my-vue2/platforms/web/entry-runtime-with-compiler-esm"

// åŸºäºVueæ„é€ å‡½æ•°åˆ›å»ºçš„åŸºç¡€æ„é€ å‡½æ•°
const VueComponentConstructor = Vue.extend({
    template:`<div>{{ name }}æˆ‘æ˜¯æ„é€ å‡½æ•°</div>`,
    data(){
        return {
            name:"VueComponentConstructor"
        }
    }
});
// å¯ä»¥å¤ç”¨çˆ¶ç±»æ„é€ å‡½æ•°VueComponentConstructorä¸Šçš„å±æ€§
const VueComponentChild1Constructor = VueComponentConstructor.extend({ 
    data(){
        return {
            name:"VueComponentChild1Constructor"
        }
    }
})
// å¯ä»¥å¤ç”¨çˆ¶ç±»æ„é€ å‡½æ•°VueComponentConstructorä¸Šçš„å±æ€§
const VueComponentChild2Constructor = VueComponentConstructor.extend({ 
    data(){
        return {
            name:"VueComponentChild2Constructor"
        }
    }
})

function addNode(){
    const vm1 = new VueComponentConstructor();
    const vm2 = new VueComponentChild1Constructor();
    const vm3 = new VueComponentChild2Constructor();

    vm1.$mount()
    vm2.$mount()
    vm3.$mount()

    document.body.appendChild(vm1.$el)
    document.body.appendChild(vm2.$el)
    document.body.appendChild(vm3.$el)
}

addNode();
```
{% endbox %}

{% image /assets/topic/vue2/constructor/5.png %}

ä¸Šè¿°ä»£ç ä¸­ï¼ŒVueComponentConstructor æ˜¯é€šè¿‡ Vue.extend åˆ›å»ºçš„ä¸€ä¸ªåŸºç¡€ç»„ä»¶æ„é€ å‡½æ•°ã€‚

åœ¨è¿™ä¸ªåŸºç¡€æ„é€ å‡½æ•°ä¸­ä¼ å…¥äº†æ¨¡æ¿é€‰é¡¹ï¼Œæˆ‘ä»¬ä¹‹ååˆ›å»ºçš„æ„é€ å‡½æ•°å°±å¯ä»¥å¤ç”¨ templateé€‰é¡¹ï¼Œé¿å…ç¼–å†™é‡å¤çš„æ¨¡æ¿ã€‚

{% image /assets/topic/vue2/constructor/4.png %}

æˆ‘ä»¬è¿™é‡Œåªæ˜¯ç®€å•çš„ä¸¾äº†ä¸€ä¸ªä¾‹å­ï¼Œé€šè¿‡è¿™ä¸ªä¾‹å­æˆ‘ä»¬äº†è§£åˆ°äº†extendçš„é‡è¦æ„ä¹‰ã€‚çœŸå®çš„å¤ç”¨ç»“æ„è‚¯å®šæ›´ä¸ºå¤æ‚ã€‚

ä¸è¿‡åœ¨å®é™…å¼€å‘ä¸­ï¼Œä¸€èˆ¬æˆ‘ä»¬åº”ç”¨ä¸­åŸºæœ¬åªå­˜åœ¨ Vueæ„é€ å‡½æ•°å’Œå®ƒçš„ç›´æ¥æ„é€ å‡½æ•° VueComponentã€‚

åœ¨ç»„ä»¶åº“ç­‰åŸºç¡€åº“ä¸­å¯èƒ½ä¼šå­˜åœ¨è¿™ç§å­ç±»ç»§ç»­æ‰©å±•å­ç±»çš„æƒ…å†µã€‚

# äº”ã€ç”»å‡ºVueç»„ä»¶ç³»ç»Ÿçš„åŸå‹é“¾

é€šè¿‡å‰é¢çš„å­¦ä¹ æˆ‘ä»¬çŸ¥é“Vueç»„ä»¶åœ¨æ¸²æŸ“çš„æ—¶å€™ä¼šç”Ÿæˆå¯¹åº”çš„ç»„ä»¶å®ä¾‹ vmã€‚

è€Œè¿™ä¸ªå®ä¾‹å¯¹åº”çš„æ„é€ å‡½æ•°æ˜¯ VueComponentã€‚