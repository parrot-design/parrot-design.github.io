---
title: ğŸ”¥Vue2æ¨¡ç‰ˆç¼–è¯‘
permalink: posts/vue2-template-compiler.html
date: 2024-12-16 13:16
topic: vue2
banner: /assets/topic/vue2/banner/diff.jpg
---  

&nbsp;

{% button è¿”å› javascript:window.history.back() icon:solar:back-white color:orange size:xs %}

{% quot ä¸“æ ç¬¬åäºŒç¯‡-æ¨¡ç‰ˆç¼–è¯‘ %}

# ä¸€ã€æ¨¡ç‰ˆç¼–è¯‘

é€šå¸¸æˆ‘ä»¬ä½¿ç”¨SPAï¼ˆSinglePage Web Applicationï¼‰çš„æ–¹å¼æ¥ç¼–å†™Vueåº”ç”¨ï¼ˆå³ä½¿ç”¨{% u .vue %}æ–‡ä»¶çš„æ–¹å¼æ¥å¼€å‘ï¼‰ã€‚

æ˜¾ç„¶æµè§ˆå™¨ä¸è®¤è¯†åç¼€ä¸º{% u .vue %}çš„æ–‡ä»¶ã€‚

æ‰€ä»¥ä¸ºäº†è®©æµè§ˆå™¨èƒ½å¤Ÿè¯†åˆ«vueæ–‡ä»¶ï¼Œä¸€èˆ¬åœ¨Vueé¡¹ç›®ä¸­ï¼Œvue-loader + webpackåœ¨é¢„ç¼–è¯‘é˜¶æ®µä¼šå°†.vueæ–‡ä»¶ä¸­çš„æ¨¡ç‰ˆéƒ¨åˆ†è§£ææˆä¸€ä¸ªrenderå‡½æ•°ã€‚

ç„¶ååœ¨æ¸²æŸ“æ—¶å°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„renderå‡½æ•°æ¥ç”Ÿæˆå¯¹åº”çš„vnodeã€‚

æ‹¿åˆ° vnodeä»¥åï¼Œå°±å¯ä»¥å°† vnodeè½¬åŒ–æˆçœŸå® DOM å…ƒç´ ç„¶åæ¸²æŸ“åˆ°é¡µé¢ä¸Šã€‚

{% image /assets/topic/vue2/template-compiler/1.jpg %}

# äºŒã€æ¨¡ç‰ˆç¼–è¯‘è½¬åŒ–æ­¥éª¤

> ç”±äºå¯¹.vueæ–‡ä»¶çš„ç¼–è¯‘æ¶‰åŠåˆ°webpackç­‰ç›¸å…³çš„ç†è®ºçŸ¥è¯†ï¼Œæ‰€ä»¥æˆ‘ä»¬åé¢çš„è§£æéƒ½æ˜¯åŸºäºtemplateæ¨¡ç‰ˆè¿›è¡Œåˆ†æçš„ã€‚
>
> ä¸è¿‡templateè§£æå’Œ.vueè§£æç”¨çš„æ ¸å¿ƒåº“ä»¥åŠé€»è¾‘éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¸å»åœ¨æ„ã€‚

åœ¨Vueä¸­ï¼Œæ¨¡æ¿è§£æå¤§è‡´åˆ†ä¸º3æ­¥ï¼š

1. {% u å°†æ¨¡æ¿è½¬åŒ–ä¸ºASTæ ‘ %}
2. {% u å¯¹ASTæ ‘è¿›è¡Œä¼˜åŒ– %}
3. {% u å°†ASTæ ‘è½¬åŒ–ä¸ºrenderå‡½æ•° %} 

{% box child:codeblock color:purple %}
```js 
// ç¬¬ä¸€æ­¥ï¼šè½¬åŒ–æ¨¡æ¿å­—ç¬¦ä¸²ä¸ºastæ ‘
const ast = parse(template.trim(), options)
// ç¬¬äºŒæ­¥ï¼šä¼˜åŒ–astæ ‘
optimize(ast, options)
// ç¬¬ä¸‰æ­¥ï¼šæ ¹æ®astæ ‘ç”Ÿæˆå¯¹åº”çš„renderå‡½æ•°å­—ç¬¦ä¸²
const code = generate(ast, options)
```
{% endbox %} 
  
## 2.1 ç¬¬ä¸€æ­¥ï¼šå°†templateæ¨¡æ¿è½¬åŒ–æˆASTæ ‘

å› ä¸ºæ¨¡æ¿å°±æ˜¯ä¸€æ®µå­—ç¬¦ä¸²ï¼Œæ˜¯éç»“æ„åŒ–çš„æ•°æ®ï¼Œä¸åˆ©äºè¿›è¡Œåˆ†æã€‚

æ‰€ä»¥ç¬¬ä¸€æ­¥æ˜¯å°†éç»“æ„åŒ–çš„æ¨¡æ¿å­—ç¬¦ä¸²ï¼Œæ¢å˜æˆç»“æ„åŒ–çš„ JSå¯¹è±¡æŠ½è±¡è¯­æ³•æ ‘ï¼Œå³ ASTã€‚

è¿™ä¸ªç½‘ç«™[https://astexplorer.net/](https://astexplorer.net/)å¯ä»¥å°†æ¨¡æ¿è½¬æˆæˆå¯¹åº”çš„ ASTã€‚

> æ³¨æ„è§£æå†…å®¹é€‰æ‹© Vueï¼Œè§£æå™¨é€‰æ‹© {% u vue-template-compiler %}ã€‚

{% image /assets/topic/vue2/template-compiler/2.png %}

## 2.2 ç¬¬äºŒæ­¥ï¼šå¯¹ASTæ ‘è¿›è¡Œä¼˜åŒ–

ç¬¬ä¸€æ­¥ä»…ä»…è´Ÿè´£å°†å­—ç¬¦ä¸²æ¨¡ç‰ˆè½¬åŒ–æˆASTæ ‘ã€‚

è€Œç¬¬äºŒæ­¥çš„ä¸»è¦ä½œç”¨æ˜¯å¯¹ASTæ ‘è¿›è¡Œä¼˜åŒ–ï¼Œä»¥æå‡è¿è¡Œæ—¶çš„æ¸²æŸ“æ€§èƒ½ã€‚

ä¼˜åŒ–é€»è¾‘å¯ä»¥æ ‡è®°é‚£äº›åœ¨ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå†…ä¸ä¼šå˜åŒ–çš„èŠ‚ç‚¹ä¸ºé™æ€èŠ‚ç‚¹ã€‚

è¿™äº›èŠ‚ç‚¹åœ¨åç»­çš„æ¸²æŸ“è¿‡ç¨‹ä¸­ä¸éœ€è¦è¿›è¡Œè™šæ‹ŸDOMçš„diffå¯¹æ¯”ï¼Œä»è€Œå‡å°‘äº†ä¸å¿…è¦çš„è®¡ç®—å’ŒDOMæ“ä½œ

## 2.3 ç¬¬ä¸‰æ­¥ï¼šå°†ASTæ ‘è½¬åŒ–ä¸º render å‡½æ•°

åœ¨å¾—åˆ° æ¨¡æ¿ å¯¹åº”çš„ AST å¯¹è±¡ä»¥åã€‚

å…ˆè½¬æ¢ä¸ºä¸€æ®µå¯ä»¥åˆ›å»ºå…ƒç´ çš„å­—ç¬¦ä¸²ï¼Œç„¶åå†ç”¨ new Function(`with(this){return åˆ›å»ºå…ƒç´ çš„å­—ç¬¦ä¸²}`)ç”Ÿæˆå¯¹åº”çš„ renderå‡½æ•°ã€‚

## 2.4 æ€»ç»“

{% box child:codeblock color:purple %}
```vue 
<template>
    <div>Hello World</div>
</template>
```
{% endbox %}

ä¸Šé¢çš„æ¨¡æ¿æœ€ç»ˆä¼šå˜æˆä¸‹é¢çš„renderå‡½æ•°ã€‚

{% box child:codeblock color:purple %}
```js 
render:new Function(`with(this){return _c('div',[
    _v("Hello World") 
])}`) 
```
{% endbox %}

> _cå°±æ˜¯æˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç« æåˆ°çš„ createElement å‡½æ•° ã€‚æ‰§è¡ŒcreateElementå‡½æ•°å¯ä»¥æ–¹ä¾¿æˆ‘ä»¬ç”Ÿæˆ vnodeã€‚

> _vå°±æ˜¯æˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç« æåˆ°çš„åˆ›å»ºæ–‡æœ¬çš„å‡½æ•°ï¼š{% u createTextVNode %}ã€‚

{% u new Function() %} å¯ä»¥æ ¹æ®å‚æ•°å†…å®¹ç”Ÿæˆä¸€ä¸ªå‡½æ•°ã€‚

è€Œ {% u with(this) %}è¯­å¥æ„å‘³ç€å‡½æ•°ä½“å†…çš„æ‰€æœ‰å˜é‡éƒ½å°†ä» thiså¯¹è±¡ä¸­æŸ¥æ‰¾ï¼Œæ¯”å¦‚ä¸Šé¢çš„{% u _vã€_c %}ã€‚
  
æ‰€ä»¥æ‰§è¡Œç”Ÿæˆçš„ render å‡½æ•°å°±å¯ä»¥è·å–æ¨¡æ¿å¯¹åº”çš„ vnodeã€‚

{% image /assets/topic/vue2/template-compiler/3.jpg %}

# ä¸‰ã€Vueä¸­ASTçš„å±æ€§

åœ¨Vueæ¨¡ç‰ˆç¼–è¯‘ä¸­ï¼ŒASTæ ‘ä½¿ç”¨JSå¯¹è±¡æ¥æè¿°ä¸€ä¸ªASTç»“æ„ã€‚

{% image /assets/topic/vue2/template-compiler/4.png %}

ASTå¯¹è±¡ä¸Šçš„æ¯ä¸ªå±æ€§éƒ½æœ‰ç€å¯¹åº”çš„æ„ä¹‰ã€‚

è¿™èŠ‚æˆ‘ä»¬å°±æ¥è¯¦ç»†è¯´ä¸‹æ¯ä¸ªå±æ€§æ‰€ä»£è¡¨çš„å«ä¹‰ã€‚

## 3.1 type

typeå¯ä»¥è¡¨ç¤ºASTèŠ‚ç‚¹çš„ç±»å‹ã€‚

### 3.1.1 typeç­‰äº1

> typeä¸º1ä»£è¡¨å½“å‰èŠ‚ç‚¹å±äºæ™®é€šèŠ‚ç‚¹ç±»å‹ï¼ˆdivç­‰ï¼‰ã€‚å¦‚ä¸‹ï¼š

{% box child:codeblock color:purple %}
```html  
// æ¨¡æ¿
<div></div> 
```
```js
// AST
{
    type: 1,
    tag: "div"
}
```
{% endbox %}

### 3.1.2 typeç­‰äº2

> typeä¸º2ä»£è¡¨å½“å‰èŠ‚ç‚¹æ˜¯åŒ…å«å­—é¢é‡è¡¨è¾¾å¼çš„æ–‡æœ¬èŠ‚ç‚¹ï¼ˆæ’å€¼è¡¨è¾¾å¼ï¼‰ã€‚å¦‚ä¸‹ï¼š

{% box child:codeblock color:purple %}
```html  
// æ¨¡æ¿
<div>{{ item }}</div>
```
```js
// AST
{
    type: 1,
    tag: "div",
    children:[
        {
            type: 2,
            expression: "_s(item)",
            text:"{{ item }}",
            tokens:[
                { @binding:"item" } 
            ]
        }
    ]
}
```
{% endbox %}

### 3.1.3 typeç­‰äº3

> typeä¸º3ä»£è¡¨å½“å‰èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹ã€‚å¦‚ä¸‹ï¼š

{% box child:codeblock color:purple %}
```html  
// æ¨¡æ¿
<div>Hello World</div> 
```
```js
// AST
{
    type: 1,
    tag: "div",
    children: [
        {
            type:3,
            text:"Hello World"
        }
    ]
}
```
{% endbox %}

## 3.2 tag

tagå±æ€§è¡¨ç¤ºå½“å‰èŠ‚ç‚¹çš„æ ‡ç­¾åç§°ï¼Œåªæœ‰å½“èŠ‚ç‚¹ç±»å‹ä¸º1æ—¶ï¼Œå³æ”¹èŠ‚ç‚¹ä¸ºæ ‡ç­¾æ—¶ï¼Œæ‰ä¼šæœ‰tagå±æ€§ã€‚

### 3.2.1 æ™®é€šèŠ‚ç‚¹æ ‡ç­¾

{% box child:codeblock color:purple %}
```html  
// æ¨¡æ¿
<div></div> 
```
```js
// AST
{
    type: 1,
    tag: "div"
}
```
{% endbox %}

### 3.2.2 templateæ ‡ç­¾

{% box child:codeblock color:purple %}
```html  
// æ¨¡æ¿
<template></template> 
```
```js
// AST
{
    type: 1,
    tag: "template"
}
```
{% endbox %}

### 3.2.3 ç»„ä»¶æ ‡ç­¾

{% box child:codeblock color:purple %}
```html  
// æ¨¡æ¿
<ComponentA></ComponentA> 
```
```js
// AST
{
    type: 1,
    tag: "ComponentA"
}
```
{% endbox %}

## 3.3 attrsList

è¯¥å±æ€§æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå®ƒå­˜å‚¨äº†å…ƒç´ èŠ‚ç‚¹çš„æ‰€æœ‰å±æ€§ï¼ŒåŒ…æ‹¬å±æ€§åå’Œå±æ€§å€¼ã€‚

è¿™ä¸ªå±æ€§åªåœ¨èŠ‚ç‚¹ç±»å‹ä¸º 1 æ—¶å­˜åœ¨ï¼Œå³å½“èŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªæ ‡ç­¾æ—¶ã€‚

attrsList ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å« name å’Œ value ä¸¤ä¸ªå±æ€§ï¼Œåˆ†åˆ«è¡¨ç¤ºå±æ€§çš„åç§°å’Œå€¼ã€‚

> éœ€è¦æ³¨æ„çš„æ˜¯è¯¥å±æ€§ä¸åŒ…å«{% u style %}ä»¥åŠ{% u class %}å±æ€§ã€‚

{% box child:codeblock color:purple %}
```html  
// æ¨¡æ¿
<div id="app" name="hello" class="container" style="color:red;"></div> 
```
```js
// AST
{
    type: 1,
    tag: "div",
    // ä¸åŒ…å«styleå’Œclass
    attrsList:[
        { name:'id', value:'app'},
        { name:'name', value:'hello'},
    ],
    staticClass:"\"container\"",
    staticStyle:"{\"color\":\"red\"}"
}
```
{% endbox %}

## 3.4 startã€end

startå’Œendå±æ€§è¡¨ç¤ºä¸€ä¸ªèŠ‚ç‚¹åœ¨åŸå§‹æ¨¡æ¿å­—ç¬¦ä¸²ä¸­çš„èµ·å§‹å’Œç»“æŸä½ç½®åæ ‡ï¼Œå­˜åœ¨äºæ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚

çŸ¥é“è¿™äº›åæ ‡å¯ä»¥ç”¨äºé”™è¯¯å®šä½ã€ä»£ç é«˜äº®ã€æºç æ˜ å°„ã€è°ƒè¯•ä¿¡æ¯ç­‰ç­‰ã€‚

{% box child:codeblock color:purple %}
```html  
// æ¨¡æ¿
<div id="app"></div> 
```
```js
// AST
{
    type: 1,
    tag: "div",
    // ä¸åŒ…å«styleå’Œclass
    attrsList:[
        { name:'id', value:'app', start:5, end:13 }
    ],
    start:0,
    end:20
}
```
{% endbox %}

## 3.5 attrsMap

è¯¥å±æ€§æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨äº†å…ƒç´ èŠ‚ç‚¹çš„æ‰€æœ‰å±æ€§åå’Œå€¼ã€‚

è¿™ä¸ªå±æ€§ä¸ attrsList å±æ€§ç›¸ä¼¼ï¼Œä½† attrsList æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè€Œ attrsMap æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚

{% box child:codeblock color:purple %}
```html  
// æ¨¡æ¿
<div id="app" name="hello" class="container" style="color:red;"></div> 
```
```js
// AST
{
    type: 1,
    tag: "div",
    // ä¸åŒ…å«styleå’Œclass
    attrsMap:{
        id:'app',
        name:'hello',
        class:'container',
        style:'color:red;'
    }
}
```
{% endbox %}