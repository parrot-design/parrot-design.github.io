---
title: ğŸ”¥Vue2æºç æ„å»º
permalink: posts/vue2-core-build.html
date: 2024-11-11 14:54
topic: vue2
banner: /assets/topic/vue2/banner/build.png
references:
---
{% quot ä¸“æ ç¬¬äºŒç¯‡-æºç æ„å»º %}ã€‚

&emsp;&emsp;åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å¤§æ¦‚äº†è§£äº†Vueçš„ç›®å½•ç»“æ„æ˜¯æ€ä¹ˆæ ·çš„ã€‚

&emsp;&emsp;åœ¨è¿™ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¼šçŸ¥æ™“ Vue æ˜¯å¦‚ä½•æ„å»ºçš„ã€‚


# ä¸€ã€Vueçš„æ„å»º

## 1.1 æ ¹æ®ä½¿ç”¨åœºæ™¯æ‰“åŒ…

åœ¨ä¸Šä¸€ç¯‡ä¸“æ æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰äº† Vueæºç ä¸­çš„ä»£ç ç»“æ„ã€‚

å…¶ä¸­æˆ‘ä»¬ä»‹ç»äº†å‡ ä¸ªå…¥å£æ–‡ä»¶ï¼š

1. `entry-runtime.ts`
2. `entry-runtime-with-compiler.ts`
3. `entry-runtime-esm.ts`
4. `entry-runtime-with-compiler-esm.ts`

åœ¨æˆ‘ä»¬å¼€å‘é¡¹ç›®ç»“æŸåï¼Œéœ€è¦è¿›è¡Œæ‰“åŒ…å¹¶éƒ¨ç½²åˆ°çº¿ä¸Šã€‚

é€šå¸¸æˆ‘ä»¬é¡¹ç›®æ‰“åŒ…æ—¶éœ€è¦ä¸€ä¸ªå…¥å£æ–‡ä»¶ï¼Œ webpacké€šè¿‡è¿™ä¸ªå…¥å£æ–‡ä»¶é€’å½’æ–‡ä»¶è¿›è¡Œä¾èµ–åˆ†æç„¶åæ‰“åŒ…ã€‚

å…¶å®æ¡†æ¶æ‰“åŒ…ä¹Ÿä¸€æ ·ï¼ŒåŒæ ·éœ€è¦ä¸€ä¸ªå…¥å£æ–‡ä»¶è¿›è¡Œé€’å½’ä¾èµ–åˆ†ææ‰“åŒ…ç”Ÿæˆ jsæ–‡ä»¶æ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œä½¿ç”¨ã€‚ 

å’Œé¡¹ç›®ä¸ä¸€æ ·çš„æ˜¯ï¼Œé¡¹ç›®å¾€å¾€åªæœ‰ä¸€ä¸ªå…¥å£æ–‡ä»¶ï¼Œè€Œæ¡†æ¶ä¼šæ ¹æ®ä¸åŒçš„æƒ…å†µé‡‡ç”¨ä¸åŒçš„å…¥å£æ–‡ä»¶è¿›è¡Œæ‰“åŒ…ï¼Œä¸Šé¢çš„è¿™å››ä¸ªæ–‡ä»¶å°±æ˜¯Vueæ¡†æ¶çš„å…¥å£æ–‡ä»¶ã€‚

{% box child:codeblock color:cyan %}
> Vueæ˜¯ä½¿ç”¨rollupè¿›è¡Œæ‰“åŒ…çš„ã€‚
{% endbox %}

ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·è¿›è¡Œä½¿ç”¨ï¼ŒVueåœ¨ä½¿ç”¨rollupè¿›è¡Œæ‰“åŒ…æ—¶æ ¹æ®{% mark å¼€å‘ç¯å¢ƒ color:orange %}`å’Œ{% mark å¼€å‘æ¨¡å¼ color:orange %}æ‰“åŒ…å‡ºäº†ä¸åŒåŠŸèƒ½çš„æ–‡ä»¶ï¼Œä»¥é€‚ç”¨äºä¸åŒçš„ä½¿ç”¨åœºæ™¯ã€‚

æ„å»ºçš„rollupæ‰“åŒ…è„šæœ¬çš„ä»£ç åœ¨`scripts/config.js`æ–‡ä»¶ä¸­ã€‚

{% box child:codeblock color:purple %}
```js
const builds = {
    'runtime-cjs-dev': {
        entry: resolve('web/entry-runtime.ts'),
        dest: resolve('dist/vue.runtime.common.dev.js'),
        format: 'cjs',
        env: 'development',
        banner
    },
    'runtime-cjs-prod': {
        entry: resolve('web/entry-runtime.ts'),
        dest: resolve('dist/vue.runtime.common.prod.js'),
        format: 'cjs',
        env: 'production',
        banner
    },
    // çœç•¥
}
``` 
{% endbox %}

{% image /assets/topic/vue2/banner/build.png %}

æ€»å…±æ‰“åŒ…ç”Ÿæˆ 12 ä¸ªæ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶å¯ä»¥é€‚ç”¨äºä¸åŒçš„åœºæ™¯ã€‚

1. æ ¹æ®æ˜¯å¦å¸¦ç¼–è¯‘å™¨çš„è§’åº¦ä¸Šåˆ†ä¸ºFullå’ŒRuntime-Only 2ä¸ªç‰ˆæœ¬ã€‚Fullç‰ˆæœ¬åŒ…å«ç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶çš„å…¨éƒ¨åŠŸèƒ½ã€‚Runtime-Only ä»…å«è¿è¡Œæ—¶åŠŸèƒ½ã€‚
2. æ‰“åŒ…çš„æ–‡ä»¶æ ¹æ®ä½¿ç”¨åœºæ™¯åˆ†ä¸º esmã€cjsã€umdä¸‰ä¸ªç‰ˆæœ¬ã€‚å…¶ä¸­umdå¯ä»¥é€šè¿‡`<script>`æ ‡ç­¾å¼•å…¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨ï¼ŒVueä¼šæš´éœ²ä¸€ä¸ªå…¨å±€å˜é‡ Windows.Vueã€‚è€Œ CommonJSé€‚é…const Vue = require('vue')è¿™ç§ nodeå¼çš„æ¨¡å—ç³»ç»Ÿã€‚ESåˆ™é€‚é…import Vue from 'vue'è¿™ç§es6æ ¼å¼ã€‚ 
3. æ‰“åŒ…çš„æ–‡ä»¶æ ¹æ®ç¯å¢ƒåˆ†ä¸º dev/prodï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸­å¯ä»¥ä½¿ç”¨ devç‰ˆæœ¬çš„ jsæ–‡ä»¶ï¼Œè€Œéƒ¨ç½²åˆ°å®¢æˆ·ç”Ÿäº§ç¯å¢ƒå°±å¯ä»¥ä½¿ç”¨ prodç‰ˆæœ¬çš„ jsæ–‡ä»¶ã€‚ devç‰ˆæœ¬çš„æ–‡ä»¶æœ‰ä¸€äº›æç¤ºï¼Œä¼šåœ¨å¼€å‘è€…å¼€å‘æ—¶ä¾¿äºè°ƒè¯•ã€‚

## 1.2  Fullç‰ˆæœ¬çš„Vueåˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

{% image /assets/topic/vue2/build/2.png %}

å¹³æ—¶æˆ‘ä»¬å¼€å‘ä¸­åªä½¿ç”¨äº† runtime-only ç‰ˆæœ¬ã€‚

è€Œ Fullç‰ˆæœ¬ä¸­ä¸ä»…æœ‰ runtime-onlyéƒ¨åˆ†ï¼Œè¿˜åŒ…æ‹¬ç¼–è¯‘å™¨éƒ¨åˆ†ã€‚

æ‰€è°“ç¼–è¯‘å™¨ï¼Œå°±æ˜¯åœ¨Vueå†…éƒ¨çš„ç¼–è¯‘å™¨å¯ä»¥å°†æ¨¡æ¿è½¬åŒ–ä¸ºå¯¹åº”çš„renderå‡½æ•°ã€‚

{% box child:codeblock color:cyan %}
> åœ¨Vueå†…éƒ¨æ¸²æŸ“å°±æ˜¯è°ƒç”¨çš„ renderæ–¹æ³•ç”Ÿæˆ vnodeã€‚
{% endbox %}

å› ä¸ºç¼–è¯‘å™¨ä»£ç ä½“ç§¯æ¯”è¾ƒå¤§ï¼Œè€Œä¸”å¦‚æœåœ¨è¿è¡Œçš„æ—¶å€™è¿›è¡Œæ¨¡æ¿ç¼–è¯‘ï¼Œæå¤§å¯èƒ½ä¼šæ¶ˆè€—æ€§èƒ½ã€‚

æ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬åœ¨å¼€å‘é¡¹ç›®æ—¶ï¼Œä½¿ç”¨ runtime-onlyç‰ˆæœ¬ã€‚

åœ¨ webpacké¢„ç¼–è¯‘é˜¶æ®µï¼Œå°±å°†.vueæ–‡ä»¶ç¼–è¯‘æˆrenderå‡½æ•°ï¼Œåœ¨è¿è¡Œæ—¶ç›´æ¥è¿è¡Œ renderå‡½æ•°å°±å¯ä»¥è·å–åˆ°å¯¹åº”çš„ vnodeã€‚

{% box child:codeblock color:cyan %}
> é€šè¿‡ runtime-only å’Œ esmå¾ˆå®¹æ˜“æ¨æµ‹å‡ºæ¥æˆ‘ä»¬é¡¹ç›®åœ¨å¼€å‘é˜¶æ®µä¸­ä½¿ç”¨çš„æ˜¯`vue.runtime.esm.js`
{% endbox %}

## 1.3 ä½¿ç”¨ Full è¿˜æ˜¯ç”¨ Runtime-Onlyç‰ˆæœ¬

è¿™éœ€è¦ä¾æ®å…·ä½“æƒ…å†µè¿›è¡Œå…·ä½“åˆ†æã€‚

å€˜è‹¥ä½ éœ€è¦ç”¨åˆ° Vue æ‰€æä¾›çš„ html æ¨¡æ¿åŠŸèƒ½ï¼Œé‚£å°±é€‰ç”¨ Full ç‰ˆæœ¬ã€‚

åä¹‹ï¼Œæœ€å¥½é‡‡ç”¨ Runtime-only ç‰ˆæœ¬ï¼ŒåŸå› åœ¨äºå®ƒæ¯” Full ç‰ˆæœ¬çš„æ–‡ä»¶ä½“ç§¯å¤§çº¦å° 30%ã€‚

{% box child:codeblock color:cyan %}
> *.vue å•æ–‡ä»¶ç»„ä»¶ä¼šè¢« vue-loader ç›´æ¥æ„å»ºæˆä¸º JavaScriptï¼Œå¹¶æœªä½¿ç”¨åˆ° Vue çš„ç¼–è¯‘å™¨ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ Runtime-only ç‰ˆæœ¬ã€‚
{% endbox %}

# äºŒã€ç¥å¥‡çš„â€œ__DEV__â€ 

åœ¨å‰é¢æˆ‘ä»¬è¯´åˆ°ï¼Œåœ¨æ‰“åŒ…æˆå¼€å‘ç¯å¢ƒçš„åŒ…æ—¶ï¼Œå¾€å¾€ä¼šå­˜åœ¨å¾ˆå¤šæç¤ºä¿¡æ¯ã€‚

è€Œæºç ä¸­åˆ¤æ–­å¼€å‘ç¯å¢ƒé€šå¸¸éƒ½æ˜¯ä½¿ç”¨`__DEV__`æ¥è¿›è¡Œåˆ¤æ–­ã€‚

## 2.1 __DEV__çš„æœ¬è´¨

åœ¨Vueæºç ä¸­ï¼Œåˆ°å¤„éƒ½èƒ½çœ‹åˆ°`__DEV__`å˜é‡çš„èº«å½±ã€‚

ä½†æ˜¯ä½ çœ‹ä¸åˆ°`__DEV__`è¢« `import` å¼•å…¥ï¼Œç”šè‡³ä½ éƒ½æ‰¾ä¸åˆ°åœ¨å“ªé‡Œå®šä¹‰äº†è¿™ä¸ªå˜é‡ã€‚

è¿™ä¸ªå˜é‡åœ¨ Vue ä¸­ä»£è¡¨å¼€å‘ç¯å¢ƒã€‚

å½“ä½ åœ¨æºç ä¸­çœ‹è§ `if(__DEV__)` ä»£è¡¨è¿™ä¸ªifä¸­çš„é€»è¾‘åªæœ‰åœ¨å¼€å‘ç¯å¢ƒæ‰è¿›å…¥æ‰§è¡Œã€‚

vueçš„æ„å»ºå·¥å…·æ˜¯rollupï¼Œåœ¨rollupæ‰“åŒ…çš„æ—¶å€™ä¼šä½¿ç”¨`@rollup/plugin-replace` æ’ä»¶æ¥æ›¿æ¢æºä»£ç ä¸­çš„` __DEV__ `å˜é‡ï¼Œå¦‚ä¸‹ï¼š

{% box child:codeblock color:purple %}
```js
......
const replace = require('@rollup/plugin-replace')
......
// built-in vars
const vars = {
    ......
    __DEV__: `process.env.NODE_ENV !== 'production'`,
    ......
}
......
config.plugins.push(replace(vars))
...... 
``` 
{% endbox %}

æ‰€ä»¥`__DEV__`çš„æœ¬è´¨å°±æ˜¯ `proess.env.NODE_ENV!== 'production'` ã€‚


## 2.2 çº¦å®šä¿—æˆçš„â€œprocess.env.NODE\_ENV!=='productionâ€

å°† **DEV** å˜é‡è½¬æ¢ä¸º `process.env.NODE_ENV !== 'production'` è¿™æ ·çš„æ¡ä»¶è¡¨è¾¾å¼åœ¨ç°ä»£å‰ç«¯æ„å»ºå·¥å…·ä¸­æ˜¯ä¸€ç§å¸¸è§çš„çº¦å®šå’Œå®è·µã€‚

åŸå› æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š

1.  `ç¯å¢ƒåŒºåˆ†`ï¼šé€šè¿‡ `process.env.NODE_ENV` å¯ä»¥æ–¹ä¾¿åœ°åœ¨ä»£ç ä¸­åŒºåˆ†å¼€å‘ç¯å¢ƒï¼ˆdevelopmentï¼‰ä¸ç”Ÿäº§ç¯å¢ƒï¼ˆproductionï¼‰ã€‚ä¾‹å¦‚ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸­å¯ç”¨ç‰¹å®šçš„è­¦å‘Šã€æ—¥å¿—è®°å½•æˆ–è€…çƒ­åŠ è½½åŠŸèƒ½ï¼›è€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­åˆ™ç¦ç”¨è¿™äº›åŠŸèƒ½ä»¥ä¼˜åŒ–æ€§èƒ½ã€‚
2.  `Tree-shaking å’Œ UglifyJS`ï¼šå½“æ‰“åŒ…å·¥å…·å¦‚ Rollup æˆ– webpack é‡åˆ° `process.env.NODE_DEV !== 'production'` åŒ…è£¹çš„ä»£ç å—æ—¶ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ä¼šè‡ªåŠ¨å»é™¤ï¼ˆtree-shakeï¼‰å…¶ä¸­ä»…åœ¨å¼€å‘ç¯å¢ƒä¸­éœ€è¦çš„ä»£ç ï¼Œå› ä¸ºè¯¥æ¡ä»¶è¡¨è¾¾å¼æœ€ç»ˆä¼šè¢«ç¼–è¯‘å™¨æˆ–å‹ç¼©å·¥å…·è¯†åˆ«ä¸ºå§‹ç»ˆä¸º falseï¼Œå› æ­¤åŒ…è£¹çš„ä»£ç ä¸ä¼šè¢«æ‰“åŒ…è¿›æœ€ç»ˆäº§ç‰©ã€‚
3.  `æ ‡å‡†åŒ–`ï¼šè®¸å¤šæ¡†æ¶å’Œåº“éƒ½é‡‡ç”¨äº†è¿™ç§æ¨¡å¼æ¥å¤„ç†ç¯å¢ƒç›¸å…³çš„é€»è¾‘ï¼Œè¿™æ ·å¼€å‘è€…å¯ä»¥ç»Ÿä¸€éµå¾ªè¿™ä¸ªçº¦å®šï¼Œå‡å°‘é…ç½®å’Œç†è§£æˆæœ¬ã€‚
4.  `çµæ´»é…ç½®`ï¼šç”±äºæ„å»ºå·¥å…·æ”¯æŒ .env æ–‡ä»¶æˆ–å…¶ä»–æ–¹å¼æ¥è®¾ç½® NODE\_ENV çš„å€¼ï¼Œè¿™ä½¿å¾—é¡¹ç›®é…ç½®æ›´åŠ çµæ´»ï¼Œå›¢é˜Ÿæˆå‘˜å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚å¿«é€Ÿåˆ‡æ¢ä¸åŒç¯å¢ƒä¸‹çš„è¡Œä¸ºã€‚
5.  `è·¨å¹³å°å…¼å®¹æ€§`ï¼š`process.env.NODE_ENV` ä½œä¸ºä¸€ä¸ªæ ‡å‡† Node.js ç¯å¢ƒå˜é‡æ¥å£ï¼Œå·²ç»è¢«å¹¿æ³›æ¥å—ï¼Œå¹¶ä¸”åœ¨å„ç§æ‰“åŒ…å·¥å…·ä¸­éƒ½æœ‰ç›¸åº”çš„æœºåˆ¶å°†å…¶æ˜ å°„åˆ°æœ€ç»ˆæµè§ˆå™¨æ‰§è¡Œçš„ä»£ç ä¸­ï¼Œç¡®ä¿äº†è·¨å¹³å°çš„ä¸€è‡´æ€§ã€‚

{% box child:codeblock color:cyan %}
> ä¸€èˆ¬é¡¹ç›®åœ¨å¼€å‘ç¯å¢ƒä¸­å°†process.env.NODE\_ENVè®¾ç½®ä¸º`development`ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­è®¾ç½®ä¸º`production`ã€‚
>
> æ‰€ä»¥é€šè¿‡`process.env.NODE_ENV !== 'production`å°±å¯ä»¥åˆ¤æ–­ç°åœ¨æ˜¯å¤„äºä»€ä¹ˆç¯å¢ƒä¸‹ã€‚
{% endbox %}

## 2.3 åœ¨æœ¬åœ°ç¯å¢ƒé…ç½®\_\_DEV\_\_

å› ä¸ºæˆ‘ä»¬è¿™é—¨è¯¾ç¨‹æ˜¯å†™ä¸€ä¸ªå®Œæ•´ç‰ˆçš„vue2ã€‚

æ‰€ä»¥æˆ‘ä»¬ä¹Ÿä¼šä½¿ç”¨\_\_DEV\_\_è¿™ä¸ªå˜é‡ä»£è¡¨å¼€å‘ç¯å¢ƒã€‚

æˆ‘ä»¬æœ¬åœ°çš„é¡¹ç›®æ˜¯ä½¿ç”¨ vue-cli æ­å»ºçš„ã€‚

å¯ä»¥åœ¨ webpacké…ç½®æ–‡ä»¶ vue.config.js æ–‡ä»¶æ–°å¢ä¸€ä¸ªé…ç½®è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚

{% box child:codeblock color:purple %}
```js
// vue.config.js
const { defineConfig } = require('@vue/cli-service');
const webpack = require('webpack');
module.exports = defineConfig({
  transpileDependencies: true,
  lintOnSave:false,
  configureWebpack: {
    plugins: [
      new webpack.DefinePlugin({
        __DEV__: process.env.NODE_ENV === 'development',
      }),
    ],
  },
})
```
{% endbox %}

{% box child:codeblock color:cyan %}
> DefinePlugin æ’ä»¶çš„ä¸»è¦ä½œç”¨æ˜¯åœ¨ç¼–è¯‘æ—¶å°†é¢„å®šä¹‰çš„å€¼æ›¿æ¢åˆ°æºä»£ç ä¸­çš„ç‰¹å®šå˜é‡ã€‚
{% endbox %}

æˆ‘ä»¬æ‰§è¡Œ`yarn start`å¯åŠ¨è¿™ä¸ªé¡¹ç›®æ‰“å°ä¸€ä¸‹\_\_DEV\_\_ä¸º trueå³ä¸ºæˆåŠŸã€‚

{% box child:codeblock color:purple %}
```js
console.log(__DEV__); // true
```
{% endbox %}











